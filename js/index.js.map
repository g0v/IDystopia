{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/js/remote_key_map.js","webpack:///./src/js/data_store.js","webpack:///./node_modules/store2/dist/store2.js","webpack:///./src/js/story_line.js","webpack:///./src/js/hero.js","webpack:///./src/js/index.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","KEY_MAP","REV_KEY_MAP","_hasOwnProperty","obj","_","callbacks","fn","this","set","callback","undefined","push","_DATASTORE_API_URL","_REMOTE_STORE_CACHE","namespace","AnswerStore","RemoteStore","_tokenChecked","response","fetch","method","data","json","token","expireTime","Date","getTime","has","_register","ok","_ensureToken","console","log","url","_inc","_getc","result","localKey","count","getCount","window","define","store","version","areas","apis","inherit","api","getOwnPropertyDescriptor","stringify","JSON","parse","revive","e","storeAPI","area","getItem","string","setItem","remove","removeItem","length","clear","Store","id","overwrite","arguments","getAll","transact","each","setAll","_id","_area","storage","_ns","singleArea","substring","isFake","toString","_in","size","keys","fill","_out","fillList","k","v","list","alt","fillObj","all","val","ret","changed","add","Array","concat","type","clearAll","indexOf","storageAPI","items","localStorage","local","sessionStorage","amd","conflict","title","description","depend","firstStep","steps","missionStep","idx","expectedValue","missionId","dict","filter","String","warn","mission","stepId","step","MissionStep","fromDict","addStep","nextStep","npcId","dialog","moveTo","Dialog","dialogItems","dialogIdMap","dialogItem","DialogItem","addDialogItem","currentIndex","item","answer","nextIndex","nextLine","DialogItemSelect","choices","DialogItemPrompt","storeKey","setAndNotify","increase","info","getCurrentDialogItem","DialogItemLine","DialogItemMessage","line","super","question","text","message","async","loadStoryLine","fileName","missions","loadedMissions","missionDict","loadStoryLineFromObject","Char","phaser","x","y","texture","frame","Number","isNaN","_name","facing","missionMark","makeContainer","player","physics","sprite","setSize","setOffset","font","align","setOrigin","setStroke","setDepth","newName","setText","enable","destroy","setX","setY","CharDaemon","chars","error","char","time","delta","update","storyLine","dialogDaemon","missionWithDependencies","listen","isReady","_addToDialogDaemon","_RE_PLAYER","charDaemon","dialogs","hasOnGoingDialog","dialogToTrigger","bootbox","alert","dialogId","iterator","doneDialog","me","getChar","talker","replace","content","nextDialogItem","showDialog","inputOptions","prompt","inputType","onEscape","backdrop","recordKey","recordDone","nextStepKey","where","tuple","getDialog","getIterator","shift","npc","Math","hypot","showMissionMark","config","Phaser","AUTO","width","height","parent","pixelArt","default","arcade","gravity","scene","preload","load","setPath","image","tilemapTiledJSON","atlas","map","make","tilemap","tileset","addTilesetImage","worldLayer","createStaticLayer","aboveLayer","setCollisionByProperty","collides","spawnPoint","findObject","NPCs","group","setImmovable","collider","then","storyLineDaemon","init","anims","frames","generateFrameNames","prefix","start","end","zeroPad","frameRate","repeat","backgroundColor","padding","setScrollFactor","setInteractive","on","showHint","camera","cameras","main","startFollow","setBounds","widthInPixels","heightInPixels","cursors","input","keyboard","createCursorKeys","addKey","Input","Keyboard","KeyCodes","ENTER","event","findNearbyDialog","startDialog","once","world","createDebugGraphic","graphics","setAlpha","renderDebug","tileColor","collidingTileColor","Display","Color","faceColor","checkDialogToTrigger","prevVelocity","body","velocity","clone","setVelocity","left","isDown","setVelocityX","right","up","setVelocityY","down","normalize","scale","play","stop","setTexture","Game"],"mappings":"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","file":"js/index.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 3);\n","// Generated by gen_remote_key_map.py\n\nexport const KEY_MAP = {\"0000000001\":\"MISSION/intro/step-1/done\",\"0000000002\":\"MISSION/receive-package/step-1/done\",\"0000000003\":\"RESPONSE/player_occupation/學生\",\"0000000004\":\"RESPONSE/player_occupation/工程師\",\"0000000005\":\"RESPONSE/player_occupation/律師\",\"0000000006\":\"RESPONSE/player_occupation/健身教練\",\"0000000007\":\"RESPONSE/player_occupation/中年職業婦女\",\"0000000008\":\"RESPONSE/player_occupation/記者\",\"0000000009\":\"MISSION/receive-package/step-2/done\",\"0000000010\":\"MISSION/student-scene-intro/step-1/done\",\"0000000011\":\"MISSION/student-scene-intro/step-2/done\",\"0000000012\":\"MISSION/student-scene-intro/step-3/done\",\"0000000013\":\"RESPONSE/student-intro-choice/passive\",\"0000000014\":\"RESPONSE/student-intro-choice/proactive\",\"0000000015\":\"MISSION/student-scene-academic-affairs-office/step-1/done\",\"0000000016\":\"RESPONSE/student_asked_followup_question/false\",\"0000000017\":\"RESPONSE/student_asked_followup_question/true\",\"0000000018\":\"MISSION/student-scene-department-office/step-1/done\",\"0000000019\":\"MISSION/student-scene-home-2/step-1/done\",\"0000000020\":\"MISSION/student-scene-home-2/step-2/done\",\"0000000021\":\"MISSION/student-scene-home-2/step-3/done\",\"0000000022\":\"RESPONSE/student-gene-interested-in/gene\",\"0000000023\":\"RESPONSE/student-gene-interested-in/system\"};\n\nexport const REV_KEY_MAP = {};\nfor (const key in KEY_MAP) {\n  REV_KEY_MAP[KEY_MAP[key]] = key;\n}\n","/*\n * Remember some key-value pairs locally and or remotely.\n *\n * 2. localStorage: use window.localStorage to store something across browser section.\n * 3. remoteStorage: use ??? to store data remotely.\n *\n * For (3), we will generate an 'datastore_token', which is saved in localStorage,\n * on remoteStorage, different datastore_token means a different identity.\n */\n\nimport StoreModule from 'store2';\nimport {KEY_MAP, REV_KEY_MAP} from './remote_key_map.js';\n\nfunction _hasOwnProperty(obj, property) {\n  return Object.prototype.hasOwnProperty.call(obj, property);\n}\n\n(function(_) {\n  const callbacks = [];\n\n  _.fn('setAndNotify', function(key, value) {\n    this.set(key, value);\n\n    if (!this.callbacks) return;\n\n    if (_hasOwnProperty(this.callbacks, key)) {\n      for (const callback of this.callbacks[key]) {\n        callback.call(this, key);\n      }\n    }\n\n    if (_hasOwnProperty(this.callbacks, '*')) {\n      for (const callback of this.callbacks['*']) {\n        callback.call(this, key);\n      }\n    }\n  });\n\n  _.fn('notify', function() {\n    for (const key in callbacks) {\n      if (_hasOwnProperty(this.callbacks, key)) {\n        for (const callback of this.callbacks[key]) {\n          callback.call(this);\n        }\n      }\n    }\n  });\n\n  _.fn('listen', function(key, callback) {\n    if (this.callbacks === undefined) {\n      this.callbacks = {};\n    }\n\n    if (this.callbacks[key] === undefined) {\n      this.callbacks[key] = [];\n    }\n\n    this.callbacks[key].push(callback);\n  });\n})(StoreModule._);\n\n\nconst _DATASTORE_API_URL = 'https://pingtung-hao-305236.middle2.me';\nconst _REMOTE_STORE_CACHE = StoreModule.namespace('REMOTE_STORE_CACHE');\n\nclass RemoteStoreClass {\n  constructor() {\n    // have we checked our token in current session?\n    this._tokenChecked = false;\n  }\n\n  get token() {\n    return _REMOTE_STORE_CACHE.get('token');\n  }\n\n  async _register() {\n    const response = await fetch(`${_DATASTORE_API_URL}/register`, {\n      method: 'POST',\n      // mode: 'no-cors',\n    });\n    const data = await response.json();\n    if (data.token) {\n      _REMOTE_STORE_CACHE.set('token', data.token);\n      // expire in one day.\n      const expireTime = (new Date()).getTime() + 86400 * 1000;\n      _REMOTE_STORE_CACHE.set('expire', expireTime);\n      this._tokenChecked = true;\n    }\n  }\n\n  /*\n   * Makes sure there is a valid token.\n   */\n  async _ensureToken() {\n    if (!_REMOTE_STORE_CACHE.has('token')) {\n      return await this._register();\n    }\n\n    const now = (new Date()).getTime();\n    if (now > _REMOTE_STORE_CACHE.get('expire', 0)) {\n      return await this._register();\n    }\n\n    // the token should not be expired yet, but let's check for sure.\n    if (!this._tokenChecked) {\n      const token = this.token;\n      const response = \n        await fetch(`${_DATASTORE_API_URL}/check_token?token=${token}`, {\n          method: 'GET',\n          // mode: 'no-cors',\n        });\n\n      const data = await response.json();\n      if (data.ok !== true)  {\n        return await this._register();\n      }\n\n      this._tokenChecked = true;\n    }\n  }\n\n  async _inc(key) {\n    await this._ensureToken();\n\n    console.log(`increasing key: ${key}`);\n    // now this.token is available.\n    const url = `${_DATASTORE_API_URL}/inc?token=${this.token}&key=${key}`;\n    const response = await fetch(url, {\n      method: 'POST',\n      // mode: 'no-cors',\n    });\n    const data = await response.json();\n    console.log(`increased key: ${key} -> ${data.value}, data: `, data);\n    return data.value;\n  }\n\n  async _getc(key) {\n    await this._ensureToken();\n\n    // now this.token is available.\n    const url = `${_DATASTORE_API_URL}/getc?token=${this.token}&key=${key}`;\n    const response = await fetch(url, {\n      method: 'GET',\n      // mode: 'no-cors',\n    });\n    const data = await response.json();\n    return data.value;\n  }\n\n  increase(key) {\n    key = REV_KEY_MAP[key];\n    return this._inc(key);\n  }\n\n  getCount(key) {\n    key = REV_KEY_MAP[key];\n    return this._getc(key);\n  }\n\n  async getAllCount() {\n    const result = {};\n    for (const key in KEY_MAP) {\n      const localKey = KEY_MAP[key];\n      const count = await this.getCount(localKey);\n      result[localKey] = count;\n    }\n    return result;\n  }\n}\n\nexport const AnswerStore = StoreModule.namespace('DIALOG_ANSWER');\nexport const RemoteStore = new RemoteStoreClass();\n// window.RemoteStore = RemoteStore;\n","/*! store2 - v2.12.0 - 2020-08-12\n* Copyright (c) 2020 Nathan Bubna; Licensed (MIT OR GPL-3.0) */\n;(function(window, define) {\n    var _ = {\n        version: \"2.12.0\",\n        areas: {},\n        apis: {},\n\n        // utilities\n        inherit: function(api, o) {\n            for (var p in api) {\n                if (!o.hasOwnProperty(p)) {\n                    Object.defineProperty(o, p, Object.getOwnPropertyDescriptor(api, p));\n                }\n            }\n            return o;\n        },\n        stringify: function(d) {\n            return d === undefined || typeof d === \"function\" ? d+'' : JSON.stringify(d);\n        },\n        parse: function(s, fn) {\n            // if it doesn't parse, return as is\n            try{ return JSON.parse(s,fn||_.revive); }catch(e){ return s; }\n        },\n\n        // extension hooks\n        fn: function(name, fn) {\n            _.storeAPI[name] = fn;\n            for (var api in _.apis) {\n                _.apis[api][name] = fn;\n            }\n        },\n        get: function(area, key){ return area.getItem(key); },\n        set: function(area, key, string){ area.setItem(key, string); },\n        remove: function(area, key){ area.removeItem(key); },\n        key: function(area, i){ return area.key(i); },\n        length: function(area){ return area.length; },\n        clear: function(area){ area.clear(); },\n\n        // core functions\n        Store: function(id, area, namespace) {\n            var store = _.inherit(_.storeAPI, function(key, data, overwrite) {\n                if (arguments.length === 0){ return store.getAll(); }\n                if (typeof data === \"function\"){ return store.transact(key, data, overwrite); }// fn=data, alt=overwrite\n                if (data !== undefined){ return store.set(key, data, overwrite); }\n                if (typeof key === \"string\" || typeof key === \"number\"){ return store.get(key); }\n                if (typeof key === \"function\"){ return store.each(key); }\n                if (!key){ return store.clear(); }\n                return store.setAll(key, data);// overwrite=data, data=key\n            });\n            store._id = id;\n            try {\n                var testKey = '__store2_test';\n                area.setItem(testKey, 'ok');\n                store._area = area;\n                area.removeItem(testKey);\n            } catch (e) {\n                store._area = _.storage('fake');\n            }\n            store._ns = namespace || '';\n            if (!_.areas[id]) {\n                _.areas[id] = store._area;\n            }\n            if (!_.apis[store._ns+store._id]) {\n                _.apis[store._ns+store._id] = store;\n            }\n            return store;\n        },\n        storeAPI: {\n            // admin functions\n            area: function(id, area) {\n                var store = this[id];\n                if (!store || !store.area) {\n                    store = _.Store(id, area, this._ns);//new area-specific api in this namespace\n                    if (!this[id]){ this[id] = store; }\n                }\n                return store;\n            },\n            namespace: function(namespace, singleArea) {\n                if (!namespace){\n                    return this._ns ? this._ns.substring(0,this._ns.length-1) : '';\n                }\n                var ns = namespace, store = this[ns];\n                if (!store || !store.namespace) {\n                    store = _.Store(this._id, this._area, this._ns+ns+'.');//new namespaced api\n                    if (!this[ns]){ this[ns] = store; }\n                    if (!singleArea) {\n                        for (var name in _.areas) {\n                            store.area(name, _.areas[name]);\n                        }\n                    }\n                }\n                return store;\n            },\n            isFake: function(){ return this._area.name === 'fake'; },\n            toString: function() {\n                return 'store'+(this._ns?'.'+this.namespace():'')+'['+this._id+']';\n            },\n\n            // storage functions\n            has: function(key) {\n                if (this._area.has) {\n                    return this._area.has(this._in(key));//extension hook\n                }\n                return !!(this._in(key) in this._area);\n            },\n            size: function(){ return this.keys().length; },\n            each: function(fn, fill) {// fill is used by keys(fillList) and getAll(fillList))\n                for (var i=0, m=_.length(this._area); i<m; i++) {\n                    var key = this._out(_.key(this._area, i));\n                    if (key !== undefined) {\n                        if (fn.call(this, key, this.get(key), fill) === false) {\n                            break;\n                        }\n                    }\n                    if (m > _.length(this._area)) { m--; i--; }// in case of removeItem\n                }\n                return fill || this;\n            },\n            keys: function(fillList) {\n                return this.each(function(k, v, list){ list.push(k); }, fillList || []);\n            },\n            get: function(key, alt) {\n                var s = _.get(this._area, this._in(key)),\n                    fn;\n                if (typeof alt === \"function\") {\n                    fn = alt;\n                    alt = null;\n                }\n                return s !== null ? _.parse(s, fn) :\n                    alt != null ? alt : s;\n            },\n            getAll: function(fillObj) {\n                return this.each(function(k, v, all){ all[k] = v; }, fillObj || {});\n            },\n            transact: function(key, fn, alt) {\n                var val = this.get(key, alt),\n                    ret = fn(val);\n                this.set(key, ret === undefined ? val : ret);\n                return this;\n            },\n            set: function(key, data, overwrite) {\n                var d = this.get(key);\n                if (d != null && overwrite === false) {\n                    return data;\n                }\n                return _.set(this._area, this._in(key), _.stringify(data), overwrite) || d;\n            },\n            setAll: function(data, overwrite) {\n                var changed, val;\n                for (var key in data) {\n                    val = data[key];\n                    if (this.set(key, val, overwrite) !== val) {\n                        changed = true;\n                    }\n                }\n                return changed;\n            },\n            add: function(key, data) {\n                var d = this.get(key);\n                if (d instanceof Array) {\n                    data = d.concat(data);\n                } else if (d !== null) {\n                    var type = typeof d;\n                    if (type === typeof data && type === 'object') {\n                        for (var k in data) {\n                            d[k] = data[k];\n                        }\n                        data = d;\n                    } else {\n                        data = d + data;\n                    }\n                }\n                _.set(this._area, this._in(key), _.stringify(data));\n                return data;\n            },\n            remove: function(key, alt) {\n                var d = this.get(key, alt);\n                _.remove(this._area, this._in(key));\n                return d;\n            },\n            clear: function() {\n                if (!this._ns) {\n                    _.clear(this._area);\n                } else {\n                    this.each(function(k){ _.remove(this._area, this._in(k)); }, 1);\n                }\n                return this;\n            },\n            clearAll: function() {\n                var area = this._area;\n                for (var id in _.areas) {\n                    if (_.areas.hasOwnProperty(id)) {\n                        this._area = _.areas[id];\n                        this.clear();\n                    }\n                }\n                this._area = area;\n                return this;\n            },\n\n            // internal use functions\n            _in: function(k) {\n                if (typeof k !== \"string\"){ k = _.stringify(k); }\n                return this._ns ? this._ns + k : k;\n            },\n            _out: function(k) {\n                return this._ns ?\n                    k && k.indexOf(this._ns) === 0 ?\n                        k.substring(this._ns.length) :\n                        undefined : // so each() knows to skip it\n                    k;\n            }\n        },// end _.storeAPI\n        storage: function(name) {\n            return _.inherit(_.storageAPI, { items: {}, name: name });\n        },\n        storageAPI: {\n            length: 0,\n            has: function(k){ return this.items.hasOwnProperty(k); },\n            key: function(i) {\n                var c = 0;\n                for (var k in this.items){\n                    if (this.has(k) && i === c++) {\n                        return k;\n                    }\n                }\n            },\n            setItem: function(k, v) {\n                if (!this.has(k)) {\n                    this.length++;\n                }\n                this.items[k] = v;\n            },\n            removeItem: function(k) {\n                if (this.has(k)) {\n                    delete this.items[k];\n                    this.length--;\n                }\n            },\n            getItem: function(k){ return this.has(k) ? this.items[k] : null; },\n            clear: function(){ for (var k in this.items){ this.removeItem(k); } }\n        }// end _.storageAPI\n    };\n\n    var store =\n        // safely set this up (throws error in IE10/32bit mode for local files)\n        _.Store(\"local\", (function(){try{ return localStorage; }catch(e){}})());\n    store.local = store;// for completeness\n    store._ = _;// for extenders and debuggers...\n    // safely setup store.session (throws exception in FF for file:/// urls)\n    store.area(\"session\", (function(){try{ return sessionStorage; }catch(e){}})());\n    store.area(\"page\", _.storage(\"page\"));\n\n    if (typeof define === 'function' && define.amd !== undefined) {\n        define('store2', [], function () {\n            return store;\n        });\n    } else if (typeof module !== 'undefined' && module.exports) {\n        module.exports = store;\n    } else {\n        // expose the primary store fn to the global object and save conflicts\n        if (window.store){ _.conflict = window.store; }\n        window.store = store;\n    }\n\n})(this, this && this.define);\n","/**\n * Design Doc: https://g0v.hackmd.io/4HiKmrEASa-YdQ2bqg4kHg\n */\n\nimport * as DataStore from './data_store.js';\n\n/**\n * <mission-id>:  # repeated\n *   title: <mission-title>\n *   description: <...>\n *   depend:\n *     - \"<mission-id>:<step-id>\"  # repeated\n *   firstStep: <step-id>\n *   steps:\n *     ...\n */\nclass Mission {\n  constructor(id, title, description, depend, firstStep) {\n    this.id = id;\n    this.title = title;\n    this.description = description;\n    this.depend = depend;\n    this.firstStep = firstStep;\n    this.steps = {};\n  }\n\n  addStep(missionStep) {\n    this.steps[missionStep.id] = missionStep;\n  }\n\n  isReady() {\n    console.log(`checking dependency of ${this.id}`);\n    if (!this.depend) return true;\n    for (const idx in this.depend) {\n      const d = this.depend[idx];\n      console.log(`condition: `, d);\n      let key;\n      let expectedValue;\n      if (typeof(d) === 'string') {\n        key = d;\n      } else if (typeof(d) === 'object') {\n        key = d['storeKey'];\n        expectedValue = d['value'];\n      }\n      if (!DataStore.AnswerStore.has(key)) return false;\n      if (!expectedValue) continue;\n      const actualValue = DataStore.AnswerStore.get(key);\n      if (actualValue !== expectedValue) return false;\n    }\n    console.log(`${this.id} is ready!`);\n    return true;\n  }\n\n  static fromDict(missionId, dict) {\n    const title = dict['title'] || 'Unnamed Mission';\n    const description = dict['description'] || 'no description';\n    const firstStep = dict['firstStep'] || 'step-1';\n    const depend = (dict['depend'] || []).filter(d => {\n      if (typeof(d) === 'string' || d instanceof String) {\n        return true;\n      }\n      if (typeof(d) === 'object') return true;\n      console.warn(`${d} is not a string nor an object`);\n      return false;\n    });\n\n    const mission = new Mission(missionId, title, description, depend, firstStep);\n\n    for (const stepId in dict['steps']) {\n      const step = MissionStep.fromDict(stepId, dict['steps'][stepId], mission);\n      mission.addStep(step);\n    }\n    return mission;\n  }\n}\n\n/**\n * <step-id>:  # repeated\n *   title: <step-title>\n *   description: <...>\n *   nextStep: <step-id>  # the default next step\n *   npcId: <npc-id>  # whom to find to trigger the dialog of this step.\n *                    # NPC can be an object (e.g. a box).\n *   dialog:\n *     - name: \"NPC name\" or $player  # who is talking\n *       line: \"hello, $player\"\n *       id: <line-id>  # optional\n *       nextLine: <line-id>  # optional: jump to another dialog if we don't\n *                             # want to fallthrough.  \"$EOD\" means \"end of\n *                             # dialog\"\n *     - name: \"NPC name\" or $player\n *       question: \"Red pill or blue pill?\"\n *       choices:\n *         - text: \"Red\"\n *           nextLine: <line-id>  # optional\n *         - text: \"Blue\"\n *           nextLine: <line-id>  # optional\n */\nclass MissionStep {\n  constructor({id, title, description, nextStep, npcId, dialog, mission, moveTo}) {\n    this.id = id;\n    this.title = title || 'Unnamed Step';\n    this.description = description || '...';\n    this.nextStep = nextStep;\n    this.npcId = npcId;\n    this.dialog = dialog;\n    this.mission = mission;\n    this.moveTo = moveTo;\n  }\n\n  static fromDict(stepId, dict, mission) {\n    //const title = dict['title'] || 'Unnamed Step';\n    //const description = dict['description'] || 'no description';\n    //const nextStep = dict['nextStep'];\n    //const npcId = dict['npcId'];\n    //if (npcId === undefined) {\n      //throw 'npcId must be defined';\n    //}\n    const d = {id: stepId, mission: mission, ...dict};\n    const missionStep = new MissionStep(d);\n\n    const dialog = Dialog.fromDict(dict['dialog'] || [], missionStep);\n    missionStep.dialog = dialog;\n    return missionStep;\n  }\n}\n\n/**\n *   dialog:\n *     - name: \"NPC name\" or $player  # who is talking\n *       line: \"hello, $player\"\n *       id: <line-id>  # optional\n *       nextLine: <line-id>  # optional: jump to another dialog if we don't\n *                             # want to fallthrough.  \"$EOD\" means \"end of\n *                             # dialog\"\n *     - name: \"NPC name\" or $player\n *       question: \"Red pill or blue pill?\"\n *       choices:\n *         - text: \"Red\"\n *           nextLine: <line-id>  # optional\n *         - text: \"Blue\"\n *           nextLine: <line-id>  # optional\n */\nclass Dialog {\n  constructor(missionStep) {\n    this.missionStep = missionStep;\n    this.dialogItems = [];\n    this.dialogIdMap = {};\n  }\n\n  addDialogItem(dialogItem) {\n    this.dialogItems.push(dialogItem);\n    if (dialogItem.id !== undefined) {\n      this.dialogIdMap[dialogItem.id] = this.dialogItems.length - 1;\n    }\n  }\n\n  getIterator() {\n    return new DialogIterator(this, this.missionStep.nextStep);\n  }\n\n  static fromDict(list, missionStep) {\n    const dialog = new Dialog(missionStep);\n    for (const dict of list) {\n      const dialogItem = DialogItem.fromDict(dict);\n      dialog.addDialogItem(dialogItem);\n    }\n    return dialog;\n  }\n}\n\n\nclass DialogIterator {\n  constructor(dialog, nextStep) {\n    this.dialog = dialog;\n    this.currentIndex = 0;\n    this.nextStep = nextStep;\n  }\n\n  getCurrentDialogItem() {\n    const item = this.dialog.dialogItems[this.currentIndex];\n    if (item && item.nextStep) this.nextStep = item.nextStep;\n    return item;\n  }\n\n  nextDialogItem(answer=undefined) {\n    const dialogItem = this.dialog.dialogItems[this.currentIndex];\n    let nextIndex = this.currentIndex + 1;\n    if (dialogItem.nextLine !== undefined) {\n      nextIndex = this.dialog.dialogIdMap[dialogItem.nextLine];\n    }\n\n    if (dialogItem instanceof DialogItemSelect) {\n      if (answer === undefined) {\n        console.warn('This is a multiple choice question, but no selected ' +\n          'answer. Default to the first answer.')\n        answer = 0;\n      }\n\n      if (dialogItem.choices[answer].nextLine !== undefined) {\n        const nextLine = dialogItem.choices[answer].nextLine;\n        nextIndex = this.dialog.dialogIdMap[nextLine];\n      }\n    }\n\n    if (dialogItem instanceof DialogItemPrompt) {\n      if (dialogItem.storeKey) {\n        DataStore.AnswerStore.setAndNotify(dialogItem.storeKey, answer);\n      }\n    }\n    if (dialogItem instanceof DialogItemSelect) {\n      const value = dialogItem.choices[answer].value || answer;\n      if (dialogItem.storeKey) {\n        DataStore.AnswerStore.setAndNotify(dialogItem.storeKey, value);\n        DataStore.RemoteStore.increase(`USER_RESPONSE/${dialogItem.storeKey}`);\n      }\n    }\n\n    console.info(`${this.dialog.missionStep.id} The next line is: ${nextIndex}`);\n    this.currentIndex = nextIndex;\n    return this.getCurrentDialogItem();\n  }\n}\n\n/**\n * Properties:\n *   - id: (optional) an id to find this line.\n *   - name: Who is talking, can be \"$player\"\n *   - nextLine: (optional) jump to another dialog if we don't want to fallthrough.\n *               use \"$EOD\" to end the dialog.\n */\nclass DialogItem {\n  constructor(name, {id: id, nextLine: nextLine}) {\n    this.name = name;\n    this.id = id;\n    this.nextLine = nextLine;\n  }\n\n  static fromDict(dict) {\n    const name = dict['name'] || 'John Doe';\n    const type = dict['type'] || 'line';\n\n    switch (type) {\n      case 'line':\n        return new DialogItemLine(name, dict);\n      case 'input.select':\n        return new DialogItemSelect(name, dict);\n      case 'input.text':\n        return new DialogItemPrompt(name, dict);\n      case 'message':\n        return new DialogItemMessage(name, dict);\n      default:\n        console.warn('unkonwn dialog type: %s', type);\n        return new DialogItemLine(name, dict);\n    }\n  }\n}\n\n/**\n * Dialog item for a single line\n *     - name: \"NPC name\" or $player  # who is talking\n *       line: \"hello, $player\"\n *       id: <line-id>  # optional\n *       nextLine: <line-id>  # optional: jump to another dialog if we don't\n *                             # want to fallthrough.  \"$EOD\" means \"end of\n *                             # dialog\"\n */\nexport class DialogItemLine extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    line: line, }) {\n    super(name, {id, nextLine});\n\n    if (line === undefined) {\n      console.warn('One of `line` and `question` should be defined.');\n      line = '...';\n    }\n    this.line = line;\n  }\n\n}\n\n/**\n *     - name: \"NPC name\" or $player\n *       question: \"Red pill or blue pill?\"\n *       storeKey: 'key'  (optional) to save the answer in localStore.\n *       choices:\n *         - text: \"Red\"\n *           nextLine: <line-id>  # optional\n *         - text: \"Blue\"\n *           nextLine: <line-id>  # optional\n */\nexport class DialogItemSelect extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    question: question,\n    choices: choices,\n    storeKey: storeKey}) {\n\n    super(name, {id, nextLine});\n    if (question === undefined) {\n      console.warn('set default question');\n      question = 'Please select an answer.';\n    }\n    this.question = question;\n\n    if (choices === undefined || !choices) {\n      console.warn('set default choices');\n      choices = [\n        {text: 'Ok'}\n      ]\n    }\n    this.choices = choices;\n    this.storeKey = storeKey;\n  }\n}\n\n/**\n * Dialog item for an open question\n *\n *     - name: \"NPC name\" or $player\n *       question: \"What's your name?\"\n *       storeKey: 'key' (optional) to save the answer in localStore\n *\n */\nexport class DialogItemPrompt extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    question: question,\n    storeKey: storeKey, }) {\n    super(name, {id, nextLine});\n    if (question === undefined) {\n      console.warn('set deafult question');\n      question = 'What do you want to share?';\n    }\n    this.question = question;\n    this.storeKey = storeKey;\n  }\n}\n\nexport class DialogItemMessage extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    message: message}) {\n    super(name, {id, nextLine});\n    if (message === undefined) {\n      console.warn('use default message');\n      message = 'MESSAGE';\n    }\n    this.message = message;\n  }\n}\n\nexport function loadStoryLineFromObject(obj) {\n  const missions = obj['missions'];\n  const loadedMissions = {};\n  if (!missions) {\n    return loadedMissions;\n  }\n\n  for (const missionId in missions) {\n    const missionDict = missions[missionId];\n    loadedMissions[missionId] = Mission.fromDict(missionId, missionDict);\n  }\n  console.log(loadedMissions);\n  return loadedMissions;\n}\n\nexport async function loadStoryLine(fileName) {\n  const response = await fetch(`/story-lines/${fileName}`);\n  const obj = await response.json();\n\n  return loadStoryLineFromObject(obj);\n}\n","import * as Const from './const.js';\nimport * as StoryLine from './story_line.js';\nimport * as DataStore from './data_store.js';\n\nexport class Char {\n  constructor(phaser, id, name, x, y, texture, frame) {\n    this.phaser = phaser;\n    if (Number.isNaN(x)) x = 0;\n    if (Number.isNaN(y)) y = 0;\n    this.id = id;\n    this.x = x;\n    this.y = y;\n    this._name = name;\n    this.texture = texture;\n    this.frame = frame;\n    this.facing = 'DOWN';\n    this.missionMark = null;\n\n    this.makeContainer();\n  }\n\n  makeContainer() {\n    // Create a sprite with physics enabled via the physics system. The image\n    // used for the sprite has a bit of whitespace, so I'm using setSize &\n    // setOffset to control the size of the player's body.\n    this.player = this.phaser.physics.add.sprite(\n      this.x, this.y, this.texture, this.frame).setSize(32, 40).setOffset(0, 24);\n\n    this.text = this.phaser.add.text(this.x, this.y, this.name, {\n      font: '18px monospace',\n      fill: '#fff',\n      align: 'center',\n    }).setOrigin(0.5).setStroke('#000', 3).setDepth(30);\n  }\n\n  get WIDTH() {\n    return 32;\n  }\n\n  get HEIGHT() {\n    return 32;\n  }\n\n  get SPEED() {\n    return 256;\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  set name(newName) {\n    this._name = newName;\n    this.text.setText(this.name);\n  }\n\n  showMissionMark(enable) {\n    if (enable) {\n      if (this.missionMark) return;\n\n      this.missionMark = this.phaser.add.text(\n        this.player.x, this.player.y - 16,\n        '!',\n        {\n          font: '24px monospace',\n          fill: '#000',\n          align: 'center',\n        }\n      ).setOrigin(0.5).setStroke('#fff', 3);\n    } else {\n      this.missionMark.destroy();\n      this.missionMark = null;\n    }\n  }\n\n  update() {\n    // this is stupid, but I can't find a better way.\n    this.text.setX(this.player.x);\n    this.text.setY(this.player.y + 45);\n  }\n}\n\nexport class CharDaemon {\n  constructor(phaser) {\n    this.phaser = phaser;\n    this.chars = {};\n  }\n\n  create(id, name, x, y, texture, frame) {\n    if (id in this.chars) {\n      console.error(`Character ID \"${id}\" is already declared:`);\n      console.error(this.chars[id]);\n      return;\n    }\n    const char = new Char(\n      this.phaser,\n      id, name, x, y, texture, frame);\n\n    this.chars[id] = char;\n    return char;\n  }\n\n  getChar(id) {\n    if (id in this.chars) {\n      return this.chars[id];\n    }\n    return null;\n  }\n\n  update(time, delta) {\n    for (const id in this.chars) {\n      const char = this.chars[id];\n      char.update(time, delta);\n    }\n  }\n}\n\n\nexport class StoryLineDaemon {\n  constructor(storyLine, dialogDaemon) {\n    this.storyLine = storyLine;\n    this.dialogDaemon = dialogDaemon;\n    this.missionWithDependencies = {};\n\n    DataStore.AnswerStore.listen('*', () => {\n      console.log(this);\n      for (const missionId in this.missionWithDependencies) {\n        const mission = this.storyLine[missionId];\n        if (!mission.isReady()) {\n          continue;\n        }\n        delete this.missionWithDependencies[missionId];\n\n        this._addToDialogDaemon(mission);\n      }\n    });\n  }\n\n  init() {\n    for (const missionId in this.storyLine) {\n      const mission = this.storyLine[missionId];\n\n      if (!mission.isReady()) {\n        this.missionWithDependencies[missionId] = mission;\n        continue;\n      }\n\n      this._addToDialogDaemon(mission);\n    }\n    console.log('not enabled missions: ', this.missionWithDependencies);\n  }\n\n  _addToDialogDaemon(mission) {\n      const key = mission.firstStep;\n      const firstStep = mission.steps[key];\n\n      const id = `${mission.id}/${firstStep.id}`;\n      this.dialogDaemon.add(id, firstStep.npcId, firstStep.dialog);\n\n  }\n}\n\nconst _RE_PLAYER = /\\$player/;\n\nexport class DialogDaemon {\n  constructor(charDaemon) {\n    this.charDaemon = charDaemon;\n    this.dialogs = {};\n    this.hasOnGoingDialog = false;\n    this.dialogToTrigger = [];\n  }\n\n  showHint() {\n    let message = '';\n    for (const key in this.dialogs) {\n      const dialog = this.dialogs[key];\n      console.log(dialog);\n      message += `<h3>${dialog.dialog.missionStep.title}</h3>`;\n      message += `<p>${dialog.dialog.missionStep.description}</p>`;\n    }\n    if (!message) {\n      message = '沒有任務!';\n    }\n    bootbox.alert({\n      title: '任務列表',\n      message: message,\n    });\n  }\n\n  getDialog(dialogId) {\n    if (dialogId in this.dialogs) {\n      return this.dialogs[dialogId];\n    }\n    return null;\n  }\n\n  showDialog(iterator) {\n    const item = iterator.getCurrentDialogItem();\n    if (!item) {\n      this.doneDialog(iterator);\n      return;\n    }\n\n    this.hasOnGoingDialog = true;\n    const me = this.charDaemon.getChar('player');\n    const talker = item.name.replace(_RE_PLAYER, me.name);\n\n    if (item instanceof StoryLine.DialogItemLine) {\n      const content = item.line.replace(_RE_PLAYER, me.name);\n      bootbox.alert({\n        title: talker,\n        message: content,\n        callback: () => {\n          this.hasOnGoingDialog = false;\n          const next = iterator.nextDialogItem();\n          if (next) {\n            this.showDialog(iterator);\n          } else {\n            this.doneDialog(iterator);\n          }\n        }\n      });\n    } else if (item instanceof StoryLine.DialogItemSelect) {\n      const question = item.question.replace(_RE_PLAYER, me.name);\n      const inputOptions = [];\n\n      for (const idx in item.choices) {\n        const text = item.choices[idx].text;\n        inputOptions.push({\n          text: text.replace(_RE_PLAYER, me.name),\n          value: idx,\n        });\n      }\n\n      bootbox.prompt({\n        title: talker,\n        message: question,\n        inputType: 'select',\n        onEscape: false,\n        backdrop: true,\n        inputOptions: inputOptions,\n        callback: result => {\n          if (result === null) {\n            return false;\n          }\n          this.hasOnGoingDialog = false;\n          const next = iterator.nextDialogItem(result);\n          if (next) {\n            this.showDialog(iterator);\n          } else {\n            this.doneDialog(iterator);\n          }\n          return true;\n        }\n      });\n    } else if (item instanceof StoryLine.DialogItemPrompt) {\n      const question = item.question.replace(_RE_PLAYER, me.name);\n      bootbox.prompt({\n        title: talker,\n        message: question,\n        inputType: 'text',\n        onEscape: false,\n        backdrop: true,\n        callback: result => {\n          if (result === null) {\n            return false;\n          }\n          this.hasOnGoingDialog = false;\n          const next = iterator.nextDialogItem(result);\n          if (next) {\n            this.showDialog(iterator);\n          } else {\n            this.doneDialog(iterator);\n          }\n          return true;\n        }\n      });\n    } else if (item instanceof StoryLine.DialogItemMessage) {\n      const message = item.message.replace(_RE_PLAYER, me.name);\n      bootbox.alert({\n        title: \"\",\n        message: message,\n        callback: () => {\n          this.hasOnGoingDialog = false;\n          const next = iterator.nextDialogItem();\n          if (next) {\n            this.showDialog(iterator);\n          } else {\n            this.doneDialog(iterator);\n          }\n        }\n      });\n    }\n  }\n\n  recordDone(recordKey) {\n    DataStore.AnswerStore.setAndNotify(recordKey, \"true\");\n    DataStore.RemoteStore.increase(`MISSION/${recordKey}`);\n  }\n\n  doneDialog(iterator) {\n    const dialog = iterator.dialog;\n    const missionStep = dialog.missionStep;\n    const mission = missionStep.mission;\n\n    this.remove(`${mission.id}/${missionStep.id}`);\n    this.recordDone(`${mission.id}/${missionStep.id}/done`);\n\n    const nextStepKey = iterator.nextStep;\n    if (!nextStepKey) {\n      return;\n    }\n\n    console.log(nextStepKey);\n\n    const nextStep = mission.steps[nextStepKey];\n    if (!nextStep) return;\n    this.add(`${mission.id}/${nextStep.id}`, nextStep.npcId, nextStep.dialog);\n  }\n\n  moveTo(where) {\n    const player = this.charDaemon.getChar('player');\n    console.log(player);\n    switch (where) {\n      case 'SCHOOL':\n        player.player.x = 500;\n        player.player.y = 500;\n        break;\n    }\n  }\n\n  startDialog(dialogId) {\n    if (this.hasOnGoingDialog) {\n      console.warn(`There is an on-going dialog, cannot start a new one`);\n      return;\n    }\n\n    const tuple = this.getDialog(dialogId);\n    if (tuple === null) {\n      console.error(`No such dialog: ${dialogId}`);\n      return;\n    }\n\n    console.info(`startDialog: ${dialogId}`, tuple.dialog);\n\n    const {dialog} = tuple;\n\n    if (dialog.missionStep.moveTo) {\n      this.moveTo(dialog.missionStep.moveTo);\n    }\n\n    const iterator = dialog.getIterator();\n    this.showDialog(iterator);\n  }\n\n  checkDialogToTrigger() {\n    if (this.hasOnGoingDialog) return null;\n\n    for (const idx in this.dialogToTrigger) {\n      const {dialogId} = this.dialogToTrigger[idx];\n      this.dialogToTrigger.shift();\n      return dialogId;\n    }\n\n    return null;\n  }\n\n  findNearbyDialog(me) {\n    for (const dialogId in this.dialogs) {\n      const {npcId} = this.dialogs[dialogId];\n      const npc = this.charDaemon.getChar(npcId);\n\n      if (Math.hypot(npc.x - me.x, npc.y - me.y) < 2 * Const.TILE_SIZE) {\n        return dialogId;\n      }\n    }\n    return null;\n  }\n\n  add(dialogId, npcId, dialog) {\n    if (this.getDialog(dialogId) !== null) {\n      console.error(`Dialog ${dialogId} already exists.`);\n      return;\n    }\n\n    if (npcId === undefined) {\n      // trigger this in next frame\n      this.dialogToTrigger.push({\n        dialogId,\n        dialog,\n      });\n    } else {\n      const npc = this.charDaemon.getChar(npcId);\n      if (null === npc) {\n        console.error(`NPC ${npcId} doesn't exist.`);\n        return;\n      }\n      // npc.missionMark = true;\n      npc.showMissionMark(true);\n    }\n\n    this.dialogs[dialogId] = {\n      npcId: npcId,\n      dialog: dialog,\n    };\n    return this.dialogs[dialogId];\n  }\n\n  remove(dialogId) {\n    const tuple = this.getDialog(dialogId);\n    if (null === tuple) {\n      return;\n    }\n\n    const {npcId} = tuple;\n    const npc = this.charDaemon.getChar(npcId);\n    if (npc !== null) {\n      // npc.missionMark = false;\n      npc.showMissionMark(false);\n    }\n\n    delete this.dialogs[dialogId];\n  }\n}\n","import * as DataStore from './data_store.js';\nimport * as Hero from './hero.js';\nimport * as StoryLine from './story_line.js';\n\nconst config = {\n  type: Phaser.AUTO,\n  width: 800,\n  height: 600,\n  parent: \"game-container\",\n  pixelArt: true,\n  physics: {\n    default: \"arcade\",\n    arcade: {\n      gravity: { y: 0 }\n    }\n  },\n  scene: {\n    preload: preload,\n    create: create,\n    update: update\n  }\n};\n\nconst game = new Phaser.Game(config);\nlet cursors;\nlet player;\nlet showDebug = false;\n\nfunction preload() {\n  this.load.setPath('assets/');\n  this.load.image(\"tiles\", \"tiles/world.png\");\n  this.load.tilemapTiledJSON(\"map\", \"maps/idystopia.json\");\n\n  // An atlas is a way to pack multiple images together into one texture. I'm using it to load all\n  // the player animations (walking left, walking right, etc.) in one image. For more info see:\n  //  https://labs.phaser.io/view.html?src=src/animation/texture%20atlas%20animation.js\n  // If you don't use an atlas, you can do the same thing with a spritesheet, see:\n  //  https://labs.phaser.io/view.html?src=src/animation/single%20sprite%20sheet.js\n  this.load.atlas(\"atlas\", \"atlas/atlas.png\", \"atlas/atlas.json\");\n}\n\nfunction create() {\n  const map = this.make.tilemap({ key: \"map\" });\n\n  // Parameters are the name you gave the tileset in Tiled and then the key of the tileset image in\n  // Phaser's cache (i.e. the name you used in preload)\n  const tileset = map.addTilesetImage(\"world\", \"tiles\");\n\n  // Parameters: layer name (or index) from Tiled, tileset, x, y\n  const belowLayer = map.createStaticLayer(\"Below Player\", tileset, 0, 0);\n  const worldLayer = map.createStaticLayer(\"World\", tileset, 0, 0);\n  const aboveLayer = map.createStaticLayer(\"Above Player\", tileset, 0, 0);\n\n  worldLayer.setCollisionByProperty({ collides: true });\n\n  // By default, everything gets depth sorted on the screen in the order we created things. Here, we\n  // want the \"Above Player\" layer to sit on top of the player, so we explicitly give it a depth.\n  // Higher depths will sit on top of lower depth objects.\n  aboveLayer.setDepth(10);\n\n  // Object layers in Tiled let you embed extra info into a map - like a spawn point or custom\n  // collision shapes. In the tmx file, there's an object layer with a point named \"Spawn Point\"\n  const spawnPoint = map.findObject(\"Objects\", obj => obj.name === \"Spawn Point\");\n\n  this.charDaemon = new Hero.CharDaemon(this);\n\n  /*\n  this.charDaemon.create(\n    'lost-and-found-npc', '失物招領處員工',\n    spawnPoint.x + 64, spawnPoint.y - 64, 'atlas', 'misa-left');\n  this.charDaemon.create(\n    'lady-of-lake', '湖中女神',\n    spawnPoint.x + 128, spawnPoint.y - 128, 'atlas', 'misa-left');\n  this.charDaemon.create(\n    'registration-npc', '臨櫃人員',\n    spawnPoint.x + 128, spawnPoint.y - 256, 'atlas', 'misa-left');\n  */\n\n  // TODO(stimim): move this into another file.\n  const NPCs = {\n    'convenient-store-npc': {\n      name: '便利商店店員',\n      x: spawnPoint.x + 128,\n      y: spawnPoint.y - 128,\n      texture: 'atlas',\n      frame: 'misa-left',\n    },\n    'classmate-npc': {\n      name: '同學',\n      x: 600,\n      y: 550,\n      texture: 'atlas',\n      frame: 'misa-left',\n    },\n    'academic-affairs-officer-npc': {\n      name: '教務處職員',\n      x: 700,\n      y: 550,\n      texture: 'atlas',\n      frame: 'misa-left',\n    },\n    'department-officer-npc': {\n      name: '系辦公室職員',\n      x: 800,\n      y: 550,\n      texture: 'atlas',\n      frame: 'misa-right',\n    },\n    'home-robot-npc': {\n      name: '家用機器人',\n      x: 400,\n      y: 550,\n      texture: 'atlas',\n      frame: 'misa-right'\n    }\n  };\n\n  for (const npcId in NPCs) {\n    if (!NPCs.hasOwnProperty(npcId)) continue;\n    const {name, x, y, texture, frame} = NPCs[npcId];\n    this.charDaemon.create(npcId, name, x, y, texture, frame);\n  }\n\n  const char = this.charDaemon.create(\n    'player', '???', spawnPoint.x, spawnPoint.y, 'atlas', 'misa-front');\n  player = char.player;\n\n  // Watch the player and worldLayer for collisions, for the duration of the scene:\n  const group = this.physics.add.group();\n\n  for (const id in this.charDaemon.chars) {\n    if (this.charDaemon.chars.hasOwnProperty(id)) {\n      const p = this.charDaemon.chars[id].player;\n      group.add(p);\n      // I don't know why, but I can't do this in Char.makeContainer function.\n      // And we must not set player as immovable.\n      if (id !== 'player') {\n        p.setImmovable(true);\n      }\n    }\n  }\n\n  this.physics.add.collider(group, group);\n  this.physics.add.collider(group, worldLayer);\n\n  this.dialogDaemon = new Hero.DialogDaemon(this.charDaemon);\n\n  // TODO(stimim): properly load game status\n  DataStore.AnswerStore.clearAll();\n\n  StoryLine.loadStoryLine('regular.json').then(\n    (storyLine) => {\n      this.storyLineDaemon = new Hero.StoryLineDaemon(storyLine, this.dialogDaemon);\n      this.storyLineDaemon.init();\n    }\n  );\n\n  DataStore.AnswerStore.listen('player_name', (e) => {\n    char.name = DataStore.AnswerStore.get('player_name');\n  });\n  // Create the player's walking animations from the texture atlas. These are stored in the global\n  // animation manager so any sprite can access them.\n  const anims = this.anims;\n  anims.create({\n    key: \"misa-left-walk\",\n    frames: anims.generateFrameNames(\"atlas\", { prefix: \"misa-left-walk.\", start: 0, end: 3, zeroPad: 3 }),\n    frameRate: 10,\n    repeat: -1\n  });\n  anims.create({\n    key: \"misa-right-walk\",\n    frames: anims.generateFrameNames(\"atlas\", { prefix: \"misa-right-walk.\", start: 0, end: 3, zeroPad: 3 }),\n    frameRate: 10,\n    repeat: -1\n  });\n  anims.create({\n    key: \"misa-front-walk\",\n    frames: anims.generateFrameNames(\"atlas\", { prefix: \"misa-front-walk.\", start: 0, end: 3, zeroPad: 3 }),\n    frameRate: 10,\n    repeat: -1\n  });\n  anims.create({\n    key: \"misa-back-walk\",\n    frames: anims.generateFrameNames(\"atlas\", { prefix: \"misa-back-walk.\", start: 0, end: 3, zeroPad: 3 }),\n    frameRate: 10,\n    repeat: -1\n  });\n\n  const missionButton = this.add.text(512 + 128, 512, 'Mission', {\n    font: '18px monospace',\n    fill: '#000',\n    backgroundColor: '#fff',\n    padding: {x: 10, y: 10},\n  }).setScrollFactor(0)\n  .setDepth(30)\n  .setInteractive();\n\n  missionButton.on('pointerdown', () => {\n    this.dialogDaemon.showHint();\n  });\n\n  const camera = this.cameras.main;\n  camera.startFollow(player);\n  camera.setBounds(0, 0, map.widthInPixels, map.heightInPixels);\n\n  cursors = this.input.keyboard.createCursorKeys();\n  const enterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);\n  enterKey.on('down',(key, event) => {\n    if (this.dialogDaemon.hasOnGoingDialog) return;\n    const dialogId = this.dialogDaemon.findNearbyDialog(player);\n    if (dialogId !== null) {\n      this.dialogDaemon.startDialog(dialogId);\n    }\n  });\n\n  // Help text that has a \"fixed\" position on the screen\n  this.add\n    .text(16, 16, 'Arrow keys to move\\nPress \"D\" to show hitboxes', {\n      font: \"18px monospace\",\n      fill: \"#000000\",\n      padding: { x: 20, y: 10 },\n      backgroundColor: \"#ffffff\"\n    })\n    .setScrollFactor(0)\n    .setDepth(30);\n\n  // Debug graphics\n  this.input.keyboard.once(\"keydown_D\", event => {\n    // Turn on physics debugging to show player's hitbox\n    this.physics.world.createDebugGraphic();\n\n    // Create worldLayer collision graphic above the player, but below the help text\n    const graphics = this.add\n      .graphics()\n      .setAlpha(0.75)\n      .setDepth(20);\n    worldLayer.renderDebug(graphics, {\n      tileColor: null, // Color of non-colliding tiles\n      collidingTileColor: new Phaser.Display.Color(243, 134, 48, 255), // Color of colliding tiles\n      faceColor: new Phaser.Display.Color(40, 39, 37, 255) // Color of colliding face edges\n    });\n  });\n}\n\nfunction update(time, delta) {\n  // let's check if we triggered any dialogs\n  const dialogId = this.dialogDaemon.checkDialogToTrigger(player);\n  if (dialogId !== null) {\n    this.dialogDaemon.startDialog(dialogId);\n    return;\n  }\n\n  const speed = 175;\n  const prevVelocity = player.body.velocity.clone();\n\n  // Stop any previous movement from the last frame\n  player.body.setVelocity(0);\n\n  // Horizontal movement\n  if (cursors.left.isDown) {\n    player.body.setVelocityX(-speed);\n  } else if (cursors.right.isDown) {\n    player.body.setVelocityX(speed);\n  }\n\n  // Vertical movement\n  if (cursors.up.isDown) {\n    player.body.setVelocityY(-speed);\n  } else if (cursors.down.isDown) {\n    player.body.setVelocityY(speed);\n  }\n\n  // Normalize and scale the velocity so that player can't move faster along a diagonal\n  player.body.velocity.normalize().scale(speed);\n\n  // Update the animation last and give left/right animations precedence over up/down animations\n  if (cursors.left.isDown) {\n    player.anims.play(\"misa-left-walk\", true);\n  } else if (cursors.right.isDown) {\n    player.anims.play(\"misa-right-walk\", true);\n  } else if (cursors.up.isDown) {\n    player.anims.play(\"misa-back-walk\", true);\n  } else if (cursors.down.isDown) {\n    player.anims.play(\"misa-front-walk\", true);\n  } else {\n    player.anims.stop();\n\n    // If we were moving, pick and idle frame to use\n    if (prevVelocity.x < 0) player.setTexture(\"atlas\", \"misa-left\");\n    else if (prevVelocity.x > 0) player.setTexture(\"atlas\", \"misa-right\");\n    else if (prevVelocity.y < 0) player.setTexture(\"atlas\", \"misa-back\");\n    else if (prevVelocity.y > 0) player.setTexture(\"atlas\", \"misa-front\");\n  }\n  this.charDaemon.update();\n}\n"],"sourceRoot":""}