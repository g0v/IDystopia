{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/js/hero.js","webpack:///./src/js/remote_key_map.js","webpack:///./src/js/data_store.js","webpack:///./src/js/const.js","webpack:///./src/js/phaser_wrapper.js","webpack:///./src/js/story_line.js","webpack:///./node_modules/store2/dist/store2.js","webpack:///./src/js/jitsi_channel.js","webpack:///./src/js/online_event.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","bootbox","setDefaults","closeButton","Char","scene","id","x","y","texture","frame","this","Number","isNaN","_name","messages","messageBox","makeContainer","player","physics","add","sprite","setSize","setOffset","setDepth","text","font","fill","align","setOrigin","setStroke","newName","setText","message","expireTime","undefined","Infinity","push","shift","enable","addMessage","clearMessage","now","Date","getTime","end","slice","time","delta","setX","setY","length","_removeOutdatedMessage","backgroundColor","jointMessage","setVisible","destroy","MovingNPC","movements","super","points","dx","dy","px","py","nextPoint","Math","hypot","max","setVelocity","setVelocityX","setVelocityY","body","velocity","normalize","scale","update","RemotePlayer","ps","timestamp","setTexture","dT","dt","faceLR","abs","anims","play","stop","frameName","idx","search","newFrameName","substr","setFrame","_RE_PLAYER","charDaemon","chars","console","error","char","dialogDaemon","dialogs","hasOnGoingDialog","dialogToTrigger","dialog","log","missionStep","title","description","alert","dialogId","iterator","result","nextDialogItem","showDialog","doneDialog","item","getCurrentDialogItem","me","getChar","talker","replace","content","line","callback","showNextDialog","question","inputOptions","choices","prompt","inputType","onEscape","backdrop","buttons","cancel","label","className","keypress","e","keyCode","$","click","style","url","size","centerVertical","onShown","iframe","document","getElementById","onHidden","recordKey","setAndNotify","increase","mission","remove","recordDone","nextStepKey","nextStep","steps","movement","location","npcId","camera","cameras","main","fadeOut","_","progressFadeOut","fadeIn","progressFadeIn","warn","tuple","getDialog","info","getIterator","isDialogDonePreviously","moveTo","locationId","loc","npc","step","showMissionMark","storyLineDaemon","storyLine","missionWithDependencies","listen","missionId","isReady","_addToDialogDaemon","firstStep","window","KEY_MAP","REV_KEY_MAP","_hasOwnProperty","obj","callbacks","fn","set","_DATASTORE_API_URL","_REMOTE_STORE_CACHE","namespace","AnswerStore","RemoteStore","_tokenChecked","response","fetch","method","data","json","token","has","_register","ok","_ensureToken","_inc","_getc","localKey","count","getCount","TILE_SIZE","SPEED","mapObjects","config","cursors","left","isDown","right","up","down","WINDOW_WIDTH","innerWidth","WINDOW_HEIGHT","innerHeight","IntroScene","Phaser","Scene","load","setPath","sys","game","device","os","desktop","video","setMute","width","height","min","setScale","on","padding","input","keyboard","once","startNextScene","start","GameScene","tilemapTiledJSON","storylineJSON","npcList","image","audio","atlas","show","gameSceneConfig","postBootCallback","clearAll","then","init","hospitalBackgroundMusic","sound","loop","volume","isCLabEnv","pauseOnBlur","locked","Sound","Events","UNLOCKED","map","make","tilemap","tileset","addTilesetImage","belowLayer","createStaticLayer","worldLayer","aboveLayer","setCollisionByProperty","collides","objectLayer","getObjectLayer","objects","forEach","setScene","point","createMovingNPC","home","vision","makeMask","mask","renderTexture","setTint","Display","Masks","BitmapMask","invertAlpha","group","setImmovable","collider","frames","generateFrameNames","prefix","zeroPad","frameRate","repeat","startFollow","setBounds","widthInPixels","heightInPixels","cursorKeys","Input","Keyboard","KeyCodes","LEFT","RIGHT","UP","DOWN","addKey","event","lastUserInputTimestamp","ENTER","findNearbyDialog","startDialog","hide","setScrollFactor","world","createDebugGraphic","graphics","setAlpha","renderDebug","tileColor","collidingTileColor","Color","faceColor","stick","limit","centerX","position","centerY","top","tap","preventDefault","touch","originalEvent","targetTouches","deltaX","pageX","deltaY","pageY","css","onDoneCreate","connection","visible","checkDialogToTrigger","prevVelocity","clone","vX","vY","pause","confirm","resume","reload","CreateGame","type","AUTO","parent","default","arcade","gravity","Scale","RESIZE","Game","joinOnlineEvent","conn","setDisplayName","sendMessage","Mission","depend","clause","expr","expectedValue","Array","_checkClause","dict","filter","String","stepId","MissionStep","fromDict","addStep","Dialog","dialogItems","dialogIdMap","dialogItem","DialogIterator","list","DialogItem","addDialogItem","currentIndex","answer","nextIndex","nextLine","DialogItemSelect","DialogItemPrompt","storeKey","DialogItemLine","DialogItemMessage","DialogItemIframe","async","loadStoryLine","fileName","missions","loadedMissions","missionDict","debug","loadStoryLineFromObject","define","version","areas","apis","inherit","api","getOwnPropertyDescriptor","stringify","JSON","parse","revive","storeAPI","area","getItem","string","setItem","removeItem","clear","Store","store","overwrite","arguments","getAll","transact","each","setAll","_id","_area","storage","_ns","singleArea","substring","isFake","toString","_in","keys","_out","fillList","k","v","alt","fillObj","all","val","ret","changed","concat","indexOf","storageAPI","items","localStorage","local","sessionStorage","amd","conflict","INIT_OPTIONS","disableAudioLevels","desktopSharingChromeExtId","desktopSharingChromeDisabled","desktopSharingChromeSources","desktopSharingChromeMinExtVersion","desktopSharingFirefoxDisabled","initJitsiMeetJs","JitsiMeetJS","setLogLevel","logLevels","ERROR","INITIALIZED","JitsiConnection","room","_lastSetLocalProperty","_lastBroadcastLocalProperty","_sentLocalProperty","_displayName","conenction","hosts","domain","muc","focus","externalConnectUrl","bosh","websocket","clientNode","onDisconnected","removeEventListener","events","CONNECTION_ESTABLISHED","onConnectionSuccess","CONNECTION_FAILED","onConnectionFailed","CONNECTION_DISCONNECTED","addEventListener","connect","disconnect","_initConferenceRoom","confOptions","openBridgeChannel","confID","initJitsiConference","conference","CONFERENCE_JOINED","onConferenceJoined","join","properties","setLocalParticipantProperty","leave","participants","user","createRemotePlayer","getDisplayName","getProperty","loadParticipants","USER_JOINED","MESSAGE_RECEIVED","myUserId","USER_LEFT","deleteChar","PARTICIPANT_PROPERTY_CHANGED","getId","parseInt","setProperty","ENDPOINT_MESSAGE_RECEIVED","participant","payload","DISPLAY_NAME_CHANGED","sendTextMessage","broadcastEndpointMessage","broadcastLocalProperty","draggable","bottom","soundButton","newMute","mute","blur","select"],"mappings":"aACE,IAAIA,EAAmB,GAGvB,SAASC,EAAoBC,GAG5B,GAAGF,EAAiBE,GACnB,OAAOF,EAAiBE,GAAUC,QAGnC,IAAIC,EAASJ,EAAiBE,GAAY,CACzCG,EAAGH,EACHI,GAAG,EACHH,QAAS,IAUV,OANAI,EAAQL,GAAUM,KAAKJ,EAAOD,QAASC,EAAQA,EAAOD,QAASF,GAG/DG,EAAOE,GAAI,EAGJF,EAAOD,QAKfF,EAAoBQ,EAAIF,EAGxBN,EAAoBS,EAAIV,EAGxBC,EAAoBU,EAAI,SAASR,EAASS,EAAMC,GAC3CZ,EAAoBa,EAAEX,EAASS,IAClCG,OAAOC,eAAeb,EAASS,EAAM,CAAEK,YAAY,EAAMC,IAAKL,KAKhEZ,EAAoBkB,EAAI,SAAShB,GACX,oBAAXiB,QAA0BA,OAAOC,aAC1CN,OAAOC,eAAeb,EAASiB,OAAOC,YAAa,CAAEC,MAAO,WAE7DP,OAAOC,eAAeb,EAAS,aAAc,CAAEmB,OAAO,KAQvDrB,EAAoBsB,EAAI,SAASD,EAAOE,GAEvC,GADU,EAAPA,IAAUF,EAAQrB,EAAoBqB,IAC/B,EAAPE,EAAU,OAAOF,EACpB,GAAW,EAAPE,GAA8B,iBAAVF,GAAsBA,GAASA,EAAMG,WAAY,OAAOH,EAChF,IAAII,EAAKX,OAAOY,OAAO,MAGvB,GAFA1B,EAAoBkB,EAAEO,GACtBX,OAAOC,eAAeU,EAAI,UAAW,CAAET,YAAY,EAAMK,MAAOA,IACtD,EAAPE,GAA4B,iBAATF,EAAmB,IAAI,IAAIM,KAAON,EAAOrB,EAAoBU,EAAEe,EAAIE,EAAK,SAASA,GAAO,OAAON,EAAMM,IAAQC,KAAK,KAAMD,IAC9I,OAAOF,GAIRzB,EAAoB6B,EAAI,SAAS1B,GAChC,IAAIS,EAAST,GAAUA,EAAOqB,WAC7B,WAAwB,OAAOrB,EAAgB,SAC/C,WAA8B,OAAOA,GAEtC,OADAH,EAAoBU,EAAEE,EAAQ,IAAKA,GAC5BA,GAIRZ,EAAoBa,EAAI,SAASiB,EAAQC,GAAY,OAAOjB,OAAOkB,UAAUC,eAAe1B,KAAKuB,EAAQC,IAGzG/B,EAAoBkC,EAAI,GAIjBlC,EAAoBA,EAAoBmC,EAAI,I,+BClFrD,wKAKAC,QAAQC,YAAY,CAClBC,aAAa,IAKR,MAAMC,EACX,YAAYC,EAAOC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,GAC1CC,KAAKN,MAAQA,EACTO,OAAOC,MAAMN,KAAIA,EAAI,GACrBK,OAAOC,MAAML,KAAIA,EAAI,GACzBG,KAAKL,GAAKA,EACVK,KAAKJ,EAAIA,EACTI,KAAKH,EAAIA,EACTG,KAAKG,MAAQtC,EACbmC,KAAKF,QAAUA,EACfE,KAAKD,MAAQA,EACbC,KAAKI,SAAW,GAChBJ,KAAKK,WAAa,KAElBL,KAAKM,gBAGP,gBAIEN,KAAKO,OAASP,KAAKN,MAAMc,QAAQC,IAAIC,OACnCV,KAAKJ,EAAGI,KAAKH,EAAGG,KAAKF,QAASE,KAAKD,OAClCY,QAAQ,GAAI,IACZC,UAAU,EAAG,IAEhBZ,KAAKO,OAAOM,SAAS,GAErBb,KAAKc,KAAOd,KAAKN,MAAMe,IAAIK,KAAKd,KAAKJ,EAAGI,KAAKH,EAAGG,KAAKnC,KAAM,CACzDkD,KAAM,iBACNC,KAAM,OACNC,MAAO,WACNC,UAAU,IAAKC,UAAU,OAAQ,GAAGN,SAAS,GAGlD,YACE,OAAO,GAGT,aACE,OAAO,GAGT,WACE,OAAOb,KAAKG,MAGd,SAASiB,GACPpB,KAAKG,MAAQiB,EACbpB,KAAKc,KAAKO,QAAQrB,KAAKnC,MAGzB,WAAWyD,EAASC,QACCC,IAAfD,IAA0BA,EAAaE,KACvCzB,KAAKI,SAASsB,KAAK,CAACJ,UAASC,eAxDZ,GAyDnBvB,KAAKI,SAASuB,QAIlB,eACE3B,KAAKI,SAAW,GAGlB,gBAAgBwB,GACVA,EACF5B,KAAK6B,WAAW,KAEhB7B,KAAK8B,eAIT,yBACE,MAAMC,GAAM,IAAKC,MAAQC,UACzB,IAAIC,EAAM,EACV,IAAK,MAAM5E,KAAK0C,KAAKI,SACfJ,KAAKI,SAAS9C,GAAGiE,WAAaQ,IAChC/B,KAAKI,SAAS8B,GAAOlC,KAAKI,SAAS9C,GACnC4E,KAGJlC,KAAKI,SAAWJ,KAAKI,SAAS+B,MAAM,EAAGD,GAGzC,OAAOE,EAAMC,GASX,GAPArC,KAAKc,KAAKwB,KAAKtC,KAAKO,OAAOX,GAC3BI,KAAKc,KAAKyB,KAAKvC,KAAKO,OAAOV,EAAI,IAE3BG,KAAKI,SAASoC,OAAS,GACzBxC,KAAKyC,yBAGHzC,KAAKI,SAASoC,OAAS,EAAG,CACvBxC,KAAKK,aACRL,KAAKK,WAAaL,KAAKN,MAAMe,IAAIK,KAC/Bd,KAAKO,OAAOX,EAAGI,KAAKO,OAAOV,EAAI,GAC/B,GACA,CACEkB,KAAM,iBACNC,KAAM,OACNC,MAAO,SACPyB,gBAAiB,UAEnBxB,UAAU,GAAK,GAAGL,SAAS,KAE/B,IAAI8B,EAAe,GACnB,IAAK,MAAMrF,KAAK0C,KAAKI,SACnBuC,GAAgB3C,KAAKI,SAAS9C,GAAGgE,QAAU,KAE7CtB,KAAKK,WAAWgB,QAAQsB,EAAaR,MAAM,GAAI,IAC/CnC,KAAKK,WAAWuC,YAAW,QAEvB5C,KAAKK,YAAYL,KAAKK,WAAWuC,YAAW,GAG9C5C,KAAKK,aACPL,KAAKK,WAAWiC,KAAKtC,KAAKO,OAAOX,GACjCI,KAAKK,WAAWkC,KAAKvC,KAAKO,OAAOV,EAAI,KAIzC,UACEG,KAAKO,OAAOsC,UACZ7C,KAAKc,KAAK+B,WAIP,MAAMC,UAAkBrD,EAC7B,YAAYC,EAAOC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,EAAOgD,GACjDC,MAAMtD,EAAOC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,GAEtCC,KAAKiD,OAAS,GACdjD,KAAKiD,OAAOvB,KAAK,CAAC9B,EAAGA,EAAGC,EAAGA,IAE3B,IAAK,MAAM,GAACqD,EAAE,GAAEC,KAAOJ,EAAW,CAChC,MAAMK,EAAKpD,KAAKiD,OAAOjD,KAAKiD,OAAOT,OAAS,GAAG5C,EACzCyD,EAAKrD,KAAKiD,OAAOjD,KAAKiD,OAAOT,OAAS,GAAG3C,EAC/CG,KAAKiD,OAAOvB,KAAK,CAAC9B,EAAGwD,EAAKF,EAAIrD,EAAGwD,EAAKF,IAGpCnD,KAAKiD,OAAOT,OAAS,IACvBxC,KAAKsD,UAAY,GAIrB,OAAOlB,EAAMC,GACX,MAAMe,EAAKpD,KAAKiD,OAAOjD,KAAKsD,WAAW1D,EACjCyD,EAAKrD,KAAKiD,OAAOjD,KAAKsD,WAAWzD,EAC1B0D,KAAKC,MAAMJ,EAAKpD,KAAKO,OAAOX,EAAGyD,EAAKrD,KAAKO,OAAOV,GAC9C0D,KAAKE,IAAsB,GAAlB,IAAuB,IAAcpB,EAAQ,MAGnErC,KAAKO,OAAOmD,YAAY,GACxB1D,KAAKO,OAAO+B,KAAKc,GACjBpD,KAAKO,OAAOgC,KAAKc,GAEjBrD,KAAKsD,WAAatD,KAAKsD,UAAY,GAAKtD,KAAKiD,OAAOT,SAEpDxC,KAAKO,OAAOoD,aAAaP,EAAKpD,KAAKJ,GACnCI,KAAKO,OAAOqD,aAAaP,EAAKrD,KAAKH,GACnCG,KAAKO,OAAOsD,KAAKC,SAASC,YAAYC,MAAM,MAE9ChE,KAAKJ,EAAII,KAAKO,OAAOX,EACrBI,KAAKH,EAAIG,KAAKO,OAAOV,EAErBmD,MAAMiB,OAAO7B,EAAMC,IAIhB,MAAM6B,UAAqBzE,EAEhC,YAAYC,EAAOC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,GAC1CiD,MAAMtD,EAAOC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,GAGtCC,KAAKmE,GAAK,CAAE,CAAEvE,IAAGC,IAAGrB,EAAG,EAAG4F,UAAW,GAAI,CAACxE,IAAGC,IAAGrB,EAAG,EAAG4F,UAAW,IAGnE,YAAYvF,EAAKN,GACf,OAAQM,GACN,IAAK,UACH,MAAM,QAACiB,EAAO,MAAEC,GAASxB,EACpByB,KAAKF,UACRE,KAAKF,QAAUA,EACfE,KAAKD,MAAQA,EACbC,KAAKO,OAAO8D,WAAWvE,IAEzB,MACF,IAAK,QAGH,MACF,IAAK,OACHE,KAAKnC,KAAOU,EACZ,MACF,IAAK,WAECyB,KAAKmE,GAAG,GAAGC,UAAY7F,EAAM6F,YAC/BpE,KAAKmE,GAAK,CAACnE,KAAKmE,GAAG,GAAI5F,KAK/B,OAAO6D,EAAMC,GAEXW,MAAMiB,OAAO7B,EAAMC,GAEnB,MAAMN,GAAM,IAAKC,MAAQC,UAEzB,GAAIF,EAAM/B,KAAKmE,GAAG,GAAG3F,EACnB,OAGF,MAAM0E,EAAKlD,KAAKmE,GAAG,GAAGvE,EAAII,KAAKmE,GAAG,GAAGvE,EAC/BuD,EAAKnD,KAAKmE,GAAG,GAAGtE,EAAIG,KAAKmE,GAAG,GAAGtE,EAC/ByE,EAAKtE,KAAKmE,GAAG,GAAG3F,EAAIwB,KAAKmE,GAAG,GAAG3F,EAErC,GAAI8F,GAAM,EAAG,OAEb,MAAMC,EAAKxC,EAAM/B,KAAKmE,GAAG,GAAG3F,EAC5BwB,KAAKO,OAAO+B,KAAKtC,KAAKmE,GAAG,GAAGvE,EAAIsD,EAAKoB,EAAKC,GAC1CvE,KAAKO,OAAOgC,KAAKvC,KAAKmE,GAAG,GAAGtE,EAAIsD,EAAKmB,EAAKC,GAE1C,MAAMC,EAASjB,KAAKkB,IAAIvB,IAAOK,KAAKkB,IAAItB,GACxC,GAAIqB,GAAUtB,EAAK,EACjBlD,KAAKO,OAAOmE,MAAMC,KAAK,kBAAkB,QACpC,GAAIH,GAAUtB,EAAK,EACxBlD,KAAKO,OAAOmE,MAAMC,KAAK,mBAAmB,QACrC,GAAIxB,EAAK,EACdnD,KAAKO,OAAOmE,MAAMC,KAAK,kBAAkB,QACpC,GAAIxB,EAAK,EACdnD,KAAKO,OAAOmE,MAAMC,KAAK,mBAAmB,OACrC,CACL3E,KAAKO,OAAOmE,MAAME,OAClB,MAAMC,EAAY7E,KAAKO,OAAOR,MAAMlC,KAC9BiH,EAAMD,EAAUE,OAAO,QAC7B,GAAID,EAAM,EAAG,CACX,MAAME,EAAeH,EAAUI,OAAO,EAAGH,EAAM,GAC/C9E,KAAKO,OAAO2E,SAASF,MA4H7B,MAAMG,EAAa,WAiXZ,MAAMC,EAAa,IAvenB,MACL,cACEpF,KAAKN,MAAQ,KACbM,KAAKqF,MAAQ,GAGf,SAAS3F,GACPM,KAAKN,MAAQA,EAGf,OAAOC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,GAC9B,GAAIJ,KAAMK,KAAKqF,MAGb,OAFAC,QAAQC,MAAM,iBAAiB5F,gCAC/B2F,QAAQC,MAAMvF,KAAKqF,MAAM1F,IAG3B,MAAM6F,EAAO,IAAI/F,EACfO,KAAKN,MACLC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,GAG3B,OADAC,KAAKqF,MAAM1F,GAAM6F,EACVA,EAGT,gBAAgB7F,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,EAAOgD,GAC9C,GAAIpD,KAAMK,KAAKqF,MAGb,OAFAC,QAAQC,MAAM,iBAAiB5F,gCAC/B2F,QAAQC,MAAMvF,KAAKqF,MAAM1F,IAI3B,MAAM6F,EAAO,IAAI1C,EACf9C,KAAKN,MACLC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,EAAOgD,GAGlC,OADA/C,KAAKqF,MAAM1F,GAAM6F,EACVA,EAGT,mBAAmB7F,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,GAC1C,GAAIJ,KAAMK,KAAKqF,MAGb,OAFAC,QAAQC,MAAM,iBAAiB5F,gCAC/B2F,QAAQC,MAAMvF,KAAKqF,MAAM1F,IAI3B,MAAM6F,EAAO,IAAItB,EACflE,KAAKN,MACLC,EAAI9B,EAAM+B,EAAGC,EAAGC,EAASC,GAG3B,OADAC,KAAKqF,MAAM1F,GAAM6F,EACVA,EAGT,WAAW7F,GACLA,KAAMK,KAAKqF,QACbrF,KAAKqF,MAAM1F,GAAIkD,iBACR7C,KAAKqF,MAAM1F,IAItB,QAAQA,GACN,OAAOK,KAAKqF,MAAM1F,IAAO,KAG3B,OAAOyC,EAAMC,GACX,IAAK,MAAM1C,KAAMK,KAAKqF,MAAO,CACdrF,KAAKqF,MAAM1F,GACnBsE,OAAO7B,EAAMC,MAoaXoD,EAAe,IAhXrB,MACL,YAAYL,GACVpF,KAAKoF,WAAaA,EAClBpF,KAAK0F,QAAU,GACf1F,KAAK2F,kBAAmB,EACxB3F,KAAK4F,gBAAkB,GAGzB,YACE,OAAO5F,KAAKoF,WAAW1F,MAGzB,WACE,IAAI4B,EAAU,GACd,IAAK,MAAMzC,KAAOmB,KAAK0F,QAAS,CAC9B,MAAMG,EAAS7F,KAAK0F,QAAQ7G,GAC5ByG,QAAQQ,IAAID,GACZvE,GAAW,OAAOuE,EAAOA,OAAOE,YAAYC,aAC5C1E,GAAW,MAAMuE,EAAOA,OAAOE,YAAYE,kBAExC3E,IACHA,EAAU,SAEZhC,QAAQ4G,MAAM,CACZF,MAAO,OACP1E,QAASA,IAIb,UAAU6E,GACR,OAAIA,KAAYnG,KAAK0F,QACZ1F,KAAK0F,QAAQS,GAEf,KAGT,eAAeC,EAAUC,GACvBrG,KAAK2F,kBAAmB,EACXS,EAASE,eAAeD,GAEnCrG,KAAKuG,WAAWH,GAEhBpG,KAAKwG,WAAWJ,GAIpB,WAAWA,GACT,MAAMK,EAAOL,EAASM,uBACtB,IAAKD,EAEH,YADAzG,KAAKwG,WAAWJ,GAIlBpG,KAAK2F,kBAAmB,EACxB,MAAMgB,EAAK3G,KAAKoF,WAAWwB,QAAQ,UAC7BC,EAASJ,EAAK5I,KAAKiJ,QAAQ3B,EAAYwB,EAAG9I,MAGhD,GADAyH,QAAQQ,IAAI,qBAAsBM,GAC9BK,aAAgB,IAA0B,CAC5C,MAAMM,EAAUN,EAAKO,KAAKF,QAAQ3B,EAAYwB,EAAG9I,MACjDyB,QAAQ4G,MAAM,CACZF,MAAOa,EACPvF,QAASyF,EACTE,SAAU,KACRjH,KAAKkH,eAAed,WAGnB,GAAIK,aAAgB,IAA4B,CACrD,MAAMU,EAAWV,EAAKU,SAASL,QAAQ3B,EAAYwB,EAAG9I,MAChDuJ,EAAe,GAErB,IAAK,MAAMtC,KAAO2B,EAAKY,QAAS,CAC9B,MAAMvG,EAAO2F,EAAKY,QAAQvC,GAAKhE,KAC/BsG,EAAa1F,KAAK,CAChBZ,KAAMA,EAAKgG,QAAQ3B,EAAYwB,EAAG9I,MAClCU,MAAOuG,IAICxF,QAAQgI,OAAO,CACzBtB,MAAOa,EACPvF,QAAS6F,EACTI,UAAW,SACXC,UAAU,EACVC,UAAU,EACVL,aAAcA,EACdM,QAAS,CACPC,OAAQ,CACNC,MAAO,SACPC,UAAW,yBAGfZ,SAAUZ,GACO,OAAXA,IAGJrG,KAAKkH,eAAed,EAAUC,IACvB,KAGPyB,SAASC,IACO,KAAdA,EAAEC,SACJC,EAAE,yBAAyBC,eAG1B,GAAIzB,aAAgB,IAA4B,CACrD,MAAMU,EAAWV,EAAKU,SAASL,QAAQ3B,EAAYwB,EAAG9I,MACtDyB,QAAQgI,OAAO,CACbtB,MAAOa,EACPvF,QAAS6F,EACTI,UAAW,OACXC,UAAU,EACVC,UAAU,EACVC,QAAS,CACPC,OAAQ,CACNC,MAAO,SACPC,UAAW,yBAGfZ,SAAUZ,KACHA,IAGLrG,KAAKkH,eAAed,EAAUC,IACvB,UAGN,GAAII,aAAgB,IAA6B,CACtD,MAAMnF,EAAUmF,EAAKnF,QAAQwF,QAAQ3B,EAAYwB,EAAG9I,MACpDyB,QAAQ4G,MAAM,CACZF,MAAO,GACP1E,QAASA,EACT2F,SAAU,KACRjH,KAAKkH,eAAed,WAGnB,GAAIK,aAAgB,IAA4B,CACrD,MAAM0B,EAAQ1B,EAAK0B,OAAS,GACtB7G,EAAU,4FAIPmF,EAAK2B,wBACHD,gBACX7I,QAAQuG,OAAO,CACbvE,UACA+G,KAAM,QACNC,gBAAgB,EAChB9I,aAAa,EAEb+I,QAAS,KACP,MAAMC,EAASC,SAASC,eAAe,iBACvCpD,QAAQQ,IAAI0C,IAEdG,SAAU,KAERrD,QAAQQ,IAAI,aACZ9F,KAAKkH,eAAed,OAS5B,WAAWwC,GACT,IAAsBC,aAAaD,EAAW,QAC9C,IAAsBE,SAAS,WAAWF,GAG5C,uBAAuBxC,GACrB,MACML,EADSK,EAASP,OACGE,YAErBlH,EAAM,GADIkH,EAAYgD,QACLpJ,MAAMoG,EAAYpG,UACzC,MAA2C,SAAnC,IAAsBxB,IAAIU,GAGpC,WAAWuH,GACTpG,KAAK2F,kBAAmB,EACxB,MACMI,EADSK,EAASP,OACGE,YACrBgD,EAAUhD,EAAYgD,QAE5B/I,KAAKgJ,OAAO,GAAGD,EAAQpJ,MAAMoG,EAAYpG,MACzCK,KAAKiJ,WAAW,GAAGF,EAAQpJ,MAAMoG,EAAYpG,WAE7C,MAAMuJ,EAAc9C,EAAS+C,SAC7B,IAAKD,EACH,OAGF5D,QAAQQ,IAAI,gBAAiBoD,GAE7B,MAAMC,EAAWJ,EAAQK,MAAMF,GAC1BC,GACLnJ,KAAKS,IAAI,GAAGsI,EAAQpJ,MAAMwJ,EAASxJ,KAAMwJ,GAG3C,OAAOE,EAAUpC,GACU,iBAAf,IACRoC,EAAW,CAACC,SAAUD,IAGxB,MAAM1C,EAAK3G,KAAKoF,WAAWwB,QAAQ,UACnC,IAAI,MAAC2C,EAAK,SAAED,GAAYD,EACnBE,IACHA,EAAQ,UAEVjE,QAAQQ,IAAI,QAASyD,EAAO,aAAcD,GAC1C,MAAM9D,EAAOxF,KAAKoF,WAAWwB,QAAQ2C,GACrC,IAAK/D,EAAM,OACN8D,GACCA,KAAY,KACD,YAAbA,EAQFA,EAAW,IAAyBA,IAPpCA,EAAW,CACT1J,EAAG+G,EAAGpG,OAAOX,EACbC,EAAG8G,EAAGpG,OAAOV,EAAI,EAAI,KAGvB2F,EAAKjF,OAAO2E,SAAS,eAKvB,MAAMsE,EAASxJ,KAAKN,MAAM+J,QAAQC,KAElCF,EAAOG,QAAQ,IAAK,EAAG,EAAG,EAAG,CAACC,EAAGC,KAC3BA,EAAkB,IACtBrE,EAAK5F,EAAI4F,EAAKjF,OAAOX,EAAI0J,EAAS1J,EAClC4F,EAAK3F,EAAI2F,EAAKjF,OAAOV,EAAIyJ,EAASzJ,EAClC2J,EAAOM,OAAO,IAAK,EAAG,EAAG,EAAG,CAACF,EAAGG,KAC1BA,EAAiB,GACrB9C,SAKN,YAAYd,GACV,GAAInG,KAAK2F,iBAEP,YADAL,QAAQ0E,KAAK,uDAIf,MAAMC,EAAQjK,KAAKkK,UAAU/D,GAC7B,GAAc,OAAV8D,EAEF,YADA3E,QAAQC,MAAM,mBAAmBY,GAInCb,QAAQ6E,KAAK,gBAAgBhE,EAAY8D,EAAMpE,QAC/C,MAAM,OAACA,GAAUoE,EACjBjK,KAAK2F,kBAAmB,EAExB,MAAMS,EAAWP,EAAOuE,cACxB,GAAIpK,KAAKqK,uBAAuBjE,GAG9B,OAFAd,QAAQQ,IAAI,iCACZ9F,KAAKwG,WAAWJ,GAIdP,EAAOE,YAAYuE,OACrBtK,KAAKsK,OAAOzE,EAAOE,YAAYuE,OAAQ,KACrCtK,KAAKuG,WAAWH,MAGlBd,QAAQ6E,KAAK/D,GACbpG,KAAKuG,WAAWH,IAIpB,qBAAqBO,GACnB,GAAI3G,KAAK2F,iBAAkB,OAAO,KAElC,IAAK,MAAMb,KAAO9E,KAAK4F,gBAAiB,CACtC,MAAM,SAACO,GAAYnG,KAAK4F,gBAAgBd,GAGxC,OAFA9E,KAAK4F,gBAAgBjE,QACrB2D,QAAQ6E,KAAK,gBAAgBhE,GACtBA,EAGT,IAAK,MAAMA,KAAYnG,KAAK0F,QAAS,CACnC,MAAM,WAAC6E,GAAcvK,KAAK0F,QAAQS,GAClC,GAAIoE,GAAeA,KAAc,IAA2B,CAC1D,MAAMC,EAAM,IAAyBD,GACrC,GAAIhH,KAAKC,MAAMgH,EAAI5K,EAAI+G,EAAG/G,EAAG4K,EAAI3K,EAAI8G,EAAG9G,GAAK,EAAI,IAE/C,OADAyF,QAAQQ,IAAI,sBAAuBK,EAAU,uBACtCA,GAKb,OAAO,KAGT,iBAAiBQ,GACf,IAAK,MAAMR,KAAYnG,KAAK0F,QAAS,CACnC,MAAM,MAAC6D,GAASvJ,KAAK0F,QAAQS,GAC7B,GAAIoD,EAAO,CACT,MAAMkB,EAAMzK,KAAKoF,WAAWwB,QAAQ2C,GAEpC,GAAIhG,KAAKC,MAAMiH,EAAI7K,EAAI+G,EAAG/G,EAAG6K,EAAI5K,EAAI8G,EAAG9G,GAAK,EAAI,IAC/C,OAAOsG,GAIb,OAAO,KAGT,IAAIA,EAAUuE,GACZ,MAAM7E,EAAS6E,EAAK7E,OACd0D,EAAQmB,EAAKnB,MACbgB,EAAaG,EAAKH,WAIxB,GAFAjF,QAAQQ,IAAI,aAAaK,aAAoBoD,WAAegB,KAE3B,OAA7BvK,KAAKkK,UAAU/D,GAAnB,CAKA,QAAmB3E,IAAfkJ,EAAKnB,MAAqB,CAC5B,MAAMkB,EAAMzK,KAAKoF,WAAWwB,QAAQ2C,GACpC,GAAI,OAASkB,EAEX,YADAnF,QAAQC,MAAM,OAAOgE,oBAGvBkB,EAAIE,iBAAgB,QACf,QAAwBnJ,IAApBkJ,EAAKH,YACd,KAAMA,KAAc,KAElB,YADAjF,QAAQC,MAAM,YAAYgF,yBAI5BjF,QAAQ6E,KAAK,UAAUhE,wBAEvBnG,KAAK4F,gBAAgBlE,KAAK,CACxByE,WACAN,WASJ,OALA7F,KAAK0F,QAAQS,GAAY,CACvBoD,MAAOA,EACPgB,WAAYA,EACZ1E,OAAQA,GAEH7F,KAAK0F,QAAQS,GA9BlBb,QAAQC,MAAM,UAAUY,qBAiC5B,OAAOA,GACL,MAAM8D,EAAQjK,KAAKkK,UAAU/D,GAC7B,GAAI,OAAS8D,EACX,OAGF,MAAM,MAACV,GAASU,EACVQ,EAAMzK,KAAKoF,WAAWwB,QAAQ2C,GACxB,OAARkB,GACFA,EAAIE,iBAAgB,UAGf3K,KAAK0F,QAAQS,KAKqBf,GAChCwF,EAAkB,IA/ZxB,MACL,YAAYnF,GACVzF,KAAK6K,UAAY,KACjB7K,KAAKyF,aAAeA,EACpBzF,KAAK8K,wBAA0B,GAE/B,IAAsBC,OAAO,IAAK,KAChCzF,QAAQQ,IAAI9F,MACZ,IAAK,MAAMgL,KAAahL,KAAK8K,wBAAyB,CACpD,MAAM/B,EAAU/I,KAAK6K,UAAUG,GAC1BjC,EAAQkC,mBAGNjL,KAAK8K,wBAAwBE,GAEpChL,KAAKkL,mBAAmBnC,OAK9B,KAAK8B,GACH7K,KAAK6K,UAAYA,EACjB,IAAK,MAAMG,KAAahL,KAAK6K,UAAW,CACtC,MAAM9B,EAAU/I,KAAK6K,UAAUG,GAE1BjC,EAAQkC,UAKbjL,KAAKkL,mBAAmBnC,GAJtB/I,KAAK8K,wBAAwBE,GAAajC,EAM9CzD,QAAQQ,IAAI,yBAA0B9F,KAAK8K,yBAG7C,mBAAmB/B,GACf,MAAMlK,EAAMkK,EAAQoC,UACdA,EAAYpC,EAAQK,MAAMvK,GAE1Bc,EAAK,GAAGoJ,EAAQpJ,MAAMwL,EAAUxL,KACtCK,KAAKyF,aAAahF,IAAId,EAAIwL,KAuXmB1F,GAEnD2F,OAAOhG,WAAaA,G,qHCxuBb,MAAMiG,EAAU,CAAC,aAAa,4BAA4B,aAAa,sCAAsC,aAAa,gCAAgC,aAAa,iCAAiC,aAAa,gCAAgC,aAAa,kCAAkC,aAAa,oCAAoC,aAAa,gCAAgC,aAAa,sCAAsC,aAAa,0CAA0C,aAAa,0CAA0C,aAAa,0CAA0C,aAAa,wCAAwC,aAAa,0CAA0C,aAAa,4DAA4D,aAAa,iDAAiD,aAAa,gDAAgD,aAAa,sDAAsD,aAAa,2CAA2C,aAAa,2CAA2C,aAAa,2CAA2C,aAAa,2CAA2C,aAAa,6CAA6C,aAAa,yCAAyC,aAAa,yCAAyC,aAAa,yCAAyC,aAAa,iDAAiD,aAAa,0CAA0C,aAAa,0CAA0C,aAAa,0CAA0C,aAAa,0CAA0C,aAAa,kCAAkC,aAAa,yCAAyC,aAAa,4BAA4B,aAAa,4BAA4B,aAAa,4BAA4B,aAAa,2BAA2B,aAAa,4BAA4B,aAAa,6BAA6B,aAAa,gCAAgC,aAAa,+BAA+B,aAAa,iCAAiC,aAAa,sCAAsC,aAAa,6BAA6B,aAAa,2BAA2B,aAAa,+BAA+B,aAAa,6BAA6B,aAAa,gCAAgC,aAAa,yCAAyC,aAAa,gCAAgC,aAAa,sCAAsC,aAAa,sCAAsC,aAAa,wBAAwB,aAAa,yBAAyB,aAAa,uCAAuC,aAAa,sBAAsB,aAAa,yBAAyB,aAAa,uCAAuC,aAAa,yBAAyB,aAAa,wBAAwB,aAAa,uCAAuC,aAAa,kCAEx9FC,EAAc,GAC3B,IAAK,MAAMzM,KAAOwM,EAChBC,EAAYD,EAAQxM,IAAQA,ECS9B,SAAS0M,EAAgBC,EAAKvM,GAC5B,OAAOjB,OAAOkB,UAAUC,eAAe1B,KAAK+N,EAAKvM,IAGnD,SAAU2K,GACR,MAAM6B,EAAY,GAElB7B,EAAE8B,GAAG,gBAAgB,SAAS7M,EAAKN,GAGjC,GAFAyB,KAAK2L,IAAI9M,EAAKN,GAETyB,KAAKyL,UAAV,CAEA,GAAIF,EAAgBvL,KAAKyL,UAAW5M,GAClC,IAAK,MAAMoI,KAAYjH,KAAKyL,UAAU5M,GACpCoI,EAASxJ,KAAKuC,KAAMnB,GAIxB,GAAI0M,EAAgBvL,KAAKyL,UAAW,KAClC,IAAK,MAAMxE,KAAYjH,KAAKyL,UAAU,KACpCxE,EAASxJ,KAAKuC,KAAMnB,OAK1B+K,EAAE8B,GAAG,UAAU,WACb,IAAK,MAAM7M,KAAO4M,EAChB,GAAIF,EAAgBvL,KAAKyL,UAAW5M,GAClC,IAAK,MAAMoI,KAAYjH,KAAKyL,UAAU5M,GACpCoI,EAASxJ,KAAKuC,SAMtB4J,EAAE8B,GAAG,UAAU,SAAS7M,EAAKoI,QACJzF,IAAnBxB,KAAKyL,YACPzL,KAAKyL,UAAY,SAGSjK,IAAxBxB,KAAKyL,UAAU5M,KACjBmB,KAAKyL,UAAU5M,GAAO,IAGxBmB,KAAKyL,UAAU5M,GAAK6C,KAAKuF,MAxC7B,CA0CG,IAAY2C,GAGf,MAAMgC,EAAqB,6CACrBC,EAAsB,IAAYC,UAAU,sBA2G3C,MAAMC,EAAc,IAAYD,UAAU,iBACpCE,EAAc,IA1G3B,MACE,cAEEhM,KAAKiM,eAAgB,EAGvB,YACE,OAAOJ,EAAoB1N,IAAI,SAGjC,kBACE,MAAM+N,QAAiBC,MAASP,EAAH,YAAkC,CAC7DQ,OAAQ,SAGJC,QAAaH,EAASI,OAC5B,GAAID,EAAKE,MAAO,CACdV,EAAoBF,IAAI,QAASU,EAAKE,OAEtC,MAAMhL,GAAa,IAAKS,MAAQC,UAAY,MAC5C4J,EAAoBF,IAAI,SAAUpK,GAClCvB,KAAKiM,eAAgB,GAOzB,qBACE,IAAKJ,EAAoBW,IAAI,SAC3B,aAAaxM,KAAKyM,YAIpB,IADY,IAAKzK,MAAQC,UACf4J,EAAoB1N,IAAI,SAAU,GAC1C,aAAa6B,KAAKyM,YAIpB,IAAKzM,KAAKiM,cAAe,CACvB,MAAMM,EAAQvM,KAAKuM,MACbL,QACEC,MAAM,GAAGP,uBAAwCW,IAAS,CAC9DH,OAAQ,QAKZ,IAAgB,WADGF,EAASI,QACnBI,GACP,aAAa1M,KAAKyM,YAGpBzM,KAAKiM,eAAgB,GAIzB,WAAWpN,SACHmB,KAAK2M,eAEXrH,QAAQQ,IAAI,mBAAmBjH,GAE/B,MAAMuJ,EAAM,GAAGwD,eAAgC5L,KAAKuM,aAAa1N,IAC3DqN,QAAiBC,MAAM/D,EAAK,CAChCgE,OAAQ,SAGJC,QAAaH,EAASI,OAE5B,OADAhH,QAAQQ,IAAI,kBAAkBjH,QAAUwN,EAAK9N,gBAAiB8N,GACvDA,EAAK9N,MAGd,YAAYM,SACJmB,KAAK2M,eAGX,MAAMvE,EAAM,GAAGwD,gBAAiC5L,KAAKuM,aAAa1N,IAC5DqN,QAAiBC,MAAM/D,EAAK,CAChCgE,OAAQ,QAIV,aADmBF,EAASI,QAChB/N,MAGd,SAASM,GAEP,OADAA,EAAMyM,EAAYzM,GACXmB,KAAK4M,KAAK/N,GAGnB,SAASA,GAEP,OADAA,EAAMyM,EAAYzM,GACXmB,KAAK6M,MAAMhO,GAGpB,oBACE,MAAMwH,EAAS,GACf,IAAK,MAAMxH,KAAOwM,EAAS,CACzB,MAAMyB,EAAWzB,EAAQxM,GACnBkO,QAAc/M,KAAKgN,SAASF,GAClCzG,EAAOyG,GAAYC,EAErB,OAAO1G,K,6BCxKX,oEAAO,MACM4G,EAAY,GACZC,EAAQ,K,6BCFrB,2GAQWC,EAAa,GAExB,IAAI3H,EACJ,IAAI4H,EAAS,GACb,IAAIC,EAAU,CACZC,KAAM,CAAEC,QAAQ,GAChBC,MAAO,CAAED,QAAQ,GACjBE,GAAI,CAAEF,QAAQ,GACdG,KAAM,CAAEH,QAAQ,IAElB,MAAMI,EAAevC,OAAOwC,WACtBC,EAAgBzC,OAAO0C,YAO7B,MAAMC,UAAmBC,OAAOC,MAC9B,cACEjL,MAAM,SAGR,UACEhD,KAAKkO,KAAKC,QAAQ,WACdnO,KAAKoO,IAAIC,KAAKC,OAAOC,GAAGC,QAC1BxO,KAAKkO,KAAKO,MAAM,QAAS,uBAEzBzO,KAAKkO,KAAKO,MAAM,QAAS,4BAI7B,SACE,MAAMA,EAAQzO,KAAKS,IAAIgO,MAAMd,EAAe,EAAGE,EAAgB,EAAG,SAClEY,EAAMC,SAAQ,GAEd,MAAMC,EAAQF,EAAME,MACdC,EAASH,EAAMG,OACf5K,EAAQT,KAAKsL,IAAIlB,EAAegB,EAAOd,EAAgBe,GAC7DH,EAAMK,SAAS9K,GACfsB,QAAQQ,IAAI,iBACZ2I,EAAM9J,OAEN8J,EAAMM,GAAG,WAAYN,IACnBA,EAAM9J,MAAK,EAAM,EAAG,KAGlB3E,KAAKoO,IAAIC,KAAKC,OAAOC,GAAGC,QAC1BxO,KAAKS,IAAIK,KAAK6M,EAAe,EAAmB,GAAhBE,EAC9B,6BAA8B,CAC5B9M,KAAM,iBACNC,KAAM,UACNgO,QAAS,CAACpP,EAAG,GAAIC,EAAG,MACnBgB,SArCgB,IAqCaK,UAAU,IAE5ClB,KAAKS,IAAIK,KAAK6M,EAAe,EAAmB,GAAhBE,EAC9B,8BAA+B,CAC7B9M,KAAM,iBACNC,KAAM,UACNgO,QAAS,CAACpP,EAAG,GAAIC,EAAG,MACnBgB,SA5CgB,IA4CaK,UAAU,IAG9ClB,KAAKiP,MAAMC,SAASC,KAAK,gBAAiB,KACxCnP,KAAKoP,mBAGPpP,KAAKiP,MAAMF,GAAG,YAAa,KACzB/O,KAAKoP,kBACJpP,MAGL,iBAEEA,KAAKN,MAAM2P,MAAM,QACjBrP,KAAKN,MAAMsJ,OAAO,UAKtB,MAAMsG,UAAkBtB,OAAOC,MAC7B,cACEjL,MAAM,QAGR,UACEsC,QAAQQ,IAAI,sBACZ,MAAM,iBAACyJ,EAAgB,cAAEC,EAAa,QAAEC,GAAWrC,EAEnDpN,KAAKkO,KAAKC,QAAQ,WAClBnO,KAAKkO,KAAKwB,MAAM,QAAS,mBACzB1P,KAAKkO,KAAKwB,MAAM,SAAU,oBAC1B1P,KAAKkO,KAAKyB,MAAM,WAAY,sBAC5B3P,KAAKkO,KAAKqB,iBAAiB,MAAUA,EAAH,mBAQlCvP,KAAKkO,KAAK0B,MAAM,QAAS,kBAAmB,oBAC5C5P,KAAKkO,KAAK0B,MAAM,QAAS,kBAAmB,oBAG9C,eACE3H,EAAG,wBAAyB4H,OAC5B5H,EAAG,6BAA8B4H,OAEjC,MAAM,cAACL,GAAiBpC,GAClB,gBAAC0C,GAAmB1C,GACpB,iBAAC2C,GAAoBD,EAE3B,IAAsBE,WAEtB,IAAwBR,GAAeS,KACpCpF,IACC7K,KAAK4K,gBAAkB,IACvB5K,KAAK4K,gBAAgBsF,KAAKrF,KAI9B,IAAsBE,OAAO,cAAe,KAC1CvF,EAAK3H,KAAO,IAAsBM,IAAI,iBAGpC4R,GACFA,IAIJ,SACE/P,KAAKmQ,wBAA0BnQ,KAAKoQ,MAAM3P,IAAI,WAAY,CACxD4P,MAAM,EACNC,OAAQ,KAENlD,EAAOmD,YACTvQ,KAAKoQ,MAAMI,aAAc,GAEvBxQ,KAAKoQ,MAAMK,OACbzQ,KAAKoQ,MAAMjB,KAAKnB,OAAO0C,MAAMC,OAAOC,SAAU,KAC5C5Q,KAAKmQ,wBAAwBxL,SAG/B3E,KAAKmQ,wBAAwBxL,OAG/BW,QAAQQ,IAAI,qBACZ,MAAM,QAAC2J,GAAWrC,EACZyD,EAAM7Q,KAAK8Q,KAAKC,QAAQ,CAAElS,IAAK,QAI/BmS,EAAUH,EAAII,gBAAgB,QAAS,SA0B7C,GAvBAjR,KAAKkR,WAAaL,EAAIM,kBAAkB,eAAgBH,EAAS,EAAG,GACpEhR,KAAKoR,WAAaP,EAAIM,kBAAkB,QAASH,EAAS,EAAG,GAC7DhR,KAAKqR,WAAaR,EAAIM,kBAAkB,eAAgBH,EAAS,EAAG,GAEpEhR,KAAKoR,WAAWE,uBAAuB,CAAEC,UAAU,IAMnDvR,KAAKkR,WAAWrQ,SA1JM,GA2JtBb,KAAKoR,WAAWvQ,SA1JM,IA2JtBb,KAAKqR,WAAWxQ,SA1JM,IA4JtBuK,OAAOoG,YAAcX,EAAIY,eAAe,WAGxCZ,EAAIY,eAAe,WAAWC,QAAQC,QACpCnG,IAAQ2B,EAAW3B,EAAI3N,MAAQ2N,IAEjCxL,KAAKoF,WAAa,IAClBpF,KAAKoF,WAAWwM,SAAS5R,MAErByP,EACF,IAAK,MAAMlG,KAASkG,EAAS,CAC3B,MAAM,KAAC5R,EAAI,QAAEiC,EAAO,MAAEC,GAAS0P,EAAQlG,GACvC,KAAMA,KAAS4D,GACb,SAEF,MAAM0E,EAAQ1E,EAAW5D,GAErBkG,EAAQlG,GAAOxG,UACjB/C,KAAKoF,WAAW0M,gBACdvI,EAAO1L,EAAMgU,EAAMjS,EAAGiS,EAAMhS,EAAGC,EAASC,EACxC0P,EAAQlG,GAAOxG,WAEjB/C,KAAKoF,WAAWxG,OAAO2K,EAAO1L,EAAMgU,EAAMjS,EAAGiS,EAAMhS,EAAGC,EAASC,GAKrE,MAAMgS,EAAO5E,EAAiB,KAC9B3H,EAAOxF,KAAKoF,WAAWxG,OACrB,SAAU,MAAOmT,EAAKnS,EAAGmS,EAAKlS,EAAG,QAAS,cAC5CG,KAAKO,OAASiF,EAAKjF,OAEnBP,KAAKgS,OAAShS,KAAK8Q,KAAKpB,MAAM,CAC5B9P,EAAGI,KAAKO,OAAOX,EACfC,EAAGG,KAAKO,OAAOV,EACfhB,IAAK,SACL4B,KAAK,IAEPT,KAAKgS,OAAOlD,SAAS,KAErBxJ,QAAQQ,IAAI,kBACZ,MAAMmM,EAAW,KACXjS,KAAKkS,OACHlS,KAAKkS,KAAKA,MACZlS,KAAKkS,KAAKA,KAAKrP,UAEjB7C,KAAKkS,KAAKrP,WAGZ7C,KAAKkS,KAAOlS,KAAK8Q,KAAKqB,cAAc,CAClCvS,EAAGI,KAAKO,OAAOX,EACfC,EAAGG,KAAKO,OAAOV,EACf8O,MAAO,EAAI3O,KAAKgE,MAAM2K,MACtBC,OAAQ,EAAI5O,KAAKgE,MAAM4K,SACtB,GACH5O,KAAKkS,KAAKlR,KAAK,EAAU,GACzBhB,KAAKkS,KAAKE,QAAQ,QAClBpS,KAAKkS,KAAKrR,SApNS,IAqNnBb,KAAKkS,KAAKhR,UAAU,IAEpBlB,KAAKkS,KAAKA,KAAO,IAAIlE,OAAOqE,QAAQC,MAAMC,WAAWvS,KAAMA,KAAKgS,QAChEhS,KAAKkS,KAAKA,KAAKM,aAAc,GAG/BP,IACAjS,KAAKgE,MAAM+K,GAAG,SAAU,KACtBzJ,QAAQQ,IAAI,SAAU9F,KAAKgE,MAAM2K,MAAO3O,KAAKgE,MAAM4K,QACnDqD,MAKF,MAAMQ,EAAQzS,KAAKQ,QAAQC,IAAIgS,QAE/B,IAAK,MAAM9S,KAAMK,KAAKoF,WAAWC,MAC/B,GAAIrF,KAAKoF,WAAWC,MAAMlG,eAAeQ,GAAK,CAC5C,MAAMP,EAAIY,KAAKoF,WAAWC,MAAM1F,GAAIY,OACpCkS,EAAMhS,IAAIrB,GAGC,WAAPO,GACFP,EAAEsT,cAAa,GAKrB1S,KAAKQ,QAAQC,IAAIkS,SAASF,EAAOA,GACjCzS,KAAKQ,QAAQC,IAAIkS,SAASF,EAAOzS,KAAKoR,YAEtCpR,KAAKyF,aAAe,IAIpB,MAAMf,EAAQ1E,KAAK0E,MACnBA,EAAM9F,OAAO,CACXC,IAAK,iBACL+T,OAAQlO,EAAMmO,mBACZ,QAAS,CAAEC,OAAQ,kBAAmBzD,MAAO,EAAGnN,IAAK,EAAG6Q,QAAS,IACnEC,UAAW,GACXC,QAAS,IAEXvO,EAAM9F,OAAO,CACXC,IAAK,kBACL+T,OAAQlO,EAAMmO,mBACZ,QAAS,CAAEC,OAAQ,mBAAoBzD,MAAO,EAAGnN,IAAK,EAAG6Q,QAAS,IACpEC,UAAW,GACXC,QAAS,IAEXvO,EAAM9F,OAAO,CACXC,IAAK,kBACL+T,OAAQlO,EAAMmO,mBACZ,QAAS,CAAEC,OAAQ,mBAAoBzD,MAAO,EAAGnN,IAAK,EAAG6Q,QAAS,IACpEC,UAAW,GACXC,QAAS,IAEXvO,EAAM9F,OAAO,CACXC,IAAK,iBACL+T,OAAQlO,EAAMmO,mBACZ,QAAS,CAAEC,OAAQ,kBAAmBzD,MAAO,EAAGnN,IAAK,EAAG6Q,QAAS,IACnEC,UAAW,GACXC,QAAS,IAGX,MAAMzJ,EAASxJ,KAAKyJ,QAAQC,KAC5BF,EAAO0J,YAAYlT,KAAKO,QACxBiJ,EAAO2J,UAAU,EAAG,EAAGtC,EAAIuC,cAAevC,EAAIwC,gBAE9C,MAAMC,EAAa,CACjBtF,OAAOuF,MAAMC,SAASC,SAASC,KAC/B1F,OAAOuF,MAAMC,SAASC,SAASE,MAC/B3F,OAAOuF,MAAMC,SAASC,SAASG,GAC/B5F,OAAOuF,MAAMC,SAASC,SAASI,MAGjC,IAAK,MAAM7L,KAAWsL,EAAY,CAChC,MAAMzU,EAAMmB,KAAKiP,MAAMC,SAAS4E,OAAO9L,GAAS,GAChDnJ,EAAIkQ,GAAG,OAAQ,CAAClQ,EAAKkV,KAEnB,GADA/T,KAAKgU,wBAAyB,IAAKhS,MAAQC,WACvCjC,KAAKyF,aAAaE,iBACtB,OAAQoO,EAAM/L,SACZ,KAAKgG,OAAOuF,MAAMC,SAASC,SAASC,KAClCrG,EAAQC,KAAKC,QAAS,EACtB,MACF,KAAKS,OAAOuF,MAAMC,SAASC,SAASE,MAClCtG,EAAQG,MAAMD,QAAS,EACvB,MACF,KAAKS,OAAOuF,MAAMC,SAASC,SAASG,GAClCvG,EAAQI,GAAGF,QAAS,EACpB,MACF,KAAKS,OAAOuF,MAAMC,SAASC,SAASI,KAClCxG,EAAQK,KAAKH,QAAS,KAI5B1O,EAAIkQ,GAAG,KAAM,CAAClQ,EAAKkV,KAEjB,OADA/T,KAAKgU,wBAAyB,IAAKhS,MAAQC,UACnC8R,EAAM/L,SACZ,KAAKgG,OAAOuF,MAAMC,SAASC,SAASC,KAClCrG,EAAQC,KAAKC,QAAS,EACtB,MACF,KAAKS,OAAOuF,MAAMC,SAASC,SAASE,MAClCtG,EAAQG,MAAMD,QAAS,EACvB,MACF,KAAKS,OAAOuF,MAAMC,SAASC,SAASG,GAClCvG,EAAQI,GAAGF,QAAS,EACpB,MACF,KAAKS,OAAOuF,MAAMC,SAASC,SAASI,KAClCxG,EAAQK,KAAKH,QAAS,KAMbvN,KAAKiP,MAAMC,SAAS4E,OACnC9F,OAAOuF,MAAMC,SAASC,SAASQ,OAAO,GAC/BlF,GAAG,OAAQ,KAElB,GADA/O,KAAKgU,wBAAyB,IAAKhS,MAAQC,UACvCjC,KAAKyF,aAAaE,iBAAkB,OACxC,MAAMQ,EAAWnG,KAAKyF,aAAayO,iBAAiBlU,KAAKO,QACxC,OAAb4F,GACFnG,KAAKyF,aAAa0O,YAAYhO,KAK9BnG,KAAKoO,IAAIC,KAAKC,OAAOC,GAAGC,SAC1BvG,EAAE,aAAamM,OACfpU,KAAKS,IACFK,KAAK,GAAI,GAAI,gDAAiD,CAC7DC,KAAM,iBACNC,KAAM,UACNgO,QAAS,CAAEpP,EAAG,GAAIC,EAAG,IACrB6C,gBAAiB,YAElB2R,gBAAgB,GAChBxT,SAAS,MAEZoH,EAAE,aAAa4H,OACf7P,KAAKS,IACFK,KAAK,GAAI,GAAI,qDAAsD,CAClEC,KAAM,iBACNC,KAAM,UACNgO,QAAS,CAAEpP,EAAG,GAAIC,EAAG,IACrB6C,gBAAiB,YAElB2R,gBAAgB,GAChBxT,SAAS,KAGdb,KAAKiP,MAAMC,SAASC,KAAK,YAAa4E,IAEpC/T,KAAKQ,QAAQ8T,MAAMC,qBAInB,MAAMC,EAAWxU,KAAKS,IACnB+T,WACAC,SAAS,KACT5T,SAAS,IACZb,KAAKoR,WAAWsD,YAAYF,EAAU,CACpCG,UAAW,KACXC,mBAAoB,IAAI5G,OAAOqE,QAAQwC,MAAM,IAAK,IAAK,GAAI,KAC3DC,UAAW,IAAI9G,OAAOqE,QAAQwC,MAAM,GAAI,GAAI,GAAI,SAKpD,MAAME,EAAQ9M,EAAE,0BAChB,IAAI+M,EAAQ/M,EAAE,aAAa0G,QAAQ,EAE/BsG,EAAUhN,EAAE,aAAaiN,WAAW5H,KAAOrF,EAAE,aAAa0G,QAAQ,EAClEwG,EAAUlN,EAAE,aAAaiN,WAAWE,IAAMnN,EAAE,aAAa2G,SAAS,EAOtE3G,EAAEmD,QAAQ2D,GAAG,UAAU,WAJrBkG,EAAUhN,EAAE,aAAaiN,WAAW5H,KAAOrF,EAAE,aAAa0G,QAAQ,EAClEwG,EAAUlN,EAAE,aAAaiN,WAAWE,IAAMnN,EAAE,aAAa2G,SAAS,EAClEoG,EAAQ/M,EAAE,aAAa0G,QAAQ,KAMjC,IAAI0G,GAAM,EACVpN,EAAE,aAAa8G,GAAG,YAAchH,IAI9B,GAHAA,EAAEuN,iBACFD,GAAM,EAEFrV,KAAKyF,aAAaE,iBAKpB,OAJA0H,EAAQC,KAAKC,QAAS,EACtBF,EAAQG,MAAMD,QAAS,EACvBF,EAAQI,GAAGF,QAAS,OACpBF,EAAQK,KAAKH,QAAS,GAIxB,MAAMgI,EAAQxN,EAAEyN,cAAcC,cAAc,GAC5C,IAAIC,GAAUH,EAAMI,MAAQV,GAAWD,EACnCY,GAAUL,EAAMM,MAAQV,GAAWH,EACvCU,EAASnS,KAAKsL,IAAItL,KAAKE,IAAIiS,GAAS,GAAI,GACxCE,EAASrS,KAAKsL,IAAItL,KAAKE,IAAImS,GAAS,GAAI,GACxCb,EAAMe,IAAI,CAAC,KAAkB,GAAPJ,EAAY,GAAf,IAAsB,IAAiB,GAAPE,EAAY,GAAf,MAE7CrS,KAAKkB,IAAIiR,GAjCH,KAkCPA,EAAS,EACTrI,EAAQC,KAAKC,QAAS,EACtBF,EAAQG,MAAMD,QAAS,GAEtBhK,KAAKkB,IAAImR,GAtCH,KAuCPA,EAAS,EACTvI,EAAQI,GAAGF,QAAS,EACpBF,EAAQK,KAAKH,QAAS,GAErBhK,KAAKkB,IAAIiR,IAAWnS,KAAKkB,IAAImR,GAC3BF,EAAS,GACVrI,EAAQG,MAAMD,QAAS,EACvBF,EAAQC,KAAKC,QAAS,IAEtBF,EAAQG,MAAMD,QAAS,EACvBF,EAAQC,KAAKC,QAAS,GAGrBqI,EAAS,GACVvI,EAAQI,GAAGF,QAAS,EACpBF,EAAQK,KAAKH,QAAS,IAEtBF,EAAQI,GAAGF,QAAS,EACpBF,EAAQK,KAAKH,QAAS,KAI5BtF,EAAE,aAAa8G,GAAG,aAAa,eAAgB,KAC7CsG,GAAM,IAERpN,EAAE,aAAa8G,GAAG,WAAW,eAAgB,KAM3C,GALA9G,EAAE,0BAA0B6N,IAAI,CAAC,KAAQ,MAAO,IAAO,QACvDzI,EAAQI,GAAGF,QAAS,EACpBF,EAAQK,KAAKH,QAAS,EACtBF,EAAQC,KAAKC,QAAS,EACtBF,EAAQG,MAAMD,QAAS,EACpB8H,EAAK,CACN,GAAIrV,KAAKyF,aAAaE,iBAAkB,OACxC,MAAMQ,EAAWnG,KAAKyF,aAAayO,iBAAiBlU,KAAKO,QACxC,OAAb4F,GACFnG,KAAKyF,aAAa0O,YAAYhO,MAKpCnG,KAAK+V,eAGP,OAAO3T,EAAMC,GACPrC,KAAKgS,QAAUhS,KAAKkS,OAClB9E,EAAO4I,WACThW,KAAKkS,KAAK+D,SAAU,GAEpBjW,KAAKkS,KAAK+D,SAAU,EACpBjW,KAAKgS,OAAOpS,EAAII,KAAKO,OAAOX,EAC5BI,KAAKgS,OAAOnS,EAAIG,KAAKO,OAAOV,EAC5BG,KAAKkS,KAAKtS,EAAII,KAAKO,OAAOX,EAC1BI,KAAKkS,KAAKrS,EAAIG,KAAKO,OAAOV,IAM9B,MAAMsG,EAAWnG,KAAKyF,aAAayQ,qBAAqBlW,KAAKO,QAC7D,GAAiB,OAAb4F,EAEF,YADAnG,KAAKyF,aAAa0O,YAAYhO,GAIhC,MAAMgQ,EAAenW,KAAKO,OAAOsD,KAAKC,SAASsS,QAG/CpW,KAAKO,OAAOsD,KAAKH,YAAY,GAE7B,IAAI2S,EAAK,EACLC,EAAK,EA0BT,GAxBKtW,KAAKyF,aAAaE,mBAEjB0H,EAAQC,KAAKC,OACf8I,GAAM,IACGhJ,EAAQG,MAAMD,SACvB8I,EAAK,KAIHhJ,EAAQI,GAAGF,OACb+I,GAAM,IACGjJ,EAAQK,KAAKH,SACtB+I,EAAK,MAITtW,KAAKO,OAAOsD,KAAKF,aAAa0S,GAC9BrW,KAAKO,OAAOsD,KAAKD,aAAa0S,IAC1BD,GAAMC,IAGRtW,KAAKO,OAAOsD,KAAKC,SAASC,YAAYC,MAAM,KAG1CoJ,EAAOmD,UAAW,CACpB,MAAMxO,GAAM,IAAKC,MAAQC,UACpBjC,KAAKgU,uBAECjS,EAAM/B,KAAKgU,uBAAyB,MAE7ChU,KAAKN,MAAM6W,QACXjX,QAAQkX,QAAQ,CACdxQ,MAAO,YACP1E,QAAS,mBACToG,QAAS,CACPC,OAAQ,CACNC,MAAO,QAET4O,QAAS,CACP5O,MAAO,SAGXX,SAAWZ,IACLA,GACFrG,KAAKgU,wBAAyB,IAAKhS,MAAQC,UAC3CjC,KAAKN,MAAM+W,SACXnN,SAASoN,WAET1W,KAAKgU,wBAAyB,IAAKhS,MAAQC,UAC3CjC,KAAKN,MAAM+W,cAtBjBzW,KAAKgU,uBAAyBjS,EAgC9BsU,EAAK,EACPrW,KAAKO,OAAOmE,MAAMC,KAAK,kBAAkB,GAChC0R,EAAK,EACdrW,KAAKO,OAAOmE,MAAMC,KAAK,mBAAmB,GACjC2R,EAAK,EACdtW,KAAKO,OAAOmE,MAAMC,KAAK,kBAAkB,GAChC2R,EAAK,EACdtW,KAAKO,OAAOmE,MAAMC,KAAK,mBAAmB,IAE1C3E,KAAKO,OAAOmE,MAAME,OAGduR,EAAavW,EAAI,EAAGI,KAAKO,OAAO8D,WAAW,QAAS,aAC/C8R,EAAavW,EAAI,EAAGI,KAAKO,OAAO8D,WAAW,QAAS,cACpD8R,EAAatW,EAAI,EAAGG,KAAKO,OAAO8D,WAAW,QAAS,aACpD8R,EAAatW,EAAI,GAAGG,KAAKO,OAAO8D,WAAW,QAAS,eAG3D+I,EAAO4I,YACT5I,EAAO4I,WAAW/R,OAAO7B,EAAMC,EAAOmD,GAGxCxF,KAAKoF,WAAWnB,OAAO7B,EAAMC,IAQ1B,SAASsU,GAAW,iBACvBpH,EAAgB,cAAEC,EAAa,WAAEwG,EAAU,QAAEvG,EAAO,iBACpDM,EAAgB,UAAEQ,IACpBnD,EAAS,CACPwJ,KAAM5I,OAAO6I,KACblI,MAAOhB,EACPiB,OAAQf,EACRiJ,OAAQ,iBACRtW,QAAS,CACPuW,QAAS,SACTC,OAAQ,CACNC,QAAS,CAAEpX,EAAG,KAGlBmE,MAAO,CACLvF,KAAMuP,OAAOkJ,MAAMC,OACnBxI,MAAO,OACPC,OAAQ,QAEVlP,MAAO,CAACqO,EAAYuB,GACpBQ,gBAAiB,CACfC,oBAEFR,mBACAC,gBACAwG,aACAvG,UACAc,aAGF,MAAMlC,EAAO,IAAIL,OAAOoJ,KAAKhK,GAgB7B,OAfAiB,EAAKgJ,gBAAkB,KACrB,MAAMC,EAAO,IAAI,IACjBA,EAAKpH,OACL9C,EAAO4I,WAAasB,EACpBA,EAAKC,eAAe,IAAsBpZ,IAAI,gBAC9C,IAAsB4M,OAAO,cAAe,KAC1CuM,EAAKC,eAAe,IAAsBpZ,IAAI,kBAGhD,IAAkBmM,OADC,2BACkB,QACrCrC,EAAG,iBAAkB4H,QAEvBxB,EAAKmJ,YAAelW,IAClB8L,EAAO4I,WAAWwB,YAAYlW,IAEzB+M,I,6BC7oBT,uNAuBA,MAAMoJ,EACJ,YAAY9X,EAAIqG,EAAOC,EAAayR,EAAQvM,GAC1CnL,KAAKL,GAAKA,EACVK,KAAKgG,MAAQA,EACbhG,KAAKiG,YAAcA,EACnBjG,KAAK0X,OAASA,EACd1X,KAAKmL,UAAYA,EACjBnL,KAAKoJ,MAAQ,GAGf,QAAQrD,GACN/F,KAAKoJ,MAAMrD,EAAYpG,IAAMoG,EAG/B,aAAa4R,GACX,IAAK,MAAMra,KAAKqa,EAAQ,CACtB,MAAMC,EAAOD,EAAOra,GAEpB,IAAIuB,EACAgZ,EAOJ,GATAvS,QAAQQ,IAAI,cAAe8R,GAGN,iBAAX,EACR/Y,EAAM+Y,EACoB,iBAAX,IACf/Y,EAAM+Y,EAAe,SACrBC,EAAgBD,EAAY,QAEzB,IAAsBpL,IAAI3N,GAAM,OAAO,EAC5C,IAAKgZ,EAAe,SAEpB,GADoB,IAAsB1Z,IAAIU,KAC1BgZ,EAAe,OAAO,EAE5C,OAAO,EAGT,UAEE,GADAvS,QAAQQ,IAAI,0BAA0B9F,KAAKL,GAAMK,KAAK0X,SACjD1X,KAAK0X,QAAiC,IAAvB1X,KAAK0X,OAAOlV,OAAc,OAAO,EAErD,IAAK,MAAMsC,KAAO9E,KAAK0X,OAAQ,CAC7B,IAAIC,EAAS3X,KAAK0X,OAAO5S,GAMzB,GALM6S,aAAkBG,QACtBH,EAAS,CAACA,IAGZrS,QAAQQ,IAAI6R,GACR3X,KAAK+X,aAAaJ,GAEpB,OADArS,QAAQQ,IAAO9F,KAAKL,GAAR,eACL,EAGX,OAAO,EAGT,gBAAgBqL,EAAWgN,GACzB,MAAMhS,EAAQgS,EAAY,OAAK,kBACzB/R,EAAc+R,EAAkB,aAAK,iBACrC7M,EAAY6M,EAAgB,WAAK,SACjCN,GAAUM,EAAa,QAAK,IAAIC,OAAOra,GACzB,iBAAR,GAAoBA,aAAasa,SAGzB,iBAAR,IACV5S,QAAQ0E,KAAQpM,EAAH,mCACN,KAGHmL,EAAU,IAAI0O,EAClBzM,EAAWhF,EAAOC,EAAayR,EAAQvM,GAEzC,IAAK,MAAMgN,KAAUH,EAAY,MAAG,CAClC,MAAMtN,EAAO0N,EAAYC,SAASF,EAAQH,EAAY,MAAEG,GAASpP,GACjEA,EAAQuP,QAAQ5N,GAElB,OAAO3B,GA2BX,MAAMqP,EACJ,aAAY,GACVzY,EAAE,MAAEqG,EAAK,YAAEC,EAAW,SAAEkD,EAAQ,MAAEI,EAAK,WAAEgB,EAAU,OAAE1E,EAAM,QAAEkD,EAAO,OACpEuB,IAEAtK,KAAKL,GAAKA,EACVK,KAAKgG,MAAQA,GAAS,eACtBhG,KAAKiG,YAAcA,GAAe,MAClCjG,KAAKmJ,SAAWA,EAChBnJ,KAAKuJ,MAAQA,EACbvJ,KAAKuK,WAAaA,EAClBvK,KAAK6F,OAASA,EACd7F,KAAK+I,QAAUA,EACf/I,KAAKsK,OAASA,EAGhB,gBAAgB6N,EAAQH,EAAMjP,GAC5B,MAAMnL,EAAI,CAAC+B,GAAIwY,EAAQpP,QAASA,KAAYiP,GACtCjS,EAAc,IAAIqS,EAAYxa,GAE9BiI,EAAS0S,EAAOF,SAASL,EAAa,QAAK,GAAIjS,GAErD,OADAA,EAAYF,OAASA,EACdE,GAoBX,MAAMwS,EACJ,YAAYxS,GACV/F,KAAK+F,YAAcA,EACnB/F,KAAKwY,YAAc,GACnBxY,KAAKyY,YAAc,GAGrB,cAAcC,GACZ1Y,KAAKwY,YAAY9W,KAAKgX,QACAlX,IAAlBkX,EAAW/Y,KACbK,KAAKyY,YAAYC,EAAW/Y,IAAMK,KAAKwY,YAAYhW,OAAS,GAIhE,cACE,OAAO,IAAImW,EAAe3Y,KAAMA,KAAK+F,YAAYoD,UAGnD,gBAAgByP,EAAM7S,GACpB,MAAMF,EAAS,IAAI0S,EAAOxS,GAC1B,IAAK,MAAMiS,KAAQY,EAAM,CACvB,MAAMF,EAAaG,EAAWR,SAASL,GACvCnS,EAAOiT,cAAcJ,GAEvB,OAAO7S,GAKX,MAAM8S,EACJ,YAAY9S,EAAQsD,GAClBnJ,KAAK6F,OAASA,EACd7F,KAAK+Y,aAAe,EACpB/Y,KAAKmJ,SAAWA,EAGlB,uBACE,MAAM1C,EAAOzG,KAAK6F,OAAO2S,YAAYxY,KAAK+Y,cAE1C,OADItS,GAAQA,EAAK0C,WAAUnJ,KAAKmJ,SAAW1C,EAAK0C,UACzC1C,EAGT,eAAeuS,GACb,MAAMN,EAAa1Y,KAAK6F,OAAO2S,YAAYxY,KAAK+Y,cAChD,IAAIE,EAAYjZ,KAAK+Y,aAAe,EAKpC,QAJ4BvX,IAAxBkX,EAAWQ,WACbD,EAAYjZ,KAAK6F,OAAO4S,YAAYC,EAAWQ,WAG7CR,aAAsBS,SACT3X,IAAXwX,IACF1T,QAAQ0E,KAAK,4FAEbgP,EAAS,QAGiCxX,IAAxCkX,EAAWrR,QAAQ2R,GAAQE,UAAwB,CACrD,MAAMA,EAAWR,EAAWrR,QAAQ2R,GAAQE,SAC5CD,EAAYjZ,KAAK6F,OAAO4S,YAAYS,GASxC,GALIR,aAAsBU,GACpBV,EAAWW,UACb,IAAsBxQ,aAAa6P,EAAWW,SAAUL,GAGxDN,aAAsBS,EAAkB,CAC1C,MAAM5a,EAAQma,EAAWrR,QAAQ2R,GAAQza,OAASya,EAC9CN,EAAWW,WACb,IAAsBxQ,aAAa6P,EAAWW,SAAU9a,GACxD,IAAsBuK,SAAS,iBAAiB4P,EAAWW,WAO/D,OAHA/T,QAAQ6E,KACJ,GAAGnK,KAAK6F,OAAOE,YAAYpG,wBAAwBsZ,KACvDjZ,KAAK+Y,aAAeE,EACbjZ,KAAK0G,wBAWhB,MAAMmS,EACJ,YAAYhb,GAAO8B,GAAIA,EAAIuZ,SAAUA,IACnClZ,KAAKnC,KAAOA,EACZmC,KAAKL,GAAKA,EACVK,KAAKkZ,SAAWA,EAGlB,gBAAgBlB,GACd,MAAMna,EAAOma,EAAW,MAAK,WACvBpB,EAAOoB,EAAW,MAAK,OAE7B,OAAQpB,GACN,IAAK,OACH,OAAO,IAAI0C,EAAezb,EAAMma,GAClC,IAAK,eACH,OAAO,IAAImB,EAAiBtb,EAAMma,GACpC,IAAK,aACH,OAAO,IAAIoB,EAAiBvb,EAAMma,GACpC,IAAK,UACH,OAAO,IAAIuB,EAAkB1b,EAAMma,GACrC,IAAK,SACH,OAAO,IAAIwB,EAAiB3b,EAAMma,GACpC,QAEE,OADA1S,QAAQ0E,KAAK,0BAA2B4M,GACjC,IAAI0C,EAAezb,EAAMma,KAcjC,MAAMsB,UAAuBT,EAClC,YAAYhb,GACV8B,GAAIA,EACJuZ,SAAUA,EACVlS,KAAMA,IACNhE,MAAMnF,EAAM,CAAC8B,KAAIuZ,kBAEJ1X,IAATwF,IACF1B,QAAQ0E,KAAK,mDACbhD,EAAO,OAEThH,KAAKgH,KAAOA,GAeT,MAAMmS,UAAyBN,EACpC,YAAYhb,GACV8B,GAAIA,EACJuZ,SAAUA,EACV/R,SAAUA,EACVE,QAASA,EACTgS,SAAUA,IAEVrW,MAAMnF,EAAM,CAAC8B,KAAIuZ,kBACA1X,IAAb2F,IACF7B,QAAQ0E,KAAK,wBACb7C,EAAW,4BAEbnH,KAAKmH,SAAWA,OAEA3F,IAAZ6F,GAA0BA,IAC5B/B,QAAQ0E,KAAK,uBACb3C,EAAU,CACR,CAACvG,KAAM,QAGXd,KAAKqH,QAAUA,EACfrH,KAAKqZ,SAAWA,GAYb,MAAMD,UAAyBP,EACpC,YAAYhb,GACV8B,GAAIA,EACJuZ,SAAUA,EACV/R,SAAUA,EACVkS,SAAUA,IACVrW,MAAMnF,EAAM,CAAC8B,KAAIuZ,kBACA1X,IAAb2F,IACF7B,QAAQ0E,KAAK,wBACb7C,EAAW,8BAEbnH,KAAKmH,SAAWA,EAChBnH,KAAKqZ,SAAWA,GAIb,MAAME,UAA0BV,EACrC,YAAYhb,GACV8B,GAAIA,EACJuZ,SAAUA,EACV5X,QAASA,IACT0B,MAAMnF,EAAM,CAAC8B,KAAIuZ,kBACD1X,IAAZF,IACFgE,QAAQ0E,KAAK,uBACb1I,EAAU,WAEZtB,KAAKsB,QAAUA,GAIZ,MAAMkY,UAAyBX,EACpC,YAAYhb,GACV8B,GAAIA,EACJuZ,SAAUA,EACV9Q,IAAKA,EACLnB,SAAUA,EACVkB,MAAOA,IACPnF,MAAMnF,EAAM,CAAC8B,KAAIuZ,aAEjBlZ,KAAKoI,IAAMA,EACXpI,KAAKiH,SAAWA,EAChBjH,KAAKmI,MAAQA,GAoBVsR,eAAeC,EAAcC,GAClC,MAAMzN,QAAiBC,MAAM,gBAAgBwN,GAG7C,OApBK,SAAiCnO,GACtC,MAAMoO,EAAWpO,EAAc,SACzBqO,EAAiB,GACvB,IAAKD,EAEH,OADAtU,QAAQ6E,KAAK,sBACN0P,EAGT,IAAK,MAAM7O,KAAa4O,EAAU,CAChC,MAAME,EAAcF,EAAS5O,GAC7B6O,EAAe7O,GAAayM,EAAQY,SAASrN,EAAW8O,GAG1D,OADAxU,QAAQyU,MAAMF,GACPA,EAOAG,OAFW9N,EAASI,U,iBC7Z5B,SAAUlB,EAAQ6O,GACf,IAAIrQ,EAAI,CACJsQ,QAAS,SACTC,MAAO,GACPC,KAAM,GAGNC,QAAS,SAASC,EAAKvc,GACnB,IAAK,IAAIqB,KAAKkb,EACLvc,EAAEoB,eAAeC,IAClBpB,OAAOC,eAAeF,EAAGqB,EAAGpB,OAAOuc,yBAAyBD,EAAKlb,IAGzE,OAAOrB,GAEXyc,UAAW,SAAS5c,GAChB,YAAa4D,IAAN5D,GAAgC,mBAANA,EAAmBA,EAAE,GAAK6c,KAAKD,UAAU5c,IAE9E8c,MAAO,SAASrb,EAAGqM,GAEf,IAAK,OAAO+O,KAAKC,MAAMrb,EAAEqM,GAAI9B,EAAE+Q,QAAU,MAAM5S,GAAI,OAAO1I,IAI9DqM,GAAI,SAAS7N,EAAM6N,GAEf,IAAK,IAAI4O,KADT1Q,EAAEgR,SAAS/c,GAAQ6N,EACH9B,EAAEwQ,KACdxQ,EAAEwQ,KAAKE,GAAKzc,GAAQ6N,GAG5BvN,IAAK,SAAS0c,EAAMhc,GAAM,OAAOgc,EAAKC,QAAQjc,IAC9C8M,IAAK,SAASkP,EAAMhc,EAAKkc,GAASF,EAAKG,QAAQnc,EAAKkc,IACpD/R,OAAQ,SAAS6R,EAAMhc,GAAMgc,EAAKI,WAAWpc,IAC7CA,IAAK,SAASgc,EAAMvd,GAAI,OAAOud,EAAKhc,IAAIvB,IACxCkF,OAAQ,SAASqY,GAAO,OAAOA,EAAKrY,QACpC0Y,MAAO,SAASL,GAAOA,EAAKK,SAG5BC,MAAO,SAASxb,EAAIkb,EAAM/O,GACtB,IAAIsP,EAAQxR,EAAEyQ,QAAQzQ,EAAEgR,UAAU,SAAS/b,EAAKwN,EAAMgP,GAClD,OAAyB,IAArBC,UAAU9Y,OAAsB4Y,EAAMG,SACtB,mBAATlP,EAA6B+O,EAAMI,SAAS3c,EAAKwN,EAAMgP,QACrD7Z,IAAT6K,EAA4B+O,EAAMzP,IAAI9M,EAAKwN,EAAMgP,GAClC,iBAARxc,GAAmC,iBAARA,EAA0Buc,EAAMjd,IAAIU,GACvD,mBAARA,EAA4Buc,EAAMK,KAAK5c,GAC7CA,EACEuc,EAAMM,OAAO7c,EAAKwN,GADP+O,EAAMF,WAG5BE,EAAMO,IAAMhc,EACZ,IAEIkb,EAAKG,QADS,gBACQ,MACtBI,EAAMQ,MAAQf,EACdA,EAAKI,WAHS,iBAIhB,MAAOlT,GACLqT,EAAMQ,MAAQhS,EAAEiS,QAAQ,QAS5B,OAPAT,EAAMU,IAAMhQ,GAAa,GACpBlC,EAAEuQ,MAAMxa,KACTiK,EAAEuQ,MAAMxa,GAAMyb,EAAMQ,OAEnBhS,EAAEwQ,KAAKgB,EAAMU,IAAIV,EAAMO,OACxB/R,EAAEwQ,KAAKgB,EAAMU,IAAIV,EAAMO,KAAOP,GAE3BA,GAEXR,SAAU,CAENC,KAAM,SAASlb,EAAIkb,GACf,IAAIO,EAAQpb,KAAKL,GAKjB,OAJKyb,GAAUA,EAAMP,OACjBO,EAAQxR,EAAEuR,MAAMxb,EAAIkb,EAAM7a,KAAK8b,KAC1B9b,KAAKL,KAAMK,KAAKL,GAAMyb,IAExBA,GAEXtP,UAAW,SAASA,EAAWiQ,GAC3B,IAAKjQ,EACD,OAAO9L,KAAK8b,IAAM9b,KAAK8b,IAAIE,UAAU,EAAEhc,KAAK8b,IAAItZ,OAAO,GAAK,GAEhE,IAAI7D,EAAKmN,EAAWsP,EAAQpb,KAAKrB,GACjC,KAAKyc,GAAUA,EAAMtP,YACjBsP,EAAQxR,EAAEuR,MAAMnb,KAAK2b,IAAK3b,KAAK4b,MAAO5b,KAAK8b,IAAInd,EAAG,KAC7CqB,KAAKrB,KAAMqB,KAAKrB,GAAMyc,GACtBW,IACD,IAAK,IAAIle,KAAQ+L,EAAEuQ,MACfiB,EAAMP,KAAKhd,EAAM+L,EAAEuQ,MAAMtc,IAIrC,OAAOud,GAEXa,OAAQ,WAAY,MAA2B,SAApBjc,KAAK4b,MAAM/d,MACtCqe,SAAU,WACN,MAAO,SAASlc,KAAK8b,IAAI,IAAI9b,KAAK8L,YAAY,IAAI,IAAI9L,KAAK2b,IAAI,KAInEnP,IAAK,SAAS3N,GACV,OAAImB,KAAK4b,MAAMpP,IACJxM,KAAK4b,MAAMpP,IAAIxM,KAAKmc,IAAItd,OAEzBmB,KAAKmc,IAAItd,KAAQmB,KAAK4b,QAEpCvT,KAAM,WAAY,OAAOrI,KAAKoc,OAAO5Z,QACrCiZ,KAAM,SAAS/P,EAAI1K,GACf,IAAK,IAAI1D,EAAE,EAAGI,EAAEkM,EAAEpH,OAAOxC,KAAK4b,OAAQte,EAAEI,EAAGJ,IAAK,CAC5C,IAAIuB,EAAMmB,KAAKqc,KAAKzS,EAAE/K,IAAImB,KAAK4b,MAAOte,IACtC,QAAYkE,IAAR3C,IACgD,IAA5C6M,EAAGjO,KAAKuC,KAAMnB,EAAKmB,KAAK7B,IAAIU,GAAMmC,GAClC,MAGJtD,EAAIkM,EAAEpH,OAAOxC,KAAK4b,SAAUle,IAAKJ,KAEzC,OAAO0D,GAAQhB,MAEnBoc,KAAM,SAASE,GACX,OAAOtc,KAAKyb,MAAK,SAASc,EAAGC,EAAG5D,GAAOA,EAAKlX,KAAK6a,KAAOD,GAAY,KAExEne,IAAK,SAASU,EAAK4d,GACf,IACI/Q,EADArM,EAAIuK,EAAEzL,IAAI6B,KAAK4b,MAAO5b,KAAKmc,IAAItd,IAMnC,MAJmB,mBAAR4d,IACP/Q,EAAK+Q,EACLA,EAAM,MAEG,OAANpd,EAAauK,EAAE8Q,MAAMrb,EAAGqM,GACpB,MAAP+Q,EAAcA,EAAMpd,GAE5Bkc,OAAQ,SAASmB,GACb,OAAO1c,KAAKyb,MAAK,SAASc,EAAGC,EAAGG,GAAMA,EAAIJ,GAAKC,IAAME,GAAW,KAEpElB,SAAU,SAAS3c,EAAK6M,EAAI+Q,GACxB,IAAIG,EAAM5c,KAAK7B,IAAIU,EAAK4d,GACpBI,EAAMnR,EAAGkR,GAEb,OADA5c,KAAK2L,IAAI9M,OAAa2C,IAARqb,EAAoBD,EAAMC,GACjC7c,MAEX2L,IAAK,SAAS9M,EAAKwN,EAAMgP,GACrB,IAAIzd,EAAIoC,KAAK7B,IAAIU,GACjB,OAAS,MAALjB,IAA2B,IAAdyd,EACNhP,EAEJzC,EAAE+B,IAAI3L,KAAK4b,MAAO5b,KAAKmc,IAAItd,GAAM+K,EAAE4Q,UAAUnO,GAAOgP,IAAczd,GAE7E8d,OAAQ,SAASrP,EAAMgP,GACnB,IAAIyB,EAASF,EACb,IAAK,IAAI/d,KAAOwN,EACZuQ,EAAMvQ,EAAKxN,GACPmB,KAAK2L,IAAI9M,EAAK+d,EAAKvB,KAAeuB,IAClCE,GAAU,GAGlB,OAAOA,GAEXrc,IAAK,SAAS5B,EAAKwN,GACf,IAAIzO,EAAIoC,KAAK7B,IAAIU,GACjB,GAAIjB,aAAaka,MACbzL,EAAOzO,EAAEmf,OAAO1Q,QACb,GAAU,OAANzO,EAAY,CACnB,IAAIgZ,SAAchZ,EAClB,GAAIgZ,WAAgBvK,GAAiB,WAATuK,EAAmB,CAC3C,IAAK,IAAI2F,KAAKlQ,EACVzO,EAAE2e,GAAKlQ,EAAKkQ,GAEhBlQ,EAAOzO,OAEPyO,EAAOzO,EAAIyO,EAInB,OADAzC,EAAE+B,IAAI3L,KAAK4b,MAAO5b,KAAKmc,IAAItd,GAAM+K,EAAE4Q,UAAUnO,IACtCA,GAEXrD,OAAQ,SAASnK,EAAK4d,GAClB,IAAI7e,EAAIoC,KAAK7B,IAAIU,EAAK4d,GAEtB,OADA7S,EAAEZ,OAAOhJ,KAAK4b,MAAO5b,KAAKmc,IAAItd,IACvBjB,GAEXsd,MAAO,WAMH,OALKlb,KAAK8b,IAGN9b,KAAKyb,MAAK,SAASc,GAAI3S,EAAEZ,OAAOhJ,KAAK4b,MAAO5b,KAAKmc,IAAII,MAAQ,GAF7D3S,EAAEsR,MAAMlb,KAAK4b,OAIV5b,MAEXgQ,SAAU,WACN,IAAI6K,EAAO7a,KAAK4b,MAChB,IAAK,IAAIjc,KAAMiK,EAAEuQ,MACTvQ,EAAEuQ,MAAMhb,eAAeQ,KACvBK,KAAK4b,MAAQhS,EAAEuQ,MAAMxa,GACrBK,KAAKkb,SAIb,OADAlb,KAAK4b,MAAQf,EACN7a,MAIXmc,IAAK,SAASI,GAEV,MADiB,iBAANA,IAAiBA,EAAI3S,EAAE4Q,UAAU+B,IACrCvc,KAAK8b,IAAM9b,KAAK8b,IAAMS,EAAIA,GAErCF,KAAM,SAASE,GACX,OAAOvc,KAAK8b,IACRS,GAA6B,IAAxBA,EAAES,QAAQhd,KAAK8b,KAChBS,EAAEP,UAAUhc,KAAK8b,IAAItZ,aACrBhB,EACJ+a,IAGZV,QAAS,SAAShe,GACd,OAAO+L,EAAEyQ,QAAQzQ,EAAEqT,WAAY,CAAEC,MAAO,GAAIrf,KAAMA,KAEtDof,WAAY,CACRza,OAAQ,EACRgK,IAAK,SAAS+P,GAAI,OAAOvc,KAAKkd,MAAM/d,eAAeod,IACnD1d,IAAK,SAASvB,GACV,IAAIK,EAAI,EACR,IAAK,IAAI4e,KAAKvc,KAAKkd,MACf,GAAIld,KAAKwM,IAAI+P,IAAMjf,IAAMK,IACrB,OAAO4e,GAInBvB,QAAS,SAASuB,EAAGC,GACZxc,KAAKwM,IAAI+P,IACVvc,KAAKwC,SAETxC,KAAKkd,MAAMX,GAAKC,GAEpBvB,WAAY,SAASsB,GACbvc,KAAKwM,IAAI+P,YACFvc,KAAKkd,MAAMX,GAClBvc,KAAKwC,WAGbsY,QAAS,SAASyB,GAAI,OAAOvc,KAAKwM,IAAI+P,GAAKvc,KAAKkd,MAAMX,GAAK,MAC3DrB,MAAO,WAAY,IAAK,IAAIqB,KAAKvc,KAAKkd,MAAQld,KAAKib,WAAWsB,MAIlEnB,EAEAxR,EAAEuR,MAAM,QAAS,WAAY,IAAK,OAAOgC,aAAe,MAAMpV,KAA7C,IACrBqT,EAAMgC,MAAQhC,EACdA,EAAMxR,EAAIA,EAEVwR,EAAMP,KAAK,UAAW,WAAY,IAAK,OAAOwC,eAAiB,MAAMtV,KAA/C,IACtBqT,EAAMP,KAAK,OAAQjR,EAAEiS,QAAQ,SAEP,mBAAX5B,QAAwCzY,IAAfyY,EAAOqD,IACvCrD,EAAO,SAAU,IAAI,WACjB,OAAOmB,KAE6B/d,EAAOD,QAC/CC,EAAOD,QAAUge,GAGbhQ,EAAOgQ,QAAQxR,EAAE2T,SAAWnS,EAAOgQ,OACvChQ,EAAOgQ,MAAQA,GArQtB,CAwQEpb,KAAMA,MAAQA,KAAKia,S,6BC1QtB,6CAEA,MAAMuD,EAAe,CACnBC,oBAAoB,EAGpBC,0BAA2B,mCAG3BC,8BAA8B,EAI9BC,4BAA6B,CAAC,SAAU,UAGxCC,kCAAmC,MAGnCC,+BAA+B,GAG3BC,EAAkB,WAEpBC,YAAYC,YAAYD,YAAYE,UAAUC,OAC9C,IAAIC,GAAc,EAClB,MAAO,KACDA,IACJJ,YAAY9N,KAAKsN,GACjBY,GAAc,IAPI,GAiBjB,MAAMC,EACX,cACEre,KAAKgW,WAAa,KAClBhW,KAAKse,KAAO,KACZte,KAAKue,sBAAwB,EAC7Bve,KAAKwe,4BAA8B,EACnCxe,KAAKye,mBAAqB,GAC1Bze,KAAK0e,aAAe,MAGtB,OAGE,GAFAX,IAEI/d,KAAK2e,WAEP,OAiBF3e,KAAKgW,WAAa,IAAIgI,YAAYK,gBAAgB,KAAM,KAdxC,CACdO,MAAO,CACLC,OAAQ,sBACRC,IAAK,iCACLC,MAAO,6BAETC,mBAAoB,4CACpBC,KAAM,iDACNC,UAAW,2CAGXC,WAAY,+BAMd,MAAMC,EAAiB,KACrBpf,KAAKgW,WAAWqJ,oBACdrB,YAAYsB,OAAOtJ,WAAWuJ,uBAC9B,IAAMvf,KAAKwf,uBACbxf,KAAKgW,WAAWqJ,oBACdrB,YAAYsB,OAAOtJ,WAAWyJ,kBAC9B,IAAMzf,KAAK0f,sBACb1f,KAAKgW,WAAWqJ,oBACdrB,YAAYsB,OAAOtJ,WAAW2J,wBAC9BP,IAGJpf,KAAKgW,WAAW4J,iBACd5B,YAAYsB,OAAOtJ,WAAWuJ,uBAC9B,IAAMvf,KAAKwf,uBACbxf,KAAKgW,WAAW4J,iBACd5B,YAAYsB,OAAOtJ,WAAWyJ,kBAC9B,IAAMzf,KAAK0f,sBACb1f,KAAKgW,WAAW4J,iBACZ5B,YAAYsB,OAAOtJ,WAAW2J,wBAC9BP,GAEJpf,KAAKgW,WAAW6J,UAGlB,aACM7f,KAAKgW,aACPhW,KAAKgW,WAAW8J,aAChB9f,KAAKgW,WAAa,MAItB,sBACEhW,KAAK+f,sBAGP,qBACEza,QAAQQ,IAAI,iCAGd,sBAIE,GADAR,QAAQQ,IAAI,WADG,OAEX9F,KAAKse,KACP,OAAOte,KAAKse,KAEd,MAAM0B,EAAc,CAClBC,kBAAmB,YACnBC,OAAQ,2BAYV,OATAlgB,KAAKse,KAAOte,KAAKgW,WAAWmK,oBAVb,MAUyCH,GAExDhgB,KAAKse,KAAK/G,eAAevX,KAAK0e,cAC9B1e,KAAKse,KAAKvP,GACRiP,YAAYsB,OAAOc,WAAWC,kBAC9B,KAAQrgB,KAAKsgB,uBAEftgB,KAAKse,KAAKiC,OAEHvgB,KAAKse,KAGd,4BAA4BkC,GAC1B,MAAMze,GAAM,IAAKC,MAAQC,UAEzB,KAAIF,EAAM/B,KAAKue,uBADE,OAIjBjZ,QAAQ6E,KAAK,mCAAoCqW,GACjDxgB,KAAKue,sBAAwBxc,EACzB/B,KAAKse,MACP,IAAK,MAAMzf,KAAO2hB,EACX3hB,KAAOmB,KAAKye,oBACbze,KAAKye,mBAAmB5f,KAAS2hB,EAAW3hB,KAGhDmB,KAAKse,KAAKmC,4BAA4B5hB,EAAK2hB,EAAW3hB,IACtDmB,KAAKye,mBAAmB5f,GAAO2hB,EAAW3hB,IAKhD,eAAehB,GACbmC,KAAK0e,aAAe7gB,EAChBmC,KAAKse,MACPte,KAAKse,KAAK/G,eAAe1Z,GAQ7B,aACMmC,KAAKse,OACPte,KAAKse,KAAKoC,QACV1gB,KAAKse,KAAO,MAEVte,KAAKgW,aACPhW,KAAKgW,WAAW8J,aAChB9f,KAAKgW,WAAa,MAItB,mBACE,IAAKhW,KAAKse,OAASte,KAAKgW,WAAY,OAEpC,MAAM2K,EAAe3gB,KAAKse,KAAKqC,aAE/B,IAAK,MAAMhhB,KAAMghB,EAAc,CAC7B,MAAMC,EAAOD,EAAahhB,GAE1B2F,QAAQQ,IAAI,cAAenG,EAAIihB,GAElB,IAAgBha,QAAQjH,GAEnC2F,QAAQQ,IAAI,QAAQnG,2BAItB,IAAgBkhB,mBACdlhB,EACAihB,EAAKE,iBACL7gB,OAAO2gB,EAAKG,YAAY,SACxB9gB,OAAO2gB,EAAKG,YAAY,QACxBH,EAAKG,YAAY,WACjBH,EAAKG,YAAY,UAIrB,IAAK,MAAMphB,KAAM,IAAgB0F,MAAO,CACzB,IAAgBA,MAAM1F,aACf,MACZA,KAAMghB,UACH,IAAgBtb,MAAM1F,KAMrC,qBAGEK,KAAKghB,mBAELhhB,KAAKse,KAAKvP,GACRiP,YAAYsB,OAAOc,WAAWa,YAC9B,CAACthB,EAAIihB,KAIHtb,QAAQQ,IAAI,cAAe8a,GAC3B,IAAgBC,mBACdlhB,EACAihB,EAAKE,iBACL,EAAG,EACHF,EAAKG,YAAY,WACjBH,EAAKG,YAAY,YAIvB/gB,KAAKse,KAAKvP,GACRiP,YAAYsB,OAAOc,WAAWc,iBAC9B,CAACvhB,EAAImB,EAAMsD,KAQT,IAAIoB,EAPJF,QAAQQ,IAAI,qBAAsB,CAACnG,KAAImB,OAAMsD,mBAC3B5C,IAAd4C,EACFA,GAAY,IAAKpC,MAAQC,WACM,iBAAhB,GACNmC,aAAqB8T,UAC9B9T,EAAY,IAAKpC,KAAKoC,GAAYnC,WAIlCuD,EADE7F,IAAOK,KAAKse,KAAK6C,WACZ,IAAgBva,QAAQ,UAExB,IAAgBA,QAAQjH,GAE7B6F,GAAMA,EAAK3D,WAAWf,EAAMsD,EAAY,OAGhDpE,KAAKse,KAAKvP,GACRiP,YAAYsB,OAAOc,WAAWgB,UAC7BzhB,IACC,IAAgB0hB,WAAW1hB,KAG/BK,KAAKse,KAAKvP,GACRiP,YAAYsB,OAAOc,WAAWkB,6BAC9B,CAACV,EAAM/hB,KACL,MAAMc,EAAKihB,EAAKW,QACV/b,EAAO,IAAgBoB,QAAQjH,GACrC,IAAK6F,EACH,OAEF,IAAKxF,KAAKse,OAASte,KAAKgW,WAAY,OACpC,MAAMpW,EAAI4hB,SAASZ,EAAKG,YAAY,SAC9BlhB,EAAI2hB,SAASZ,EAAKG,YAAY,QAC/B9gB,OAAOC,MAAMN,IAAOK,OAAOC,MAAML,KACpC2F,EAAKic,YAAY,IAAK7hB,GACtB4F,EAAKic,YAAY,IAAK5hB,IAGxB,MAAMC,EAAU8gB,EAAKG,YAAY,WAC3BhhB,EAAQ6gB,EAAKG,YAAY,SAC3BjhB,GAAWC,IACVA,IAAUyF,EAAKzF,OAASD,IAAY0F,EAAK1F,WAC5C0F,EAAKic,YAAY,UAAW3hB,GAC5B0F,EAAKic,YAAY,QAAS1hB,MAIhCC,KAAKse,KAAKvP,GACRiP,YAAYsB,OAAOc,WAAWsB,0BAC9B,CAACC,EAAaC,KACZ,GAhQqB,wBAgQjBA,EAAQhL,KAA+B,CACzC,MAAM3X,EAAW2iB,EAAQ3iB,SACnBU,EAAKgiB,EAAYJ,QACjB/b,EAAO,IAAgBoB,QAAQjH,GACrC,IAAK6F,EAAM,OAEX,MAAM5F,EAAIK,OAAOhB,EAASqO,MACpBzN,EAAII,OAAOhB,EAASmW,KAC1B,IAAwB,IAApBnV,OAAOC,MAAMN,KAAoC,IAApBK,OAAOC,MAAML,GAAc,CAC1D,MAAMrB,GAAI,IAAKwD,MAAQC,UAAY,IAC7BmC,EAAYnE,OAAOhB,EAASmF,YAAc5F,EAChDgH,EAAKic,YAAY,WAAY,CAAC7hB,IAAGC,IAAGrB,IAAG4F,cAGzCoB,EAAKic,YACH,UAAW,CAAC3hB,QAASb,EAASa,QAASC,MAAOd,EAASc,WAM/DC,KAAKse,KAAKvP,GACRiP,YAAYsB,OAAOc,WAAWyB,qBAC9B,CAACliB,EAAI9B,KACH,MAAM2H,EAAO,IAAgBoB,QAAQjH,GAChC6F,GACLA,EAAKic,YAAY,OAAQ5jB,KAI/B,YAAYyD,GACVtB,KAAKse,KAAKwD,gBAAgBxgB,GAG5B,uBAAuBrC,GACrB,IAAKe,KAAKse,KAAM,OAEhB,MAAMvc,GAAM,IAAKC,MAAQC,UAEzB,KAAIF,EAAM/B,KAAKwe,6BADE,KACjB,CACAxe,KAAKwe,4BAA8Bzc,EACnC,IACE/B,KAAKse,KAAKyD,yBACR,CAACnL,KA3SoB,sBA2SQ3X,SAAU,CAAEmF,UAAWrC,KAAQ9C,KAC9D,MAAOsG,MAMX,OAAOnD,EAAMC,EAAOmD,GAOlBxF,KAAKgiB,uBAAuB,CACxB1U,KAAM9H,EAAKjF,OAAOX,EAClBwV,IAAK5P,EAAKjF,OAAOV,EACjBC,QAAS0F,EAAKjF,OAAOT,QAAQjB,IAC7BkB,MAAOyF,EAAKjF,OAAOR,MAAMlC,U,gCC/VjC,2EAIO,MAAMmY,EAAa,IAAI,IAC9B5K,OAAO4K,WAAaA,EAOpB,MAAM3H,EAAO,IAAyB,CACpCkB,iBAAkB,sBAClBC,cAAe,oBACfwG,aACAjG,iBATF,WACEzK,QAAQQ,IAAI,aACZkQ,EAAW9F,UAUb,IAAsBnF,OAAO,cAAe,KAC1CiL,EAAWuB,eAAe,IAAsBpZ,IAAI,kBAGtD8J,EAAG,kBAAmBga,UAAU,CAC9BrjB,OAAQ,WAINqJ,EAAEjI,MAAM8V,IAAI,CACVV,IAAKnN,EAAEjI,MAAMkV,WAAWE,IACxB9H,KAAMrF,EAAEjI,MAAMkV,WAAW5H,KACzB4U,OAAQ,OACR1U,MAAO,YAKbvF,EAAG,iBAAkBC,MAAM,KACzB,MAAMia,EAAcla,EAAE,iBACtB,IAAIma,GAAW/T,EAAK+B,MAAMiS,KAC1BhU,EAAK+B,MAAM1B,QAAQ0T,GAEnBD,EAAYG,OAERF,EACFD,EAAYrhB,KAAK,MAEjBqhB,EAAYrhB,KAAK,QAGrBmH,EAAG,eAAgBC,MAAM,KACvB,MAAMqa,EAAS9Z,SAASC,eAAe,gBACvCsN,EAAWwB,YAAY+K,EAAOhkB","file":"js/online_event.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 10);\n","import * as Const from './const.js';\nimport * as StoryLine from './story_line.js';\nimport * as DataStore from './data_store.js';\nimport * as PhaserWrapper from './phaser_wrapper.js';\n\nbootbox.setDefaults({\n  closeButton: false,\n});\n\nconst MAX_NUM_MESSAGES = 3;\n\nexport class Char {\n  constructor(scene, id, name, x, y, texture, frame) {\n    this.scene = scene;\n    if (Number.isNaN(x)) x = 0;\n    if (Number.isNaN(y)) y = 0;\n    this.id = id;\n    this.x = x;\n    this.y = y;\n    this._name = name;\n    this.texture = texture;\n    this.frame = frame;\n    this.messages = [];\n    this.messageBox = null;\n\n    this.makeContainer();\n  }\n\n  makeContainer() {\n    // Create a sprite with physics enabled via the physics system. The image\n    // used for the sprite has a bit of whitespace, so I'm using setSize &\n    // setOffset to control the size of the player's body.\n    this.player = this.scene.physics.add.sprite(\n      this.x, this.y, this.texture, this.frame)\n      .setSize(32, 40)\n      .setOffset(0, 24);\n\n    this.player.setDepth(2);\n\n    this.text = this.scene.add.text(this.x, this.y, this.name, {\n      font: '18px monospace',\n      fill: '#fff',\n      align: 'center',\n    }).setOrigin(0.5).setStroke('#000', 3).setDepth(1);\n  }\n\n  get WIDTH() {\n    return 32;\n  }\n\n  get HEIGHT() {\n    return 32;\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  set name(newName) {\n    this._name = newName;\n    this.text.setText(this.name);\n  }\n\n  addMessage(message, expireTime) {\n    if (expireTime === undefined) expireTime = Infinity;\n    if (this.messages.push({message, expireTime}) > MAX_NUM_MESSAGES) {\n      this.messages.shift();\n    }\n  }\n\n  clearMessage() {\n    this.messages = [];\n  }\n\n  showMissionMark(enable) {\n    if (enable) {\n      this.addMessage('!');\n    } else {\n      this.clearMessage();\n    }\n  }\n\n  _removeOutdatedMessage() {\n    const now = (new Date()).getTime();\n    let end = 0;\n    for (const i in this.messages) {\n      if (this.messages[i].expireTime > now) {\n        this.messages[end] = this.messages[i];\n        end++;\n      }\n    }\n    this.messages = this.messages.slice(0, end);\n  }\n\n  update(time, delta) {\n    // this is stupid, but I can't find a better way.\n    this.text.setX(this.player.x);\n    this.text.setY(this.player.y + 45);\n\n    if (this.messages.length > 0) {\n      this._removeOutdatedMessage();\n    }\n\n    if (this.messages.length > 0) {\n      if (!this.messageBox) {\n        this.messageBox = this.scene.add.text(\n          this.player.x, this.player.y - 16,\n          '',\n          {\n            font: '24px monospace',\n            fill: '#000',\n            align: 'center',\n            backgroundColor: 'white',\n          }\n        ).setOrigin(0.5, 1).setDepth(99);\n      }\n      let jointMessage = '';\n      for (const i in this.messages) {\n        jointMessage += this.messages[i].message + '\\n';\n      }\n      this.messageBox.setText(jointMessage.slice(0, -1));\n      this.messageBox.setVisible(true);\n    } else {\n      if (this.messageBox) this.messageBox.setVisible(false);\n    }\n\n    if (this.messageBox) {\n      this.messageBox.setX(this.player.x);\n      this.messageBox.setY(this.player.y - 16);\n    }\n  }\n\n  destroy() {\n    this.player.destroy();\n    this.text.destroy();\n  }\n}\n\nexport class MovingNPC extends Char {\n  constructor(scene, id, name, x, y, texture, frame, movements) {\n    super(scene, id, name, x, y, texture, frame);\n\n    this.points = [];\n    this.points.push({x: x, y: y});\n\n    for (const {dx, dy} of movements) {\n      const px = this.points[this.points.length - 1].x;\n      const py = this.points[this.points.length - 1].y;\n      this.points.push({x: px + dx, y: py + dy});\n    }\n\n    if (this.points.length > 1) {\n      this.nextPoint = 1;\n    }\n  }\n\n  update(time, delta) {\n    const px = this.points[this.nextPoint].x;\n    const py = this.points[this.nextPoint].y;\n    const dest = Math.hypot(px - this.player.x, py - this.player.y);\n    const minGap = Math.max(Const.TILE_SIZE * 0.1, Const.SPEED * delta / 1000);\n\n    if (dest < minGap) {\n      this.player.setVelocity(0);\n      this.player.setX(px);\n      this.player.setY(py);\n\n      this.nextPoint = (this.nextPoint + 1) % this.points.length;\n    } else {\n      this.player.setVelocityX(px - this.x);\n      this.player.setVelocityY(py - this.y);\n      this.player.body.velocity.normalize().scale(Const.SPEED);\n    }\n    this.x = this.player.x;\n    this.y = this.player.y;\n\n    super.update(time, delta);\n  }\n}\n\nexport class RemotePlayer extends Char {\n\n  constructor(scene, id, name, x, y, texture, frame) {\n    super(scene, id, name, x, y, texture, frame);\n\n    // we don't want to be moved to (0, 0) on the next frame.\n    this.ps = [ { x, y, t: 0, timestamp: 0}, {x, y, t: 0, timestamp: 0} ];\n  }\n\n  setProperty(key, value) {\n    switch (key) {\n      case 'texture':\n        const {texture, frame} = value;\n        if (!this.texture) {\n          this.texture = texture;\n          this.frame = frame;\n          this.player.setTexture(texture);\n        }\n        break;\n      case 'frame':\n        // this.frame = value;\n        // this.player.setFrame(value);\n        break;\n      case 'name':\n        this.name = value;\n        break;\n      case 'position':\n        // const {x, y, t} = value;\n        if (this.ps[1].timestamp < value.timestamp) {\n          this.ps = [this.ps[1], value]\n        }\n    }\n  }\n\n  update(time, delta) {\n    // delta ~= 16 (ms), roughly 60 FPS\n    super.update(time, delta);\n\n    const now = (new Date()).getTime();\n\n    if (now > this.ps[1].t) {\n      return;\n    }\n\n    const dx = this.ps[1].x - this.ps[0].x;\n    const dy = this.ps[1].y - this.ps[0].y;\n    const dT = this.ps[1].t - this.ps[0].t;\n\n    if (dT <= 0) return;\n\n    const dt = now - this.ps[0].t;\n    this.player.setX(this.ps[0].x + dx / dT * dt);\n    this.player.setY(this.ps[0].y + dy / dT * dt);\n\n    const faceLR = Math.abs(dx) >= Math.abs(dy);\n    if (faceLR && dx < 0) {\n      this.player.anims.play(\"misa-left-walk\", true);\n    } else if (faceLR && dx > 0) {\n      this.player.anims.play(\"misa-right-walk\", true);\n    } else if (dy < 0) {\n      this.player.anims.play(\"misa-back-walk\", true);\n    } else if (dy > 0) {\n      this.player.anims.play(\"misa-front-walk\", true);\n    } else {\n      this.player.anims.stop();\n      const frameName = this.player.frame.name;\n      const idx = frameName.search('walk');\n      if (idx > 0) {\n        const newFrameName = frameName.substr(0, idx - 1);\n        this.player.setFrame(newFrameName);\n      }\n    }\n  }\n}\n\nexport class CharDaemon {\n  constructor() {\n    this.scene = null;\n    this.chars = {};\n  }\n\n  setScene(scene) {\n    this.scene = scene;\n  }\n\n  create(id, name, x, y, texture, frame) {\n    if (id in this.chars) {\n      console.error(`Character ID \"${id}\" is already declared:`);\n      console.error(this.chars[id]);\n      return;\n    }\n    const char = new Char(\n      this.scene,\n      id, name, x, y, texture, frame);\n\n    this.chars[id] = char;\n    return char;\n  }\n\n  createMovingNPC(id, name, x, y, texture, frame, movements) {\n    if (id in this.chars) {\n      console.error(`Character ID \"${id}\" is already declared:`);\n      console.error(this.chars[id]);\n      return;\n    }\n\n    const char = new MovingNPC(\n      this.scene,\n      id, name, x, y, texture, frame, movements);\n\n    this.chars[id] = char;\n    return char;\n  }\n\n  createRemotePlayer(id, name, x, y, texture, frame) {\n    if (id in this.chars) {\n      console.error(`Character ID \"${id}\" is already declared:`);\n      console.error(this.chars[id]);\n      return;\n    }\n\n    const char = new RemotePlayer(\n      this.scene,\n      id, name, x, y, texture, frame);\n\n    this.chars[id] = char;\n    return char;\n  }\n\n  deleteChar(id) {\n    if (id in this.chars) {\n      this.chars[id].destroy();\n      delete this.chars[id];\n    }\n  }\n\n  getChar(id) {\n    return this.chars[id] || null;\n  }\n\n  update(time, delta) {\n    for (const id in this.chars) {\n      const char = this.chars[id];\n      char.update(time, delta);\n    }\n  }\n}\n\n\nexport class StoryLineDaemon {\n  constructor(dialogDaemon) {\n    this.storyLine = null;\n    this.dialogDaemon = dialogDaemon;\n    this.missionWithDependencies = {};\n\n    DataStore.AnswerStore.listen('*', () => {\n      console.log(this);\n      for (const missionId in this.missionWithDependencies) {\n        const mission = this.storyLine[missionId];\n        if (!mission.isReady()) {\n          continue;\n        }\n        delete this.missionWithDependencies[missionId];\n\n        this._addToDialogDaemon(mission);\n      }\n    });\n  }\n\n  init(storyLine) {\n    this.storyLine = storyLine;\n    for (const missionId in this.storyLine) {\n      const mission = this.storyLine[missionId];\n\n      if (!mission.isReady()) {\n        this.missionWithDependencies[missionId] = mission;\n        continue;\n      }\n\n      this._addToDialogDaemon(mission);\n    }\n    console.log('not enabled missions: ', this.missionWithDependencies);\n  }\n\n  _addToDialogDaemon(mission) {\n      const key = mission.firstStep;\n      const firstStep = mission.steps[key];\n\n      const id = `${mission.id}/${firstStep.id}`;\n      this.dialogDaemon.add(id, firstStep);\n  }\n}\n\nconst _RE_PLAYER = /\\$player/;\n\nexport class DialogDaemon {\n  constructor(charDaemon) {\n    this.charDaemon = charDaemon;\n    this.dialogs = {};\n    this.hasOnGoingDialog = false;\n    this.dialogToTrigger = [];\n  }\n\n  get scene() {\n    return this.charDaemon.scene;\n  }\n\n  showHint() {\n    let message = '';\n    for (const key in this.dialogs) {\n      const dialog = this.dialogs[key];\n      console.log(dialog);\n      message += `<h3>${dialog.dialog.missionStep.title}</h3>`;\n      message += `<p>${dialog.dialog.missionStep.description}</p>`;\n    }\n    if (!message) {\n      message = '沒有任務!';\n    }\n    bootbox.alert({\n      title: '任務列表',\n      message: message,\n    });\n  }\n\n  getDialog(dialogId) {\n    if (dialogId in this.dialogs) {\n      return this.dialogs[dialogId];\n    }\n    return null;\n  }\n\n  showNextDialog(iterator, result = undefined) {\n    this.hasOnGoingDialog = false;\n    const next = iterator.nextDialogItem(result);\n    if (next) {\n      this.showDialog(iterator);\n    } else {\n      this.doneDialog(iterator);\n    }\n  }\n\n  showDialog(iterator) {\n    const item = iterator.getCurrentDialogItem();\n    if (!item) {\n      this.doneDialog(iterator);\n      return;\n    }\n\n    this.hasOnGoingDialog = true;\n    const me = this.charDaemon.getChar('player');\n    const talker = item.name.replace(_RE_PLAYER, me.name);\n\n    console.log('showing iterator: ', iterator);\n    if (item instanceof StoryLine.DialogItemLine) {\n      const content = item.line.replace(_RE_PLAYER, me.name);\n      bootbox.alert({\n        title: talker,\n        message: content,\n        callback: () => {\n          this.showNextDialog(iterator);\n        }\n      });\n    } else if (item instanceof StoryLine.DialogItemSelect) {\n      const question = item.question.replace(_RE_PLAYER, me.name);\n      const inputOptions = [];\n\n      for (const idx in item.choices) {\n        const text = item.choices[idx].text;\n        inputOptions.push({\n          text: text.replace(_RE_PLAYER, me.name),\n          value: idx,\n        });\n      }\n\n      const box = bootbox.prompt({\n        title: talker,\n        message: question,\n        inputType: 'select',\n        onEscape: false,\n        backdrop: true,\n        inputOptions: inputOptions,\n        buttons: {\n          cancel: {\n            label: 'Cancel',\n            className: 'dialog-prompt-cancel',\n          }\n        },\n        callback: result => {\n          if (result === null) {\n            return false;\n          }\n          this.showNextDialog(iterator, result);\n          return true;\n        }\n      });\n      box.keypress(e => {\n        if (e.keyCode === 13) {\n          $('button.bootbox-accept').click();\n        }\n      });\n    } else if (item instanceof StoryLine.DialogItemPrompt) {\n      const question = item.question.replace(_RE_PLAYER, me.name);\n      bootbox.prompt({\n        title: talker,\n        message: question,\n        inputType: 'text',\n        onEscape: false,\n        backdrop: true,\n        buttons: {\n          cancel: {\n            label: 'Cancel',\n            className: 'dialog-prompt-cancel',\n          }\n        },\n        callback: result => {\n          if (!result) {\n            return false;\n          }\n          this.showNextDialog(iterator, result);\n          return true;\n        }\n      });\n    } else if (item instanceof StoryLine.DialogItemMessage) {\n      const message = item.message.replace(_RE_PLAYER, me.name);\n      bootbox.alert({\n        title: \"\",\n        message: message,\n        callback: () => {\n          this.showNextDialog(iterator);\n        }\n      });\n    } else if (item instanceof StoryLine.DialogItemIframe) {\n      const style = item.style || \"\";\n      const message = `\n      <iframe\n        id='dialog-iframe'\n        class=\"dialog-iframe\"\n        src=\"${item.url}\"\n        style=\"${style}\" ></iframe>`;\n      bootbox.dialog({\n        message,\n        size: 'large',\n        centerVertical: true,\n        closeButton: true,\n        // callback: this won't be called in \"dialog\"\n        onShown: () => {\n          const iframe = document.getElementById('dialog-iframe');\n          console.log(iframe);\n        },\n        onHidden: () => {\n          // this function is called when user press \"x\" to close the dialog.\n          console.log('on hidden');\n          this.showNextDialog(iterator);\n        }\n      });\n      // We can use iframe.contentWindow.postMessage()\" to send a message to\n      // iframe.  And use window.addEventListener('message', e => { ... }) to\n      // receive the event.  (and vice versa)\n    }\n  }\n\n  recordDone(recordKey) {\n    DataStore.AnswerStore.setAndNotify(recordKey, \"true\");\n    DataStore.RemoteStore.increase(`MISSION/${recordKey}`);\n  }\n\n  isDialogDonePreviously(iterator) {\n    const dialog = iterator.dialog;\n    const missionStep = dialog.missionStep;\n    const mission = missionStep.mission;\n    const key = `${mission.id}/${missionStep.id}/done`;\n    return (DataStore.AnswerStore.get(key) === \"true\");\n  }\n\n  doneDialog(iterator) {\n    this.hasOnGoingDialog = false;\n    const dialog = iterator.dialog;\n    const missionStep = dialog.missionStep;\n    const mission = missionStep.mission;\n\n    this.remove(`${mission.id}/${missionStep.id}`);\n    this.recordDone(`${mission.id}/${missionStep.id}/done`);\n\n    const nextStepKey = iterator.nextStep;\n    if (!nextStepKey) {\n      return;\n    }\n\n    console.log('nextStepKey: ', nextStepKey);\n\n    const nextStep = mission.steps[nextStepKey];\n    if (!nextStep) return;\n    this.add(`${mission.id}/${nextStep.id}`, nextStep);\n  }\n\n  moveTo(movement, callback) {\n    if (typeof(movement) === 'string') {\n      movement = {location: movement};\n    }\n\n    const me = this.charDaemon.getChar('player');\n    let {npcId, location} = movement;\n    if (!npcId) {\n      npcId = 'player';\n    }\n    console.log('who: ', npcId, 'location: ', location);\n    const char = this.charDaemon.getChar(npcId);\n    if (!char) return;\n    if (!location ||\n        !(location in PhaserWrapper.mapObjects) ||\n        location === '$player') {\n      location = {\n        x: me.player.x,\n        y: me.player.y - 2 * Const.TILE_SIZE,\n      }\n      // TODO(stimim): need to handle different texture\n      char.player.setFrame('misa-front');\n    } else {\n      location = PhaserWrapper.mapObjects[location]\n    }\n\n    const camera = this.scene.cameras.main;\n    // in milliseconds\n    camera.fadeOut(750, 0, 0, 0, (_, progressFadeOut) => {\n      if (progressFadeOut < 1) return;\n      char.x = char.player.x = location.x;\n      char.y = char.player.y = location.y;\n      camera.fadeIn(750, 0, 0, 0, (_, progressFadeIn) => {\n        if (progressFadeIn < 1) return;\n        callback();\n      });\n    });\n  }\n\n  startDialog(dialogId) {\n    if (this.hasOnGoingDialog) {\n      console.warn(`There is an on-going dialog, cannot start a new one`);\n      return;\n    }\n\n    const tuple = this.getDialog(dialogId);\n    if (tuple === null) {\n      console.error(`No such dialog: ${dialogId}`);\n      return;\n    }\n\n    console.info(`startDialog: ${dialogId}`, tuple.dialog);\n    const {dialog} = tuple;\n    this.hasOnGoingDialog = true;\n\n    const iterator = dialog.getIterator();\n    if (this.isDialogDonePreviously(iterator)) {\n      console.log('we have been here before');\n      this.doneDialog(iterator);\n      return;\n    }\n\n    if (dialog.missionStep.moveTo) {\n      this.moveTo(dialog.missionStep.moveTo, () => {\n        this.showDialog(iterator);\n      });\n    } else {\n      console.info(iterator);\n      this.showDialog(iterator);\n    }\n  }\n\n  checkDialogToTrigger(me) {\n    if (this.hasOnGoingDialog) return null;\n\n    for (const idx in this.dialogToTrigger) {\n      const {dialogId} = this.dialogToTrigger[idx];\n      this.dialogToTrigger.shift();\n      console.info(`will trigger ${dialogId}`);\n      return dialogId;\n    }\n\n    for (const dialogId in this.dialogs) {\n      const {locationId} = this.dialogs[dialogId];\n      if (locationId && (locationId in PhaserWrapper.mapObjects)) {\n        const loc = PhaserWrapper.mapObjects[locationId];\n        if (Math.hypot(loc.x - me.x, loc.y - me.y) < 2 * Const.TILE_SIZE) {\n          console.log('Will trigger dialog', dialogId, 'because of location');\n          return dialogId;\n        }\n      }\n    }\n\n    return null;\n  }\n\n  findNearbyDialog(me) {\n    for (const dialogId in this.dialogs) {\n      const {npcId} = this.dialogs[dialogId];\n      if (npcId) {\n        const npc = this.charDaemon.getChar(npcId);\n\n        if (Math.hypot(npc.x - me.x, npc.y - me.y) < 2 * Const.TILE_SIZE) {\n          return dialogId;\n        }\n      }\n    }\n    return null;\n  }\n\n  add(dialogId, step) {\n    const dialog = step.dialog;\n    const npcId = step.npcId;\n    const locationId = step.locationId;\n\n    console.log(`dialogId: ${dialogId}, npcId: ${npcId}, loc: ${locationId}`);\n\n    if (this.getDialog(dialogId) !== null) {\n      console.error(`Dialog ${dialogId} already exists.`);\n      return;\n    }\n\n    if (step.npcId !== undefined) {\n      const npc = this.charDaemon.getChar(npcId);\n      if (null === npc) {\n        console.error(`NPC ${npcId} doesn't exist.`);\n        return;\n      }\n      npc.showMissionMark(true);\n    } else if (step.locationId !== undefined) {\n      if (!(locationId in PhaserWrapper.mapObjects)) {\n        console.error(`Location ${locationId} doesn't exist.`);\n        return;\n      }\n    } else {\n      console.info(`adding ${dialogId} to dialogToTrigger`);\n      // trigger this in next frame\n      this.dialogToTrigger.push({\n        dialogId,\n        dialog,\n      });\n    }\n\n    this.dialogs[dialogId] = {\n      npcId: npcId,\n      locationId: locationId,\n      dialog: dialog,\n    };\n    return this.dialogs[dialogId];\n  }\n\n  remove(dialogId) {\n    const tuple = this.getDialog(dialogId);\n    if (null === tuple) {\n      return;\n    }\n\n    const {npcId} = tuple;\n    const npc = this.charDaemon.getChar(npcId);\n    if (npc !== null) {\n      npc.showMissionMark(false);\n    }\n\n    delete this.dialogs[dialogId];\n  }\n}\n\nexport const charDaemon = new CharDaemon();\nexport const dialogDaemon = new DialogDaemon(charDaemon);\nexport const storyLineDaemon = new StoryLineDaemon(dialogDaemon);\n\nwindow.charDaemon = charDaemon;\n","// Generated by gen_remote_key_map.py\n\nexport const KEY_MAP = {\"0000000001\":\"MISSION/intro/step-1/done\",\"0000000002\":\"MISSION/receive-package/step-1/done\",\"0000000003\":\"RESPONSE/player_occupation/學生\",\"0000000004\":\"RESPONSE/player_occupation/工程師\",\"0000000005\":\"RESPONSE/player_occupation/律師\",\"0000000006\":\"RESPONSE/player_occupation/健身教練\",\"0000000007\":\"RESPONSE/player_occupation/中年職業婦女\",\"0000000008\":\"RESPONSE/player_occupation/記者\",\"0000000009\":\"MISSION/receive-package/step-2/done\",\"0000000010\":\"MISSION/student-scene-intro/step-1/done\",\"0000000011\":\"MISSION/student-scene-intro/step-2/done\",\"0000000012\":\"MISSION/student-scene-intro/step-3/done\",\"0000000013\":\"RESPONSE/student-intro-choice/passive\",\"0000000014\":\"RESPONSE/student-intro-choice/proactive\",\"0000000015\":\"MISSION/student-scene-academic-affairs-office/step-1/done\",\"0000000016\":\"RESPONSE/student_asked_followup_question/false\",\"0000000017\":\"RESPONSE/student_asked_followup_question/true\",\"0000000018\":\"MISSION/student-scene-department-office/step-1/done\",\"0000000019\":\"MISSION/student-scene-home-2/step-1/done\",\"0000000020\":\"MISSION/student-scene-home-2/step-2/done\",\"0000000021\":\"MISSION/student-scene-home-2/step-3/done\",\"0000000022\":\"RESPONSE/student-gene-interested-in/gene\",\"0000000023\":\"RESPONSE/student-gene-interested-in/system\",\"0000000024\":\"MISSION/student-scene-home/step-1/done\",\"0000000025\":\"MISSION/student-scene-home/step-2/done\",\"0000000026\":\"MISSION/student-scene-home/step-3/done\",\"0000000027\":\"MISSION/student-scene-home/workshop-ready/done\",\"0000000028\":\"MISSION/digit-gene-workshop/step-1/done\",\"0000000029\":\"MISSION/digit-gene-workshop/step-2/done\",\"0000000030\":\"MISSION/digit-gene-workshop/step-3/done\",\"0000000031\":\"MISSION/digit-gene-workshop/step-4/done\",\"0000000032\":\"MISSION/intro+start/step-1/done\",\"0000000033\":\"MISSION/doctor-enters-ward/step-1/done\",\"0000000034\":\"RESPONSE/player_age/15~24\",\"0000000035\":\"RESPONSE/player_age/25~44\",\"0000000036\":\"RESPONSE/player_age/45~54\",\"0000000037\":\"RESPONSE/player_age/65UP\",\"0000000038\":\"MISSION/15~24/step-1/done\",\"0000000039\":\"RESPONSE/player_problem/疫情\",\"0000000040\":\"RESPONSE/player_problem/數位身分證\",\"0000000041\":\"RESPONSE/player_problem/基因等級\",\"0000000042\":\"MISSION/gene-level/step-1/done\",\"0000000043\":\"MISSION/Out-of-the-ward/step-1/done\",\"0000000044\":\"MISSION/street/step-1/done\",\"0000000045\":\"MISSION/street/last/done\",\"0000000046\":\"MISSION/wistoria/step-1/done\",\"0000000047\":\"MISSION/wistoria/last/done\",\"0000000048\":\"MISSION/ending-vo/step-1/done\",\"0000000049\":\"MISSION/doctor-enters-ward/step-2/done\",\"0000000050\":\"MISSION/ending-vo/step-2/done\",\"0000000051\":\"MISSION/Out-of-the-ward/step-2/done\",\"0000000052\":\"MISSION/Out-of-the-ward/step-3/done\",\"0000000053\":\"RESPONSE/robot-1/沒碳足跡\",\"0000000054\":\"RESPONSE/robot-1/消耗碳足跡\",\"0000000055\":\"MISSION/Robot-dialogue-1/step-1/done\",\"0000000056\":\"RESPONSE/robot-2/法令\",\"0000000057\":\"RESPONSE/robot-2/消耗碳足跡\",\"0000000058\":\"MISSION/Robot-dialogue-2/step-1/done\",\"0000000059\":\"RESPONSE/robot-3/怎麼不早說\",\"0000000060\":\"RESPONSE/robot-3/怎麼不說\",\"0000000061\":\"MISSION/Robot-dialogue-3/step-1/done\",\"0000000062\":\"MISSION/Wistoria-1/step-1/done\"};\n\nexport const REV_KEY_MAP = {};\nfor (const key in KEY_MAP) {\n  REV_KEY_MAP[KEY_MAP[key]] = key;\n}\n","/*\n * Remember some key-value pairs locally and or remotely.\n *\n * 1. localStorage: use window.localStorage to store something across browser\n *    section.\n * 2. remoteStorage: use g0v backend to store data remotely.\n *\n * For (2), we will generate an 'datastore_token', which is saved in\n * localStorage, on remoteStorage, different datastore_token means a different\n * identity.\n */\n\nimport StoreModule from 'store2';\nimport {KEY_MAP, REV_KEY_MAP} from './remote_key_map.js';\n\nfunction _hasOwnProperty(obj, property) {\n  return Object.prototype.hasOwnProperty.call(obj, property);\n}\n\n(function(_) {\n  const callbacks = [];\n\n  _.fn('setAndNotify', function(key, value) {\n    this.set(key, value);\n\n    if (!this.callbacks) return;\n\n    if (_hasOwnProperty(this.callbacks, key)) {\n      for (const callback of this.callbacks[key]) {\n        callback.call(this, key);\n      }\n    }\n\n    if (_hasOwnProperty(this.callbacks, '*')) {\n      for (const callback of this.callbacks['*']) {\n        callback.call(this, key);\n      }\n    }\n  });\n\n  _.fn('notify', function() {\n    for (const key in callbacks) {\n      if (_hasOwnProperty(this.callbacks, key)) {\n        for (const callback of this.callbacks[key]) {\n          callback.call(this);\n        }\n      }\n    }\n  });\n\n  _.fn('listen', function(key, callback) {\n    if (this.callbacks === undefined) {\n      this.callbacks = {};\n    }\n\n    if (this.callbacks[key] === undefined) {\n      this.callbacks[key] = [];\n    }\n\n    this.callbacks[key].push(callback);\n  });\n})(StoreModule._);\n\n\nconst _DATASTORE_API_URL = 'https://pingtung-hao-305236.middle2.me/api';\nconst _REMOTE_STORE_CACHE = StoreModule.namespace('REMOTE_STORE_CACHE');\n\nclass RemoteStoreClass {\n  constructor() {\n    // have we checked our token in current session?\n    this._tokenChecked = false;\n  }\n\n  get token() {\n    return _REMOTE_STORE_CACHE.get('token');\n  }\n\n  async _register() {\n    const response = await fetch(`${_DATASTORE_API_URL}/register`, {\n      method: 'POST',\n      // mode: 'no-cors',\n    });\n    const data = await response.json();\n    if (data.token) {\n      _REMOTE_STORE_CACHE.set('token', data.token);\n      // expire in one day.\n      const expireTime = (new Date()).getTime() + 86400 * 1000;\n      _REMOTE_STORE_CACHE.set('expire', expireTime);\n      this._tokenChecked = true;\n    }\n  }\n\n  /*\n   * Makes sure there is a valid token.\n   */\n  async _ensureToken() {\n    if (!_REMOTE_STORE_CACHE.has('token')) {\n      return await this._register();\n    }\n\n    const now = (new Date()).getTime();\n    if (now > _REMOTE_STORE_CACHE.get('expire', 0)) {\n      return await this._register();\n    }\n\n    // the token should not be expired yet, but let's check for sure.\n    if (!this._tokenChecked) {\n      const token = this.token;\n      const response = \n        await fetch(`${_DATASTORE_API_URL}/check_token?token=${token}`, {\n          method: 'GET',\n          // mode: 'no-cors',\n        });\n\n      const data = await response.json();\n      if (data.ok !== true)  {\n        return await this._register();\n      }\n\n      this._tokenChecked = true;\n    }\n  }\n\n  async _inc(key) {\n    await this._ensureToken();\n\n    console.log(`increasing key: ${key}`);\n    // now this.token is available.\n    const url = `${_DATASTORE_API_URL}/inc?token=${this.token}&key=${key}`;\n    const response = await fetch(url, {\n      method: 'POST',\n      // mode: 'no-cors',\n    });\n    const data = await response.json();\n    console.log(`increased key: ${key} -> ${data.value}, data: `, data);\n    return data.value;\n  }\n\n  async _getc(key) {\n    await this._ensureToken();\n\n    // now this.token is available.\n    const url = `${_DATASTORE_API_URL}/getc?token=${this.token}&key=${key}`;\n    const response = await fetch(url, {\n      method: 'GET',\n      // mode: 'no-cors',\n    });\n    const data = await response.json();\n    return data.value;\n  }\n\n  increase(key) {\n    key = REV_KEY_MAP[key];\n    return this._inc(key);\n  }\n\n  getCount(key) {\n    key = REV_KEY_MAP[key];\n    return this._getc(key);\n  }\n\n  async getAllCount() {\n    const result = {};\n    for (const key in KEY_MAP) {\n      const localKey = KEY_MAP[key];\n      const count = await this.getCount(localKey);\n      result[localKey] = count;\n    }\n    return result;\n  }\n}\n\nexport const AnswerStore = StoreModule.namespace('DIALOG_ANSWER');\nexport const RemoteStore = new RemoteStoreClass();\n","export const API_URL = 'https://meet.jothon.online/api/';\nexport const TILE_SIZE = 32;\nexport const SPEED = 175;\n","import * as Hero from './hero.js';\nimport * as DataStore from './data_store.js';\nimport * as StoryLine from './story_line.js';\nimport * as JitsiChannel from './jitsi_channel.js';\nimport * as Const from './const.js';\n\nexport var tileMap;\n\nexport var mapObjects = {};\n\nlet char;\nvar config = {};\nlet cursors = {\n  left: { isDown: false },\n  right: { isDown: false },\n  up: { isDown: false },\n  down: { isDown: false },\n};\nconst WINDOW_WIDTH = window.innerWidth;\nconst WINDOW_HEIGHT = window.innerHeight;\nconst DEPTH_BELOW_LAYER = 0;\nconst DEPTH_WORLD_LAYER = 10;\nconst DEPTH_ABOVE_LAYER = 20;\nconst DEPTH_MASK_LAYER = 30;\nconst DEPTH_DIALOG_LAYER = 99;\n\nclass IntroScene extends Phaser.Scene {\n  constructor () {\n    super('Intro');\n  }\n\n  preload() {\n    this.load.setPath('assets/');\n    if (this.sys.game.device.os.desktop) {\n      this.load.video('intro', 'media/idystopia.mp4');\n    } else {\n      this.load.video('intro', 'media/idystopia_480p.mp4');\n    }\n  }\n\n  create() {\n    const video = this.add.video(WINDOW_WIDTH / 2, WINDOW_HEIGHT / 2, 'intro');\n    video.setMute(true);\n\n    const width = video.width;\n    const height = video.height;\n    const scale = Math.min(WINDOW_WIDTH / width, WINDOW_HEIGHT / height);\n    video.setScale(scale);\n    console.log(\"playing video\");\n    video.play();\n\n    video.on('complete', video => {\n      video.play(true, 6, 8);\n    });\n\n    if (this.sys.game.device.os.desktop) {\n      this.add.text(WINDOW_WIDTH / 2, WINDOW_HEIGHT * 0.9,\n        'press ENTER to continue...', {\n          font: '18px monospace',\n          fill: '#ffffff',\n          padding: {x: 20, y: 20},\n        }).setDepth(DEPTH_DIALOG_LAYER).setOrigin(0.5);\n    } else {\n      this.add.text(WINDOW_WIDTH / 2, WINDOW_HEIGHT * 0.9,\n        'Touch screen to continue...', {\n          font: '18px monospace',\n          fill: '#ffffff',\n          padding: {x: 20, y: 20},\n        }).setDepth(DEPTH_DIALOG_LAYER).setOrigin(0.5);\n    }\n\n    this.input.keyboard.once('keydown_ENTER', () => {\n      this.startNextScene();\n    });\n\n    this.input.on('pointerup', () => {\n      this.startNextScene();\n    }, this);\n  }\n\n  startNextScene() {\n    // this.scene.add('Game', Game, true);\n    this.scene.start('Game');\n    this.scene.remove('Intro');\n  }\n}\n\n\nclass GameScene extends Phaser.Scene {\n  constructor () {\n    super('Game');\n  }\n\n  preload() {\n    console.log('Preload Game scene');\n    const {tilemapTiledJSON, storylineJSON, npcList} = config;\n\n    this.load.setPath('assets/');\n    this.load.image(\"tiles\", \"tiles/world.png\");\n    this.load.image(\"vision\", \"symbols/mask.png\");\n    this.load.audio('hospital', 'audio/hospital.mp3');\n    this.load.tilemapTiledJSON(\"map\", `${tilemapTiledJSON}?v=202012051335`);\n    // An atlas is a way to pack multiple images together into one texture. I'm\n    // using it to load all the player animations (walking left, walking right,\n    // etc.) in one image. For more info see:\n    // https://labs.phaser.io/view.html?src=src/animation/texture%20atlas%20animation.js\n    // If you don't use an atlas, you can do the same thing with a this.playersheet,\n    // see:\n    // https://labs.phaser.io/view.html?src=src/animation/single%20this.player%20sheet.js\n    this.load.atlas(\"atlas\", \"atlas/atlas.png\", \"atlas/atlas.json\");\n    this.load.atlas(\"NPC-i\", \"atlas/NPC-i.png\", \"atlas/atlas.json\");\n  }\n\n  onDoneCreate() {\n    $( '#button-show-mission' ).show();\n    $( '#button-join-online-event' ).show();\n\n    const {storylineJSON} = config;\n    const {gameSceneConfig} = config;\n    const {postBootCallback} = gameSceneConfig;\n\n    DataStore.AnswerStore.clearAll();\n\n    StoryLine.loadStoryLine(storylineJSON).then(\n      (storyLine) => {\n        this.storyLineDaemon = Hero.storyLineDaemon;\n        this.storyLineDaemon.init(storyLine);\n      }\n    );\n\n    DataStore.AnswerStore.listen('player_name', () => {\n      char.name = DataStore.AnswerStore.get('player_name');\n    });\n\n    if (postBootCallback) {\n      postBootCallback();\n    }\n  }\n\n  create() {\n    this.hospitalBackgroundMusic = this.sound.add('hospital', {\n      loop: true,\n      volume: 0.5,\n    });\n    if (config.isCLabEnv) {\n      this.sound.pauseOnBlur = false;\n    }\n    if (this.sound.locked) {\n      this.sound.once(Phaser.Sound.Events.UNLOCKED, () => {\n        this.hospitalBackgroundMusic.play();\n      });\n    } else {\n      this.hospitalBackgroundMusic.play();\n    }\n\n    console.log('Create Game scene');\n    const {npcList} = config;\n    const map = this.make.tilemap({ key: \"map\" });\n\n    // Parameters are the name you gave the tileset in Tiled and then the key of\n    // the tileset image in Phaser's cache (i.e. the name you used in preload)\n    const tileset = map.addTilesetImage(\"world\", \"tiles\");\n\n    // Parameters: layer name (or index) from Tiled, tileset, x, y\n    this.belowLayer = map.createStaticLayer(\"Below Player\", tileset, 0, 0);\n    this.worldLayer = map.createStaticLayer(\"World\", tileset, 0, 0);\n    this.aboveLayer = map.createStaticLayer(\"Above Player\", tileset, 0, 0);\n\n    this.worldLayer.setCollisionByProperty({ collides: true });\n\n    // By default, everything gets depth sorted on the screen in the order we\n    // created things. Here, we want the \"Above Player\" layer to sit on top of\n    // the player, so we explicitly give it a depth.  Higher depths will sit on\n    // top of lower depth objects.\n    this.belowLayer.setDepth(DEPTH_BELOW_LAYER);\n    this.worldLayer.setDepth(DEPTH_WORLD_LAYER);\n    this.aboveLayer.setDepth(DEPTH_ABOVE_LAYER);\n\n    window.objectLayer = map.getObjectLayer('Objects');\n    // Object layers in Tiled let you embed extra info into a map - like a spawn\n    // point or custom collision shapes.\n    map.getObjectLayer('Objects').objects.forEach(\n      obj => {mapObjects[obj.name] = obj});\n\n    this.charDaemon = Hero.charDaemon;\n    this.charDaemon.setScene(this);\n\n    if (npcList) {\n      for (const npcId in npcList) {\n        const {name, texture, frame} = npcList[npcId];\n        if (!(npcId in mapObjects)) {\n          continue;\n        }\n        const point = mapObjects[npcId];\n\n        if (npcList[npcId].movements) {\n          this.charDaemon.createMovingNPC(\n            npcId, name, point.x, point.y, texture, frame,\n            npcList[npcId].movements);\n        } else {\n          this.charDaemon.create(npcId, name, point.x, point.y, texture, frame);\n        }\n      }\n    }\n\n    const home = mapObjects['HOME'];\n    char = this.charDaemon.create(\n      'player', '???', home.x, home.y, 'atlas', 'misa-front');\n    this.player = char.player;\n\n    this.vision = this.make.image({\n      x: this.player.x,\n      y: this.player.y,\n      key: 'vision',\n      add: false\n    });\n    this.vision.setScale(1.5);\n\n    console.log('create texture');\n    const makeMask = () => {\n      if (this.mask) {\n        if (this.mask.mask) {\n          this.mask.mask.destroy();\n        }\n        this.mask.destroy();\n      }\n\n      this.mask = this.make.renderTexture({\n        x: this.player.x,\n        y: this.player.y,\n        width: 2 * this.scale.width,\n        height: 2 * this.scale.height,\n      }, true);\n      this.mask.fill(0x000000, 1);\n      this.mask.setTint(0x0a2948);\n      this.mask.setDepth(DEPTH_MASK_LAYER);\n      this.mask.setOrigin(0.5);\n\n      this.mask.mask = new Phaser.Display.Masks.BitmapMask(this, this.vision)\n      this.mask.mask.invertAlpha = true\n    };\n\n    makeMask();\n    this.scale.on('resize', () => {\n      console.log('resize', this.scale.width, this.scale.height);\n      makeMask();\n    });\n\n    // Watch the player and worldLayer for collisions, for the duration of the\n    // scene:\n    const group = this.physics.add.group();\n\n    for (const id in this.charDaemon.chars) {\n      if (this.charDaemon.chars.hasOwnProperty(id)) {\n        const p = this.charDaemon.chars[id].player;\n        group.add(p);\n        // I don't know why, but I can't do this in Char.makeContainer function.\n        // And we must not set player as immovable.\n        if (id !== 'player') {\n          p.setImmovable(true);\n        }\n      }\n    }\n\n    this.physics.add.collider(group, group);\n    this.physics.add.collider(group, this.worldLayer);\n\n    this.dialogDaemon = Hero.dialogDaemon;\n\n    // Create the player's walking animations from the texture atlas. These are\n    // stored in the global animation manager so any this.player can access them.\n    const anims = this.anims;\n    anims.create({\n      key: \"misa-left-walk\",\n      frames: anims.generateFrameNames(\n        \"atlas\", { prefix: \"misa-left-walk.\", start: 0, end: 3, zeroPad: 3 }),\n      frameRate: 10,\n      repeat: -1\n    });\n    anims.create({\n      key: \"misa-right-walk\",\n      frames: anims.generateFrameNames(\n        \"atlas\", { prefix: \"misa-right-walk.\", start: 0, end: 3, zeroPad: 3 }),\n      frameRate: 10,\n      repeat: -1\n    });\n    anims.create({\n      key: \"misa-front-walk\",\n      frames: anims.generateFrameNames(\n        \"atlas\", { prefix: \"misa-front-walk.\", start: 0, end: 3, zeroPad: 3 }),\n      frameRate: 10,\n      repeat: -1\n    });\n    anims.create({\n      key: \"misa-back-walk\",\n      frames: anims.generateFrameNames(\n        \"atlas\", { prefix: \"misa-back-walk.\", start: 0, end: 3, zeroPad: 3 }),\n      frameRate: 10,\n      repeat: -1\n    });\n\n    const camera = this.cameras.main;\n    camera.startFollow(this.player);\n    camera.setBounds(0, 0, map.widthInPixels, map.heightInPixels);\n\n    const cursorKeys = [\n      Phaser.Input.Keyboard.KeyCodes.LEFT,\n      Phaser.Input.Keyboard.KeyCodes.RIGHT,\n      Phaser.Input.Keyboard.KeyCodes.UP,\n      Phaser.Input.Keyboard.KeyCodes.DOWN,\n    ];\n\n    for (const keyCode of cursorKeys) {\n      const key = this.input.keyboard.addKey(keyCode, false);\n      key.on('down', (key, event) => {\n        this.lastUserInputTimestamp = (new Date()).getTime();\n        if (this.dialogDaemon.hasOnGoingDialog) return;\n        switch (event.keyCode) {\n          case Phaser.Input.Keyboard.KeyCodes.LEFT:\n            cursors.left.isDown = true;\n            break;\n          case Phaser.Input.Keyboard.KeyCodes.RIGHT:\n            cursors.right.isDown = true;\n            break;\n          case Phaser.Input.Keyboard.KeyCodes.UP:\n            cursors.up.isDown = true;\n            break;\n          case Phaser.Input.Keyboard.KeyCodes.DOWN:\n            cursors.down.isDown = true;\n            break;\n        }\n      });\n      key.on('up', (key, event) => {\n        this.lastUserInputTimestamp = (new Date()).getTime();\n        switch (event.keyCode) {\n          case Phaser.Input.Keyboard.KeyCodes.LEFT:\n            cursors.left.isDown = false;\n            break;\n          case Phaser.Input.Keyboard.KeyCodes.RIGHT:\n            cursors.right.isDown = false;\n            break;\n          case Phaser.Input.Keyboard.KeyCodes.UP:\n            cursors.up.isDown = false;\n            break;\n          case Phaser.Input.Keyboard.KeyCodes.DOWN:\n            cursors.down.isDown = false;\n            break;\n        }\n      });\n    }\n\n    const enterKey = this.input.keyboard.addKey(\n      Phaser.Input.Keyboard.KeyCodes.ENTER, false);\n    enterKey.on('down', () => {\n      this.lastUserInputTimestamp = (new Date()).getTime();\n      if (this.dialogDaemon.hasOnGoingDialog) return;\n      const dialogId = this.dialogDaemon.findNearbyDialog(this.player);\n      if (dialogId !== null) {\n        this.dialogDaemon.startDialog(dialogId);\n      }\n    });\n\n    // Help text that has a \"fixed\" position on the screen\n    if (this.sys.game.device.os.desktop) {\n      $('#joystick').hide();\n      this.add\n        .text(16, 16, 'Arrow keys to move\\nPress \"Enter\" to interact', {\n          font: \"18px monospace\",\n          fill: \"#000000\",\n          padding: { x: 20, y: 10 },\n          backgroundColor: \"#ffffff\"\n        })\n        .setScrollFactor(0)\n        .setDepth(30);\n    } else {\n      $('#joystick').show();\n      this.add\n        .text(16, 16, 'Use joysticks to move\\nPress the stick to interact', {\n          font: \"18px monospace\",\n          fill: \"#000000\",\n          padding: { x: 20, y: 10 },\n          backgroundColor: \"#ffffff\"\n        })\n        .setScrollFactor(0)\n        .setDepth(30);\n    }\n    // Debug graphics\n    this.input.keyboard.once(\"keydown_D\", event => {\n      // Turn on physics debugging to show player's hitbox\n      this.physics.world.createDebugGraphic();\n\n      // Create worldLayer collision graphic above the player, but below the\n      // help text\n      const graphics = this.add\n        .graphics()\n        .setAlpha(0.75)\n        .setDepth(20);\n      this.worldLayer.renderDebug(graphics, {\n        tileColor: null,\n        collidingTileColor: new Phaser.Display.Color(243, 134, 48, 255),\n        faceColor: new Phaser.Display.Color(40, 39, 37, 255),\n      });\n    });\n\n    // joystick\n    const stick = $(\"#joystick .touch-stick\");\n    var limit = $(\"#joystick\").width()/2;\n    var dead = 0.3;\n    var centerX = $(\"#joystick\").position().left + $(\"#joystick\").width()/2;\n    var centerY = $(\"#joystick\").position().top + $(\"#joystick\").height()/2;\n\n    function initJoystick() {\n      centerX = $(\"#joystick\").position().left + $(\"#joystick\").width()/2;\n      centerY = $(\"#joystick\").position().top + $(\"#joystick\").height()/2;\n      limit = $(\"#joystick\").width()/2;\n    }\n    $(window).on('resize', function(){\n      initJoystick();\n    });\n\n    let tap = false;\n    $(\"#joystick\").on('touchmove', (e) => {\n      e.preventDefault();\n      tap = false;\n\n      if (this.dialogDaemon.hasOnGoingDialog) {\n        cursors.left.isDown = false;\n        cursors.right.isDown = false;\n        cursors.up.isDown = false;\n        cursors.down.isDown = false;\n        return;\n      }\n\n      const touch = e.originalEvent.targetTouches[0];\n      let deltaX = (touch.pageX - centerX) / limit;\n      let deltaY = (touch.pageY - centerY) / limit;\n      deltaX = Math.min(Math.max(deltaX, -1), 1);\n      deltaY = Math.min(Math.max(deltaY, -1), 1);\n      stick.css({\"left\": `${deltaX*50 + 50}%`, \"top\": `${deltaY*50 + 50}%`});\n\n      if(Math.abs(deltaX) < dead) {\n        deltaX = 0;\n        cursors.left.isDown = false;\n        cursors.right.isDown = false;\n      }\n      if(Math.abs(deltaY) < dead) {\n        deltaY = 0;\n        cursors.up.isDown = false;\n        cursors.down.isDown = false;\n      }\n      if(Math.abs(deltaX) >= Math.abs(deltaY)) {\n        if(deltaX > 0){\n          cursors.right.isDown = true;\n          cursors.left.isDown = false;\n        } else {\n          cursors.right.isDown = false;\n          cursors.left.isDown = true;\n        }\n      } else {\n        if(deltaY < 0){\n          cursors.up.isDown = true;\n          cursors.down.isDown = false;\n        } else {\n          cursors.up.isDown = false;\n          cursors.down.isDown = true;\n        }\n      }\n    });\n    $(\"#joystick\").on('touchstart','.touch-stick', () => {\n      tap = true;\n    });\n    $(\"#joystick\").on('touchend','.touch-stick', () => {\n      $(\"#joystick .touch-stick\").css({\"left\": '50%', \"top\": '50%'});\n      cursors.up.isDown = false;\n      cursors.down.isDown = false;\n      cursors.left.isDown = false;\n      cursors.right.isDown = false;\n      if(tap) {\n        if (this.dialogDaemon.hasOnGoingDialog) return;\n        const dialogId = this.dialogDaemon.findNearbyDialog(this.player);\n        if (dialogId !== null) {\n          this.dialogDaemon.startDialog(dialogId);\n        }\n      }\n    });\n\n    this.onDoneCreate();\n  }\n\n  update(time, delta) {\n    if (this.vision && this.mask) {\n      if (config.connection) {\n        this.mask.visible = false;\n      } else {\n        this.mask.visible = true;\n        this.vision.x = this.player.x;\n        this.vision.y = this.player.y;\n        this.mask.x = this.player.x;\n        this.mask.y = this.player.y;\n      }\n    }\n\n    // let's check if we triggered any dialogs\n\n    const dialogId = this.dialogDaemon.checkDialogToTrigger(this.player);\n    if (dialogId !== null) {\n      this.dialogDaemon.startDialog(dialogId);\n      return;\n    }\n\n    const prevVelocity = this.player.body.velocity.clone();\n\n    // Stop any previous movement from the last frame\n    this.player.body.setVelocity(0);\n\n    let vX = 0;\n    let vY = 0;\n\n    if (!this.dialogDaemon.hasOnGoingDialog) {\n      // Horizontal movement\n      if (cursors.left.isDown) {\n        vX = -Const.SPEED;\n      } else if (cursors.right.isDown) {\n        vX = Const.SPEED;\n      }\n\n      // Vertical movement\n      if (cursors.up.isDown) {\n        vY = -Const.SPEED;\n      } else if (cursors.down.isDown) {\n        vY = Const.SPEED;\n      }\n    }\n\n    this.player.body.setVelocityX(vX);\n    this.player.body.setVelocityY(vY);\n    if (vX || vY) {\n      // Normalize and scale the velocity so that player can't move faster along a\n      // diagonal\n      this.player.body.velocity.normalize().scale(Const.SPEED);\n    }\n\n    if (config.isCLabEnv) {\n      const now = (new Date()).getTime();\n      if (!this.lastUserInputTimestamp) {\n        this.lastUserInputTimestamp = now;\n      } else if (now - this.lastUserInputTimestamp > 5 * 60 * 1000) {\n        // Idle for more than 5 minutes.\n        this.scene.pause();\n        bootbox.confirm({\n          title: 'Timed out',\n          message: '太久沒有操作，是否重新開始遊戲？',\n          buttons: {\n            cancel: {\n              label: '繼續遊戲',\n            },\n            confirm: {\n              label: '重新開始',\n            }\n          },\n          callback: (result) => {\n            if (result) {\n              this.lastUserInputTimestamp = (new Date()).getTime();\n              this.scene.resume();\n              location.reload();\n            } else {\n              this.lastUserInputTimestamp = (new Date()).getTime();\n              this.scene.resume();\n            }\n          }\n        });\n      }\n    }\n\n    // Update the animation last and give left/right animations precedence over\n    // up/down animations\n\n    if (vX < 0) {\n      this.player.anims.play(\"misa-left-walk\", true);\n    } else if (vX > 0) {\n      this.player.anims.play(\"misa-right-walk\", true);\n    } else if (vY < 0) {\n      this.player.anims.play(\"misa-back-walk\", true);\n    } else if (vY > 0) {\n      this.player.anims.play(\"misa-front-walk\", true);\n    } else {\n      this.player.anims.stop();\n\n      // If we were moving, pick and idle frame to use\n      if (prevVelocity.x < 0) this.player.setTexture(\"atlas\", \"misa-left\");\n      else if (prevVelocity.x > 0) this.player.setTexture(\"atlas\", \"misa-right\");\n      else if (prevVelocity.y < 0) this.player.setTexture(\"atlas\", \"misa-back\");\n      else if (prevVelocity.y > 0) this.player.setTexture(\"atlas\", \"misa-front\");\n    }\n\n    if (config.connection) {\n      config.connection.update(time, delta, char);\n    }\n\n    this.charDaemon.update(time, delta);\n  }\n}\n\n/*\n * tilemapTiledJSON: string, path to tilemap JSON file.\n * storylineJSON: string, path to storyline JSON file.\n */\nexport function CreateGame({\n    tilemapTiledJSON, storylineJSON, connection, npcList,\n    postBootCallback, isCLabEnv}) {\n  config = {\n    type: Phaser.AUTO,\n    width: WINDOW_WIDTH,\n    height: WINDOW_HEIGHT,\n    parent: \"game-container\",\n    physics: {\n      default: \"arcade\",\n      arcade: {\n        gravity: { y: 0 }\n      }\n    },\n    scale: {\n      mode: Phaser.Scale.RESIZE,\n      width: '100%',\n      height: '100%',\n    },\n    scene: [IntroScene, GameScene],\n    gameSceneConfig: {\n      postBootCallback\n    },\n    tilemapTiledJSON,\n    storylineJSON,\n    connection,\n    npcList,\n    isCLabEnv,\n  };\n\n  const game = new Phaser.Game(config);\n  game.joinOnlineEvent = () => {\n    const conn = new JitsiChannel.JitsiConnection();\n    conn.init();\n    config.connection = conn;\n    conn.setDisplayName(DataStore.AnswerStore.get('player_name'));\n    DataStore.AnswerStore.listen('player_name', () => {\n      conn.setDisplayName(DataStore.AnswerStore.get('player_name'));\n    });\n    const spawnPoint = 'online-event-spawn-point';\n    Hero.dialogDaemon.moveTo(spawnPoint, () => {});\n    $( '#online-panel' ).show();\n  };\n  game.sendMessage = (message) => {\n    config.connection.sendMessage(message);\n  }\n  return game;\n\n}\n","/**\n * Design Doc: https://g0v.hackmd.io/4HiKmrEASa-YdQ2bqg4kHg\n */\n\nimport * as DataStore from './data_store.js';\n\n/**\n * <mission-id>:  # repeated\n *   title: <mission-title>\n *   description: <...>\n *   depend:\n *     A list of clauses.  If the list is empty, there is no dependency.\n *     Otherwise, at least one of the clauses needs to be true to trigger this\n *     mission (that is, disjunctive)\n *     - clause: a list of expressions, the clause is true if and only if all\n *     expressions are true.\n *       - expression:\n *            \"<ANSWER_STORE_KEY>\" |\n *            { \"storeKey\": \"<ANSWER_STORE_KEY>\", \"value\": \"<expected value>\" }\n *   firstStep: <step-id>\n *   steps:\n *     ...\n */\nclass Mission {\n  constructor(id, title, description, depend, firstStep) {\n    this.id = id;\n    this.title = title;\n    this.description = description;\n    this.depend = depend;\n    this.firstStep = firstStep;\n    this.steps = {};\n  }\n\n  addStep(missionStep) {\n    this.steps[missionStep.id] = missionStep;\n  }\n\n  _checkClause(clause) {\n    for (const i in clause) {\n      const expr = clause[i];\n      console.log(`condition: `, expr);\n      let key;\n      let expectedValue;\n      if (typeof(expr) === 'string') {\n        key = expr;\n      } else if (typeof(expr) === 'object') {\n        key = expr['storeKey'];\n        expectedValue = expr['value'];\n      }\n      if (!DataStore.AnswerStore.has(key)) return false;\n      if (!expectedValue) continue;\n      const actualValue = DataStore.AnswerStore.get(key);\n      if (actualValue !== expectedValue) return false;\n    }\n    return true;\n  }\n\n  isReady() {\n    console.log(`checking dependency of ${this.id}`, this.depend);\n    if (!this.depend || this.depend.length === 0) return true;\n\n    for (const idx in this.depend) {\n      let clause = this.depend[idx];\n      if (!(clause instanceof Array)) {\n        clause = [clause];\n      }\n\n      console.log(clause);\n      if (this._checkClause(clause)) {\n        console.log(`${this.id} is ready!`);\n        return true;\n      }\n    }\n    return false;\n  }\n\n  static fromDict(missionId, dict) {\n    const title = dict['title'] || 'Unnamed Mission';\n    const description = dict['description'] || 'no description';\n    const firstStep = dict['firstStep'] || 'step-1';\n    const depend = (dict['depend'] || []).filter(d => {\n      if (typeof(d) === 'string' || d instanceof String) {\n        return true;\n      }\n      if (typeof(d) === 'object') return true;\n      console.warn(`${d} is not a string nor an object`);\n      return false;\n    });\n\n    const mission = new Mission(\n      missionId, title, description, depend, firstStep);\n\n    for (const stepId in dict['steps']) {\n      const step = MissionStep.fromDict(stepId, dict['steps'][stepId], mission);\n      mission.addStep(step);\n    }\n    return mission;\n  }\n}\n\n/**\n * <step-id>:  # repeated\n *   title: <step-title>\n *   description: <...>\n *   nextStep: <step-id>  # the default next step\n *   npcId: <npc-id>  # whom to find to trigger the dialog of this step.\n *                    # NPC can be an object (e.g. a box).\n *   locationId: <location-id>  # where to go to trigger the dialog.\n *   dialog:\n *     - name: \"NPC name\" or $player  # who is talking\n *       line: \"hello, $player\"\n *       id: <line-id>  # optional\n *       nextLine: <line-id>  # optional: jump to another dialog if we don't\n *                             # want to fallthrough.  \"$EOD\" means \"end of\n *                             # dialog\"\n *     - name: \"NPC name\" or $player\n *       question: \"Red pill or blue pill?\"\n *       choices:\n *         - text: \"Red\"\n *           nextLine: <line-id>  # optional\n *         - text: \"Blue\"\n *           nextLine: <line-id>  # optional\n */\nclass MissionStep {\n  constructor({\n    id, title, description, nextStep, npcId, locationId, dialog, mission,\n    moveTo}) {\n\n    this.id = id;\n    this.title = title || 'Unnamed Step';\n    this.description = description || '...';\n    this.nextStep = nextStep;\n    this.npcId = npcId;\n    this.locationId = locationId;\n    this.dialog = dialog;\n    this.mission = mission;\n    this.moveTo = moveTo;\n  }\n\n  static fromDict(stepId, dict, mission) {\n    const d = {id: stepId, mission: mission, ...dict};\n    const missionStep = new MissionStep(d);\n\n    const dialog = Dialog.fromDict(dict['dialog'] || [], missionStep);\n    missionStep.dialog = dialog;\n    return missionStep;\n  }\n}\n\n/**\n *   dialog:\n *     - name: \"NPC name\" or $player  # who is talking\n *       line: \"hello, $player\"\n *       id: <line-id>  # optional\n *       nextLine: <line-id>  # optional: jump to another dialog if we don't\n *                             # want to fallthrough.  \"$EOD\" means \"end of\n *                             # dialog\"\n *     - name: \"NPC name\" or $player\n *       question: \"Red pill or blue pill?\"\n *       choices:\n *         - text: \"Red\"\n *           nextLine: <line-id>  # optional\n *         - text: \"Blue\"\n *           nextLine: <line-id>  # optional\n */\nclass Dialog {\n  constructor(missionStep) {\n    this.missionStep = missionStep;\n    this.dialogItems = [];\n    this.dialogIdMap = {};\n  }\n\n  addDialogItem(dialogItem) {\n    this.dialogItems.push(dialogItem);\n    if (dialogItem.id !== undefined) {\n      this.dialogIdMap[dialogItem.id] = this.dialogItems.length - 1;\n    }\n  }\n\n  getIterator() {\n    return new DialogIterator(this, this.missionStep.nextStep);\n  }\n\n  static fromDict(list, missionStep) {\n    const dialog = new Dialog(missionStep);\n    for (const dict of list) {\n      const dialogItem = DialogItem.fromDict(dict);\n      dialog.addDialogItem(dialogItem);\n    }\n    return dialog;\n  }\n}\n\n\nclass DialogIterator {\n  constructor(dialog, nextStep) {\n    this.dialog = dialog;\n    this.currentIndex = 0;\n    this.nextStep = nextStep;\n  }\n\n  getCurrentDialogItem() {\n    const item = this.dialog.dialogItems[this.currentIndex];\n    if (item && item.nextStep) this.nextStep = item.nextStep;\n    return item;\n  }\n\n  nextDialogItem(answer=undefined) {\n    const dialogItem = this.dialog.dialogItems[this.currentIndex];\n    let nextIndex = this.currentIndex + 1;\n    if (dialogItem.nextLine !== undefined) {\n      nextIndex = this.dialog.dialogIdMap[dialogItem.nextLine];\n    }\n\n    if (dialogItem instanceof DialogItemSelect) {\n      if (answer === undefined) {\n        console.warn('This is a multiple choice question, but no selected ' +\n          'answer. Default to the first answer.')\n        answer = 0;\n      }\n\n      if (dialogItem.choices[answer].nextLine !== undefined) {\n        const nextLine = dialogItem.choices[answer].nextLine;\n        nextIndex = this.dialog.dialogIdMap[nextLine];\n      }\n    }\n\n    if (dialogItem instanceof DialogItemPrompt) {\n      if (dialogItem.storeKey) {\n        DataStore.AnswerStore.setAndNotify(dialogItem.storeKey, answer);\n      }\n    }\n    if (dialogItem instanceof DialogItemSelect) {\n      const value = dialogItem.choices[answer].value || answer;\n      if (dialogItem.storeKey) {\n        DataStore.AnswerStore.setAndNotify(dialogItem.storeKey, value);\n        DataStore.RemoteStore.increase(`USER_RESPONSE/${dialogItem.storeKey}`);\n      }\n    }\n\n    console.info(\n        `${this.dialog.missionStep.id} The next line is: ${nextIndex}`);\n    this.currentIndex = nextIndex;\n    return this.getCurrentDialogItem();\n  }\n}\n\n/**\n * Properties:\n *   - id: (optional) an id to find this line.\n *   - name: Who is talking, can be \"$player\"\n *   - nextLine: (optional) jump to another dialog if we don't want to\n *               fallthrough.  Use \"$EOD\" to end the dialog.\n */\nclass DialogItem {\n  constructor(name, {id: id, nextLine: nextLine}) {\n    this.name = name;\n    this.id = id;\n    this.nextLine = nextLine;\n  }\n\n  static fromDict(dict) {\n    const name = dict['name'] || 'John Doe';\n    const type = dict['type'] || 'line';\n\n    switch (type) {\n      case 'line':\n        return new DialogItemLine(name, dict);\n      case 'input.select':\n        return new DialogItemSelect(name, dict);\n      case 'input.text':\n        return new DialogItemPrompt(name, dict);\n      case 'message':\n        return new DialogItemMessage(name, dict);\n      case 'iframe':\n        return new DialogItemIframe(name, dict);\n      default:\n        console.warn('unkonwn dialog type: %s', type);\n        return new DialogItemLine(name, dict);\n    }\n  }\n}\n\n/**\n * Dialog item for a single line\n *     - name: \"NPC name\" or $player  # who is talking\n *       line: \"hello, $player\"\n *       id: <line-id>  # optional\n *       nextLine: <line-id>  # optional: jump to another dialog if we don't\n *                             # want to fallthrough.  \"$EOD\" means \"end of\n *                             # dialog\"\n */\nexport class DialogItemLine extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    line: line, }) {\n    super(name, {id, nextLine});\n\n    if (line === undefined) {\n      console.warn('One of `line` and `question` should be defined.');\n      line = '...';\n    }\n    this.line = line;\n  }\n\n}\n\n/**\n *     - name: \"NPC name\" or $player\n *       question: \"Red pill or blue pill?\"\n *       storeKey: 'key'  (optional) to save the answer in localStore.\n *       choices:\n *         - text: \"Red\"\n *           nextLine: <line-id>  # optional\n *         - text: \"Blue\"\n *           nextLine: <line-id>  # optional\n */\nexport class DialogItemSelect extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    question: question,\n    choices: choices,\n    storeKey: storeKey}) {\n\n    super(name, {id, nextLine});\n    if (question === undefined) {\n      console.warn('set default question');\n      question = 'Please select an answer.';\n    }\n    this.question = question;\n\n    if (choices === undefined || !choices) {\n      console.warn('set default choices');\n      choices = [\n        {text: 'Ok'}\n      ]\n    }\n    this.choices = choices;\n    this.storeKey = storeKey;\n  }\n}\n\n/**\n * Dialog item for an open question\n *\n *     - name: \"NPC name\" or $player\n *       question: \"What's your name?\"\n *       storeKey: 'key' (optional) to save the answer in localStore\n *\n */\nexport class DialogItemPrompt extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    question: question,\n    storeKey: storeKey, }) {\n    super(name, {id, nextLine});\n    if (question === undefined) {\n      console.warn('set deafult question');\n      question = 'What do you want to share?';\n    }\n    this.question = question;\n    this.storeKey = storeKey;\n  }\n}\n\nexport class DialogItemMessage extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    message: message}) {\n    super(name, {id, nextLine});\n    if (message === undefined) {\n      console.warn('use default message');\n      message = 'MESSAGE';\n    }\n    this.message = message;\n  }\n}\n\nexport class DialogItemIframe extends DialogItem {\n  constructor(name, {\n    id: id,\n    nextLine: nextLine,\n    url: url,\n    callback: callback,\n    style: style,}) {\n    super(name, {id, nextLine});\n\n    this.url = url;\n    this.callback = callback;\n    this.style = style;\n  }\n}\n\nexport function loadStoryLineFromObject(obj) {\n  const missions = obj['missions'];\n  const loadedMissions = {};\n  if (!missions) {\n    console.info('no mission defined');\n    return loadedMissions;\n  }\n\n  for (const missionId in missions) {\n    const missionDict = missions[missionId];\n    loadedMissions[missionId] = Mission.fromDict(missionId, missionDict);\n  }\n  console.debug(loadedMissions);\n  return loadedMissions;\n}\n\nexport async function loadStoryLine(fileName) {\n  const response = await fetch(`/story-lines/${fileName}`);\n  const obj = await response.json();\n\n  return loadStoryLineFromObject(obj);\n}\n","/*! store2 - v2.12.0 - 2020-08-12\n* Copyright (c) 2020 Nathan Bubna; Licensed (MIT OR GPL-3.0) */\n;(function(window, define) {\n    var _ = {\n        version: \"2.12.0\",\n        areas: {},\n        apis: {},\n\n        // utilities\n        inherit: function(api, o) {\n            for (var p in api) {\n                if (!o.hasOwnProperty(p)) {\n                    Object.defineProperty(o, p, Object.getOwnPropertyDescriptor(api, p));\n                }\n            }\n            return o;\n        },\n        stringify: function(d) {\n            return d === undefined || typeof d === \"function\" ? d+'' : JSON.stringify(d);\n        },\n        parse: function(s, fn) {\n            // if it doesn't parse, return as is\n            try{ return JSON.parse(s,fn||_.revive); }catch(e){ return s; }\n        },\n\n        // extension hooks\n        fn: function(name, fn) {\n            _.storeAPI[name] = fn;\n            for (var api in _.apis) {\n                _.apis[api][name] = fn;\n            }\n        },\n        get: function(area, key){ return area.getItem(key); },\n        set: function(area, key, string){ area.setItem(key, string); },\n        remove: function(area, key){ area.removeItem(key); },\n        key: function(area, i){ return area.key(i); },\n        length: function(area){ return area.length; },\n        clear: function(area){ area.clear(); },\n\n        // core functions\n        Store: function(id, area, namespace) {\n            var store = _.inherit(_.storeAPI, function(key, data, overwrite) {\n                if (arguments.length === 0){ return store.getAll(); }\n                if (typeof data === \"function\"){ return store.transact(key, data, overwrite); }// fn=data, alt=overwrite\n                if (data !== undefined){ return store.set(key, data, overwrite); }\n                if (typeof key === \"string\" || typeof key === \"number\"){ return store.get(key); }\n                if (typeof key === \"function\"){ return store.each(key); }\n                if (!key){ return store.clear(); }\n                return store.setAll(key, data);// overwrite=data, data=key\n            });\n            store._id = id;\n            try {\n                var testKey = '__store2_test';\n                area.setItem(testKey, 'ok');\n                store._area = area;\n                area.removeItem(testKey);\n            } catch (e) {\n                store._area = _.storage('fake');\n            }\n            store._ns = namespace || '';\n            if (!_.areas[id]) {\n                _.areas[id] = store._area;\n            }\n            if (!_.apis[store._ns+store._id]) {\n                _.apis[store._ns+store._id] = store;\n            }\n            return store;\n        },\n        storeAPI: {\n            // admin functions\n            area: function(id, area) {\n                var store = this[id];\n                if (!store || !store.area) {\n                    store = _.Store(id, area, this._ns);//new area-specific api in this namespace\n                    if (!this[id]){ this[id] = store; }\n                }\n                return store;\n            },\n            namespace: function(namespace, singleArea) {\n                if (!namespace){\n                    return this._ns ? this._ns.substring(0,this._ns.length-1) : '';\n                }\n                var ns = namespace, store = this[ns];\n                if (!store || !store.namespace) {\n                    store = _.Store(this._id, this._area, this._ns+ns+'.');//new namespaced api\n                    if (!this[ns]){ this[ns] = store; }\n                    if (!singleArea) {\n                        for (var name in _.areas) {\n                            store.area(name, _.areas[name]);\n                        }\n                    }\n                }\n                return store;\n            },\n            isFake: function(){ return this._area.name === 'fake'; },\n            toString: function() {\n                return 'store'+(this._ns?'.'+this.namespace():'')+'['+this._id+']';\n            },\n\n            // storage functions\n            has: function(key) {\n                if (this._area.has) {\n                    return this._area.has(this._in(key));//extension hook\n                }\n                return !!(this._in(key) in this._area);\n            },\n            size: function(){ return this.keys().length; },\n            each: function(fn, fill) {// fill is used by keys(fillList) and getAll(fillList))\n                for (var i=0, m=_.length(this._area); i<m; i++) {\n                    var key = this._out(_.key(this._area, i));\n                    if (key !== undefined) {\n                        if (fn.call(this, key, this.get(key), fill) === false) {\n                            break;\n                        }\n                    }\n                    if (m > _.length(this._area)) { m--; i--; }// in case of removeItem\n                }\n                return fill || this;\n            },\n            keys: function(fillList) {\n                return this.each(function(k, v, list){ list.push(k); }, fillList || []);\n            },\n            get: function(key, alt) {\n                var s = _.get(this._area, this._in(key)),\n                    fn;\n                if (typeof alt === \"function\") {\n                    fn = alt;\n                    alt = null;\n                }\n                return s !== null ? _.parse(s, fn) :\n                    alt != null ? alt : s;\n            },\n            getAll: function(fillObj) {\n                return this.each(function(k, v, all){ all[k] = v; }, fillObj || {});\n            },\n            transact: function(key, fn, alt) {\n                var val = this.get(key, alt),\n                    ret = fn(val);\n                this.set(key, ret === undefined ? val : ret);\n                return this;\n            },\n            set: function(key, data, overwrite) {\n                var d = this.get(key);\n                if (d != null && overwrite === false) {\n                    return data;\n                }\n                return _.set(this._area, this._in(key), _.stringify(data), overwrite) || d;\n            },\n            setAll: function(data, overwrite) {\n                var changed, val;\n                for (var key in data) {\n                    val = data[key];\n                    if (this.set(key, val, overwrite) !== val) {\n                        changed = true;\n                    }\n                }\n                return changed;\n            },\n            add: function(key, data) {\n                var d = this.get(key);\n                if (d instanceof Array) {\n                    data = d.concat(data);\n                } else if (d !== null) {\n                    var type = typeof d;\n                    if (type === typeof data && type === 'object') {\n                        for (var k in data) {\n                            d[k] = data[k];\n                        }\n                        data = d;\n                    } else {\n                        data = d + data;\n                    }\n                }\n                _.set(this._area, this._in(key), _.stringify(data));\n                return data;\n            },\n            remove: function(key, alt) {\n                var d = this.get(key, alt);\n                _.remove(this._area, this._in(key));\n                return d;\n            },\n            clear: function() {\n                if (!this._ns) {\n                    _.clear(this._area);\n                } else {\n                    this.each(function(k){ _.remove(this._area, this._in(k)); }, 1);\n                }\n                return this;\n            },\n            clearAll: function() {\n                var area = this._area;\n                for (var id in _.areas) {\n                    if (_.areas.hasOwnProperty(id)) {\n                        this._area = _.areas[id];\n                        this.clear();\n                    }\n                }\n                this._area = area;\n                return this;\n            },\n\n            // internal use functions\n            _in: function(k) {\n                if (typeof k !== \"string\"){ k = _.stringify(k); }\n                return this._ns ? this._ns + k : k;\n            },\n            _out: function(k) {\n                return this._ns ?\n                    k && k.indexOf(this._ns) === 0 ?\n                        k.substring(this._ns.length) :\n                        undefined : // so each() knows to skip it\n                    k;\n            }\n        },// end _.storeAPI\n        storage: function(name) {\n            return _.inherit(_.storageAPI, { items: {}, name: name });\n        },\n        storageAPI: {\n            length: 0,\n            has: function(k){ return this.items.hasOwnProperty(k); },\n            key: function(i) {\n                var c = 0;\n                for (var k in this.items){\n                    if (this.has(k) && i === c++) {\n                        return k;\n                    }\n                }\n            },\n            setItem: function(k, v) {\n                if (!this.has(k)) {\n                    this.length++;\n                }\n                this.items[k] = v;\n            },\n            removeItem: function(k) {\n                if (this.has(k)) {\n                    delete this.items[k];\n                    this.length--;\n                }\n            },\n            getItem: function(k){ return this.has(k) ? this.items[k] : null; },\n            clear: function(){ for (var k in this.items){ this.removeItem(k); } }\n        }// end _.storageAPI\n    };\n\n    var store =\n        // safely set this up (throws error in IE10/32bit mode for local files)\n        _.Store(\"local\", (function(){try{ return localStorage; }catch(e){}})());\n    store.local = store;// for completeness\n    store._ = _;// for extenders and debuggers...\n    // safely setup store.session (throws exception in FF for file:/// urls)\n    store.area(\"session\", (function(){try{ return sessionStorage; }catch(e){}})());\n    store.area(\"page\", _.storage(\"page\"));\n\n    if (typeof define === 'function' && define.amd !== undefined) {\n        define('store2', [], function () {\n            return store;\n        });\n    } else if (typeof module !== 'undefined' && module.exports) {\n        module.exports = store;\n    } else {\n        // expose the primary store fn to the global object and save conflicts\n        if (window.store){ _.conflict = window.store; }\n        window.store = store;\n    }\n\n})(this, this && this.define);\n","import * as Hero from './hero.js';\n\nconst INIT_OPTIONS = {\n  disableAudioLevels: false,\n\n  // The ID of the jidesha extension for Chrome.\n  desktopSharingChromeExtId: 'mbocklcggfhnbahlnepmldehdhpjfcjp',\n\n  // Whether desktop sharing should be disabled on Chrome.\n  desktopSharingChromeDisabled: false,\n\n  // The media sources to use when using screen sharing with the Chrome\n  // extension.\n  desktopSharingChromeSources: ['screen', 'window'],\n\n  // Required version of Chrome extension\n  desktopSharingChromeMinExtVersion: '0.1',\n\n  // Whether desktop sharing should be disabled on Firefox.\n  desktopSharingFirefoxDisabled: true,\n};\n\nconst initJitsiMeetJs = (\n  function() {\n    JitsiMeetJS.setLogLevel(JitsiMeetJS.logLevels.ERROR);\n    let INITIALIZED = false;\n    return () => {\n      if (INITIALIZED) return;\n      JitsiMeetJS.init(INIT_OPTIONS);\n      INITIALIZED = true;\n    };\n  }\n)();\n\nconst TYPE_PLAYER_PROPERTY = 'eid-player-property';\n\n/**\n * A class to handle Jitsi connection of a room.\n */\nexport class JitsiConnection {\n  constructor() {\n    this.connection = null;\n    this.room = null;\n    this._lastSetLocalProperty = 0;\n    this._lastBroadcastLocalProperty = 0;\n    this._sentLocalProperty = {};\n    this._displayName = '???';\n  }\n\n  init() {\n    initJitsiMeetJs();\n\n    if (this.conenction) {\n      // TODO(stimim): check if connection is still alive.\n      return;\n    }\n\n    const options = {\n      hosts: {\n        domain: 'jitsi.jothon.online',\n        muc: 'conference.jitsi.jothon.online',\n        focus: 'focus.jitsi.jothon.online',\n      },\n      externalConnectUrl: 'https://jitsi.jothon.online/http-pre-bind',\n      bosh: 'https://jitsi.jothon.online/http-bind?room=eid',\n      websocket: 'wss://jitsi.jothon.online/xmpp-websocket',\n\n      // The name of client node advertised in XEP-0115 'c' stanza\n      clientNode: 'http://jitsi.org/jitsimeet',\n    };\n\n    this.connection = new JitsiMeetJS.JitsiConnection(null, null, options);\n\n    // TODO(stimim): why???\n    const onDisconnected = () => {\n      this.connection.removeEventListener(\n        JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED,\n        () => this.onConnectionSuccess());\n      this.connection.removeEventListener(\n        JitsiMeetJS.events.connection.CONNECTION_FAILED,\n        () => this.onConnectionFailed());\n      this.connection.removeEventListener(\n        JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED,\n        onDisconnected);\n    };\n\n    this.connection.addEventListener(\n      JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED,\n      () => this.onConnectionSuccess());\n    this.connection.addEventListener(\n      JitsiMeetJS.events.connection.CONNECTION_FAILED,\n      () => this.onConnectionFailed());\n    this.connection.addEventListener(\n        JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED,\n        onDisconnected);\n\n    this.connection.connect();\n  }\n\n  disconnect() {\n    if (this.connection) {\n      this.connection.disconnect();\n      this.connection = null;\n    }\n  }\n\n  onConnectionSuccess() {\n    this._initConferenceRoom();\n  }\n\n  onConnectionFailed() {\n    console.log('Failed to connect to Jitsi...')\n  }\n\n  _initConferenceRoom() {\n    // const roomId = 'idystopia_online';\n    const roomId = 'eid';\n    console.log('roomId: ', roomId);\n    if (this.room) {\n      return this.room;\n    }\n    const confOptions = {\n      openBridgeChannel: 'websocket',\n      confID: `jitsi.jothon.online/${roomId}`,\n    };\n\n    this.room = this.connection.initJitsiConference(roomId, confOptions);\n\n    this.room.setDisplayName(this._displayName);\n    this.room.on(\n      JitsiMeetJS.events.conference.CONFERENCE_JOINED,\n      () => { this.onConferenceJoined(); });\n\n    this.room.join();\n\n    return this.room;\n  }\n\n  setLocalParticipantProperty(properties) {\n    const now = (new Date()).getTime();\n    const minDelta = 60 * 1000;  // milliseconds\n    if (now - this._lastSetLocalProperty <= minDelta) {\n      return;\n    }\n    console.info('call setLocalParticipantProperty', properties);\n    this._lastSetLocalProperty = now;\n    if (this.room) {\n      for (const key in properties) {\n        if ((key in this._sentLocalProperty) &&\n            this._sentLocalProperty[key] === properties[key]) {\n          continue;\n        }\n        this.room.setLocalParticipantProperty(key, properties[key]);\n        this._sentLocalProperty[key] = properties[key];\n      }\n    }\n  }\n\n  setDisplayName(name) {\n    this._displayName = name;\n    if (this.room) {\n      this.room.setDisplayName(name);\n    }\n  }\n\n  /**\n   * One connection can only join one room at a time.\n   * Keeping the lifecycle of connection and room the same should be easier.\n   */\n  disconnect() {\n    if (this.room) {\n      this.room.leave();\n      this.room = null;\n    }\n    if (this.connection) {\n      this.connection.disconnect();\n      this.connection = null;\n    }\n  }\n\n  loadParticipants() {\n    if (!this.room || !this.connection) return;\n\n    const participants = this.room.participants;\n\n    for (const id in participants) {\n      const user = participants[id];\n\n      console.log('load user: ', id, user);\n\n      const char = Hero.charDaemon.getChar(id);\n      if (char) {\n        console.log(`user ${id} already created, skip`);\n        continue;\n      }\n\n      Hero.charDaemon.createRemotePlayer(\n        id,\n        user.getDisplayName(),\n        Number(user.getProperty('left')),\n        Number(user.getProperty('top')),\n        user.getProperty('texture'),\n        user.getProperty('frame'),\n      );\n    }\n\n    for (const id in Hero.charDaemon.chars) {\n      const char = Hero.charDaemon.chars[id];\n      if (char instanceof Hero.RemotePlayer) {\n        if (!(id in participants)) {\n          delete Hero.charDaemon.chars[id];\n        }\n      }\n    }\n  }\n\n  onConferenceJoined() {\n    //gameCore.registerOnMemberListChanged(renderMemberList);\n\n    this.loadParticipants();\n\n    this.room.on(\n      JitsiMeetJS.events.conference.USER_JOINED,\n      (id, user) => {\n        // Normally, at this point, we won't be able to get properties.\n        // We will get property update very soon in the\n        // \"PARTICIPANT_PROPERTY_CHANGED\" event later.\n        console.log(`user joined`, user);\n        Hero.charDaemon.createRemotePlayer(\n          id,\n          user.getDisplayName(),\n          0, 0,\n          user.getProperty('texture'),\n          user.getProperty('frame')\n        );\n      });\n\n    this.room.on(\n      JitsiMeetJS.events.conference.MESSAGE_RECEIVED,\n      (id, text, timestamp) => {\n        console.log('message received: ', {id, text, timestamp});\n        if (timestamp === undefined) {\n          timestamp = (new Date()).getTime();\n        } else if (typeof(timestamp) === 'string' ||\n                   timestamp instanceof String) {\n          timestamp = (new Date(timestamp)).getTime();\n        }\n        let char;\n        if (id === this.room.myUserId()) {\n          char = Hero.charDaemon.getChar('player');\n        } else {\n          char = Hero.charDaemon.getChar(id);\n        }\n        if (char) char.addMessage(text, timestamp + 60 * 1000);\n      });\n\n    this.room.on(\n      JitsiMeetJS.events.conference.USER_LEFT,\n      (id, /* user */) => {\n        Hero.charDaemon.deleteChar(id);\n      });\n\n    this.room.on(\n      JitsiMeetJS.events.conference.PARTICIPANT_PROPERTY_CHANGED,\n      (user, key) => {\n        const id = user.getId();\n        const char = Hero.charDaemon.getChar(id);\n        if (!char) {\n          return;\n        }\n        if (!this.room || !this.connection) return;\n        const x = parseInt(user.getProperty('left'));\n        const y = parseInt(user.getProperty('top'));\n        if (!Number.isNaN(x) && !Number.isNaN(y)) {\n          char.setProperty('x', x);\n          char.setProperty('y', y);\n        }\n\n        const texture = user.getProperty('texture');\n        const frame = user.getProperty('frame');\n        if (texture && frame &&\n            (frame !== char.frame || texture !== char.texture)) {\n          char.setProperty('texture', texture);\n          char.setProperty('frame', frame);\n        }\n      });\n\n    this.room.on(\n      JitsiMeetJS.events.conference.ENDPOINT_MESSAGE_RECEIVED,\n      (participant, payload) => {\n        if (payload.type === TYPE_PLAYER_PROPERTY) {\n          const property = payload.property;\n          const id = participant.getId();\n          const char = Hero.charDaemon.getChar(id);\n          if (!char) return;\n\n          const x = Number(property.left);\n          const y = Number(property.top);\n          if (Number.isNaN(x) === false && Number.isNaN(y) === false) {\n            const t = (new Date()).getTime() + 100;\n            const timestamp = Number(property.timestamp) || t;\n            char.setProperty('position', {x, y, t, timestamp});\n          }\n\n          char.setProperty(\n            'texture', {texture: property.texture, frame: property.frame});\n          //if (property.texture) char.texture = property.texture;\n          //if (property.frame) char.frame = property.frame;\n        }\n      });\n\n    this.room.on(\n      JitsiMeetJS.events.conference.DISPLAY_NAME_CHANGED,\n      (id, name) => {\n        const char = Hero.charDaemon.getChar(id);\n        if (!char) return;\n        char.setProperty('name', name);\n      });\n  }\n\n  sendMessage(message) {\n    this.room.sendTextMessage(message);\n  }\n\n  broadcastLocalProperty(property) {\n    if (!this.room) return;\n\n    const now = (new Date()).getTime();\n    const minDelta = 100;  // ms\n    if (now - this._lastBroadcastLocalProperty <= minDelta) return;\n    this._lastBroadcastLocalProperty = now;\n    try {\n      this.room.broadcastEndpointMessage(\n        {type: TYPE_PLAYER_PROPERTY, property: { timestamp: now, ...property }});\n    } catch (error) {\n      // I don't care...\n      // console.error('failed to broadcast new property', error);\n    }\n  }\n\n  update(time, delta, char) {\n    // this.setLocalParticipantProperty({\n    //   left: char.player.x,\n    //   top: char.player.y,\n    //   texture: char.player.texture.key,\n    //   frame: char.player.frame.name,\n    // });\n    this.broadcastLocalProperty({\n        left: char.player.x,\n        top: char.player.y,\n        texture: char.player.texture.key,\n        frame: char.player.frame.name,\n    });\n  }\n}\n","import * as PhaserWrapper from './phaser_wrapper.js';\nimport * as JitsiChannel from './jitsi_channel.js';\nimport * as DataStore from './data_store.js';\n\nexport const connection = new JitsiChannel.JitsiConnection();\nwindow.connection = connection;  // for debugging\n\nfunction initJitsi() {\n  console.log('initJitsi');\n  connection.init();\n}\n\nconst game = PhaserWrapper.CreateGame({\n  tilemapTiledJSON: 'maps/idystopia.json',\n  storylineJSON: 'online_event.json',\n  connection,\n  postBootCallback: initJitsi,\n});\n\nDataStore.AnswerStore.listen('player_name', () => {\n  connection.setDisplayName(DataStore.AnswerStore.get('player_name'));\n});\n\n$( '#control-panel' ).draggable({\n  create: function() {\n    // Because \"draggable\" only changes \"top\" and \"left\" when widget is dragged.\n    // We have to make sure \"bottom\" and \"right\" are set to \"auto\", so the size\n    // of widget won't change when widget is dragged.\n    $(this).css({\n      top: $(this).position().top,\n      left: $(this).position().left,\n      bottom: \"auto\",\n      right: \"auto\",\n    });\n  }\n});\n\n$( '#button-sound' ).click(() => {\n  const soundButton = $('#button-sound');\n  let newMute = !game.sound.mute;\n  game.sound.setMute(newMute);\n  // Move focus to other place, so next ENTER won't toggle mute state again.\n  soundButton.blur();\n\n  if (newMute) {\n    soundButton.text('🔇');\n  } else {\n    soundButton.text('🔊');\n  }\n});\n$( '#emoji-send' ).click(() => {\n  const select = document.getElementById('emoji-select');\n  connection.sendMessage(select.value);\n});\n"],"sourceRoot":""}